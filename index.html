<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PLT-ttb Training - Account Planning System</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- html2canvas + jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary-color: #007AFF;
      --primary-dark: #0056CC;
      --secondary-color: #5856D6;
      --success-color: #34C759;
      --warning-color: #FF9500;
      --error-color: #FF3B30;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.18);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --text-white: #FFFFFF;
      --border-radius: 12px;
      --border-radius-lg: 20px;
      --spacing-xs: 0.5rem;
      --spacing-sm: 1rem;
      --spacing-md: 1.5rem;
      --spacing-lg: 2rem;
      --spacing-xl: 3rem;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* ---------- Loading Screen ---------- */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-gradient);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .loading-logo {
      font-size: 3rem;
      color: white;
      margin-bottom: var(--spacing-md);
      animation: pulse 2s infinite;
    }

    .loading-text {
      color: white;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: var(--spacing-lg);
    }

    .loading-spinner-large {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-bottom: var(--spacing-lg);
    }

    .loading-progress {
      width: 300px;
      height: 6px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: var(--spacing-md);
    }

    .loading-progress-bar {
      height: 100%;
      background: white;
      width: 0%;
      transition: width 0.3s ease;
    }

    .enter-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.5);
      padding: 0.75rem 2rem;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .enter-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ---------- Main App ---------- */
    .app-container {
      min-height: 100vh;
      display: none;
      flex-direction: column;
      padding: 1.25rem;
    }

    .glass-container {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      flex: 1;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    /* ---------- Compact Navigation ---------- */
    .compact-nav {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-md);
    }

    .nav-brand {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .nav-menu {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .nav-btn {
      background: white;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
      font-weight: 500;
      text-decoration: none;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.85rem;
      position: relative;
    }

    .nav-btn:hover {
      transform: translateY(-1px);
      border-color: var(--primary-color);
      box-shadow: 0 2px 6px rgba(0, 122, 255, 0.15);
    }

    .nav-btn.active {
      background: var(--primary-color);
      color: white;
    }

    .nav-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 122, 255, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: var(--text-white);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.8rem;
    }

    /* ---------- Page Header ---------- */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .page-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .page-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* ---------- Content Panels ---------- */
    .content-panel {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .content-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      margin-bottom: 1rem;
      border: none;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .card-body {
      padding: var(--spacing-md);
    }

    .small-muted {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .required::after {
      content: " *";
      color: var(--error-color);
    }

    .table-fixed {
      max-height: 240px;
      overflow: auto;
      display: block;
    }

    .watermark {
      position: fixed;
      right: 10px;
      bottom: 10px;
      opacity: 0.12;
      font-weight: 700;
      font-size: 12px;
      color: var(--text-primary);
    }

    .form-container {
      max-width: 100%;
      margin: 0 auto;
    }

    .form-section {
      background: white;
      border-radius: var(--border-radius);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .form-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: var(--spacing-sm);
      color: var(--text-primary);
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: var(--spacing-xs);
    }

    .form-group {
      margin-bottom: var(--spacing-sm);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-sm);
    }

    .form-label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.6rem;
      border: 2px solid #E5E5EA;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: white;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .input-with-button {
      display: flex;
      gap: var(--spacing-sm);
    }

    .input-with-button .form-input {
      flex: 1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }

    .stat-card {
      background: white;
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--error-color);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: var(--spacing-md);
    }

    .modal-content {
      background: white;
      border-radius: var(--border-radius);
      padding: var(--spacing-md);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #E5E5EA;
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .form-subsection {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid var(--primary-color);
    }
    
    .subsection-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: #333;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .financial-products {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .product-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem;
      background: white;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    
    .product-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 130px;
    }
    
    .product-inputs {
      display: flex;
      gap: 0.75rem;
      flex: 1;
    }
    
    .add-button {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
    }
    
    .remove-button {
      background: var(--error-color);
      color: white;
      border: none;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
    }
    
    .unknown-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
      font-size: 0.8rem;
      color: #666;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .chart-container {
      background: white;
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .chart-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      text-align: center;
    }

    .filter-section {
      background: white;
      padding: var(--spacing-sm);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: var(--spacing-md);
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
      align-items: end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .filter-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .setting-card {
      background: white;
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .setting-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .setting-description {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: var(--spacing-sm);
    }

    .danger-zone {
      border-left: 4px solid var(--error-color);
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .compact-nav {
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.5rem;
      }
      
      .nav-menu {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .filter-section {
        flex-direction: column;
        align-items: stretch;
      }
      
      .page-header {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }
      
      .page-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .settings-grid {
        grid-template-columns: 1fr;
      }
    }

    .start-container {
      text-align: center;
      padding: 3rem 1rem;
    }

    .start-logo {
      font-size: 3.5rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
    }

    .start-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .start-subtitle {
      font-size: 1.2rem;
      color: var(--text-secondary);
      margin-bottom: 2rem;
    }

    .start-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 1rem 3rem;
      border-radius: 50px;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
    }

    .start-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
    }

    .customer-id-display {
      background: var(--primary-color);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      display: inline-block;
    }

    .comment-section {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e0e0e0;
    }

    .comment-item {
      background: #f8f9fa;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }

    .comment-meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .admin-tabs {
      margin-top: 1rem;
    }

    .admin-tab-content {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">
      <i class="fas fa-chart-line"></i>
    </div>
    <div class="loading-text">PLT-ttb Training</div>
    <div class="loading-text">Account Planning System</div>
    <div class="loading-spinner-large"></div>
    <div class="loading-progress">
      <div class="loading-progress-bar" id="loadingProgress"></div>
    </div>
    <button class="enter-btn" id="enterBtn" style="display: none;">เข้าใช้งานระบบ</button>
  </div>

  <!-- Main Application -->
  <div class="app-container" id="appContainer">
    <div class="glass-container">
      <!-- Compact Navigation -->
      <nav class="compact-nav">
        <div class="nav-brand">
          <i class="fas fa-chart-line"></i>
          PLT-ttb Training
        </div>
        <div class="nav-menu">
          <button class="nav-btn" id="tab-start" data-panel="start">
            <i class="fas fa-home"></i> หน้าแรก
          </button>
          <button class="nav-btn" id="tab-form" data-panel="form">
            <i class="fas fa-user-plus"></i> สร้างลูกค้า
          </button>
          <button class="nav-btn" id="tab-list" data-panel="list">
            <i class="fas fa-list"></i> รายการลูกค้า
          </button>
          <button class="nav-btn" id="tab-report" data-panel="report">
            <i class="fas fa-chart-bar"></i> รายงาน
          </button>
          <button class="nav-btn" id="tab-admin" data-panel="admin">
            <i class="fas fa-cog"></i> Admin
          </button>
        </div>
        <div class="nav-actions">
          <button class="btn btn-sm btn-secondary" id="btn-logout">
            <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
          </button>
        </div>
      </nav>

      <!-- Content Area -->
      <div id="content-area">
        
        <!-- START PANEL -->
        <div id="panel-start" class="content-panel active">
          <div class="start-container">
            <div class="start-logo">
              <i class="fas fa-chart-line"></i>
            </div>
            <h1 class="start-title">PLT-ttb Training</h1>
            <p class="start-subtitle">ระบบวางแผนการขายและบริหารลูกค้า</p>
            <button class="start-btn" id="btn-start">
              <i class="fas fa-play-circle"></i> เริ่มต้นใช้งาน
            </button>
          </div>
        </div>

        <!-- FORM PANEL -->
        <div id="panel-form" class="content-panel">
          <div class="page-header">
            <div class="page-title">
              <i class="fas fa-user-plus"></i> ฟอร์มกรอกข้อมูลลูกค้า
            </div>
            <div class="page-actions">
              <button class="btn btn-sm btn-secondary" id="btn-back-form">
                <i class="fas fa-arrow-left"></i> ย้อนกลับ
              </button>
              <button class="btn btn-sm btn-primary" id="btn-home-form">
                <i class="fas fa-home"></i> หน้าแรก
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div class="customer-id-display" id="customerIdDisplay">Customer ID: กำลังสร้าง...</div>
              <p class="small-muted mb-3">กรอกข้อมูลให้ครบ — ระบบจะสร้าง Customer ID อัตโนมัติ</p>

              <form id="customerForm" class="row g-3">
                <!-- Employee Information -->
                <div class="form-subsection">
                  <div class="subsection-title">
                    <i class="fas fa-user-tie"></i> ข้อมูลพนักงาน
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label required">ชื่อพนักงาน</label>
                      <input type="text" id="employee_name" class="form-control" placeholder="ชื่อผู้กรอก (เช่น Somchai)">
                    </div>
                    <div class="form-group">
                      <label class="form-label required">รหัสพนักงาน</label>
                      <input type="text" id="employee_id" class="form-control" placeholder="BR1234">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label required">Branch</label>
                      <input type="text" id="branch" class="form-control" placeholder="Bangkok Central">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Zone</label>
                      <input type="text" id="zone" class="form-control" placeholder="Zone A">
                    </div>
                    <div class="form-group">
                      <label class="form-label required">RH (RH1-RH5)</label>
                      <select id="rh" class="form-select">
                        <option value="">เลือก RH</option>
                        <option>RH1</option>
                        <option>RH2</option>
                        <option>RH3</option>
                        <option>RH4</option>
                        <option>RH5</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Customer Personal Information -->
                <div class="form-subsection">
                  <div class="subsection-title">
                    <i class="fas fa-user"></i> ข้อมูลส่วนตัวลูกค้า
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label required">ชื่อนามสมมุติ</label>
                      <input type="text" id="cust_name" class="form-control" placeholder="ชื่อนามสมมุติ">
                    </div>
                    <div class="form-group">
                      <label class="form-label required">อายุ</label>
                      <input type="number" id="cust_age" class="form-control" placeholder="อายุ">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label required">เพศ</label>
                      <select id="cust_gender" class="form-select">
                        <option value="">เลือกเพศ</option>
                        <option>ชาย</option>
                        <option>หญิง</option>
                        <option>อื่นๆ</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label required">อาชีพ</label>
                      <select id="cust_occupation" class="form-select">
                        <option value="">เลือกอาชีพ</option>
                        <option>พนักงานบริษัท</option>
                        <option>ข้าราชการ</option>
                        <option>เจ้าของกิจการ/ธุรกิจส่วนตัว</option>
                        <option>แพทย์</option>
                        <option>วิศวกร</option>
                        <option>ครู</option>
                        <option>นักกฎหมาย</option>
                        <option>อื่นๆ</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label required">รายได้ต่อเดือน (บาท)</label>
                      <input type="number" id="cust_monthly_income" class="form-control" placeholder="รายได้ต่อเดือน">
                    </div>
                    <div class="form-group">
                      <label class="form-label">รายได้ต่อปี (บาท)</label>
                      <input type="text" id="cust_yearly_income" class="form-control" placeholder="ระบบคำนวณอัตโนมัติ" readonly>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">มีสวัสดิการหรือไม่</label>
                      <select id="cust_welfare" class="form-select">
                        <option value="">เลือก</option>
                        <option>ไม่มี</option>
                        <option>มี - วงเงินสูง</option>
                        <option>มี - วงเงินกลาง</option>
                        <option>มี - วงเงินต่ำ</option>
                        <option>มี - ทุนประกันต่อปี</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">ทุนประกันต่อปี (บาท)</label>
                      <input type="number" id="cust_insurance_capital" class="form-control" placeholder="ทุนประกันต่อปี">
                    </div>
                  </div>
                </div>

                <!-- Family Information -->
                <div class="form-subsection">
                  <div class="subsection-title">
                    <i class="fas fa-users"></i> ข้อมูลครอบครัว
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">สถานภาพ</label>
                      <select id="cust_marital_status" class="form-select">
                        <option value="">เลือกสถานภาพ</option>
                        <option>โสด</option>
                        <option>สมรส</option>
                        <option>หม้าย</option>
                        <option>หย่า</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">อายุคู่สมรส</label>
                      <input type="number" id="cust_spouse_age" class="form-control" placeholder="อายุคู่สมรส">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">อาชีพคู่สมรส</label>
                      <select id="cust_spouse_occupation" class="form-select">
                        <option value="">เลือกอาชีพ</option>
                        <option>ไม่มี</option>
                        <option>พนักงานบริษัท</option>
                        <option>ข้าราชการ</option>
                        <option>เจ้าของกิจการ/ธุรกิจส่วนตัว</option>
                        <option>แพทย์</option>
                        <option>วิศวกร</option>
                        <option>ครู</option>
                        <option>แม่บ้าน</option>
                        <option>อื่นๆ</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label">มีบุตรหรือไม่</label>
                      <select id="cust_has_children" class="form-select">
                        <option value="">เลือก</option>
                        <option>ไม่มี</option>
                        <option>มี</option>
                      </select>
                    </div>
                  </div>
                  <div id="children-section" style="display: none;">
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">จำนวนบุตร</label>
                        <input type="number" id="cust_children_count" class="form-control" placeholder="จำนวนบุตร">
                      </div>
                      <div class="form-group">
                        <label class="form-label">อายุบุตร</label>
                        <input type="text" id="cust_children_ages" class="form-control" placeholder="อายุบุตร (คั่นด้วย ,)">
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="form-label">อาชีพบุตร</label>
                      <select id="cust_children_occupation" class="form-select">
                        <option value="">เลือกอาชีพ</option>
                        <option>นักเรียน</option>
                        <option>นักศึกษา</option>
                        <option>พนักงานบริษัท</option>
                        <option>อื่นๆ</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">มีบุคคลอื่นที่ต้องดูแลหรือไม่</label>
                    <select id="cust_has_dependents" class="form-select">
                      <option value="">เลือก</option>
                      <option>ไม่มี</option>
                      <option>มี</option>
                    </select>
                  </div>
                  <div id="dependents-section" style="display: none;">
                    <div class="form-group">
                      <label class="form-label">รายละเอียดบุคคลที่ต้องดูแล</label>
                      <textarea id="cust_dependents_details" class="form-control" placeholder="ระบุรายละเอียดบุคคลที่ต้องดูแล"></textarea>
                    </div>
                  </div>
                </div>

                <!-- Business Information (only for business owners) -->
                <div class="form-subsection" id="business-section" style="display: none;">
                  <div class="subsection-title">
                    <i class="fas fa-briefcase"></i> ข้อมูลธุรกิจ
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">ประเภทธุรกิจ/กิจการ</label>
                      <input type="text" id="cust_business_type" class="form-control" placeholder="ประเภทธุรกิจ">
                    </div>
                    <div class="form-group">
                      <label class="form-label">ทุนจดทะเบียน (บาท)</label>
                      <input type="number" id="cust_business_capital" class="form-control" placeholder="ทุนจดทะเบียน">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">รายได้ต่อปี (บาท)</label>
                      <input type="number" id="cust_business_income" class="form-control" placeholder="รายได้ต่อปี">
                    </div>
                    <div class="form-group">
                      <label class="form-label">กำไร (บาท)</label>
                      <input type="number" id="cust_business_profit" class="form-control" placeholder="กำไร">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">ภาษีที่เสียปีล่าสุด (บาท)</label>
                      <input type="number" id="cust_business_tax" class="form-control" placeholder="ภาษีที่เสียปีล่าสุด">
                    </div>
                    <div class="form-group">
                      <label class="form-label">สัดส่วนหุ้นที่ถือครอง (%)</label>
                      <input type="number" id="cust_business_share" class="form-control" placeholder="สัดส่วนหุ้นที่ถือครอง" min="0" max="100">
                    </div>
                  </div>
                </div>

                <!-- Financial Products -->
                <div class="form-subsection">
                  <div class="subsection-title">
                    <i class="fas fa-piggy-bank"></i> ผลิตภัณฑ์ทางการเงินที่ถือครอง
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">เงินฝากออมทรัพย์ (บาท)</label>
                      <input type="number" id="prod_savings" class="form-control" placeholder="จำนวนเงิน">
                    </div>
                    <div class="form-group">
                      <label class="form-label">เงินฝากประจำ (บาท)</label>
                      <input type="number" id="prod_fixed" class="form-control" placeholder="จำนวนเงิน">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">กองทุน (บาท)</label>
                      <input type="number" id="prod_fund" class="form-control" placeholder="จำนวนเงิน">
                    </div>
                    <div class="form-group">
                      <label class="form-label">บัตรเครดิต (บาท)</label>
                      <input type="number" id="prod_credit_card" class="form-control" placeholder="จำนวนเงิน">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">เงินกู้บ้าน (บาท)</label>
                      <input type="number" id="prod_home_loan" class="form-control" placeholder="จำนวนเงิน">
                    </div>
                    <div class="form-group">
                      <label class="form-label">เงินกู้รถ (บาท)</label>
                      <input type="number" id="prod_car_loan" class="form-control" placeholder="จำนวนเงิน">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">เงินกู้ส่วนบุคคล (บาท)</label>
                      <input type="number" id="prod_personal_loan" class="form-control" placeholder="จำนวนเงิน">
                    </div>
                  </div>
                </div>

                <!-- Insurance Policies -->
                <div class="form-subsection">
                  <div class="subsection-title">
                    <i class="fas fa-shield-alt"></i> กรมธรรม์ประกันที่ถือครอง
                  </div>
                  <div id="insurance-policies">
                    <!-- Dynamic insurance policies will be added here -->
                  </div>
                  <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddInsurance">
                    <i class="fas fa-plus"></i> เพิ่มกรมธรรม์
                  </button>
                </div>

                <!-- Employee Comments -->
                <div class="form-subsection">
                  <div class="subsection-title">
                    <i class="fas fa-comments"></i> ความเห็นพนักงาน
                  </div>
                  <div class="form-group">
                    <label class="form-label">เคยนำเสนอผลิตภัณฑ์แล้วหรือไม่</label>
                    <select id="emp_presented_before" class="form-select">
                      <option value="">เลือก</option>
                      <option>ยังไม่เคยนำเสนอ</option>
                      <option>เคยนำเสนอแล้ว</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">ลูกค้าเคยโต้แย้งหรือมีความคิดเห็นอย่างไร</label>
                    <textarea id="emp_customer_feedback" class="form-control" placeholder="ความคิดเห็นหรือการโต้แย้งของลูกค้า"></textarea>
                  </div>
                  <div class="form-group">
                    <label class="form-label">รอบนี้คาดหวังนำเสนอผลิตภัณฑ์ใด</label>
                    <input type="text" id="emp_proposed_product" class="form-control" placeholder="ผลิตภัณฑ์ที่คาดหวังจะนำเสนอ">
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">เบี้ยประกันที่คาดหวัง (บาท)</label>
                      <input type="number" id="emp_proposed_premium" class="form-control" placeholder="เบี้ยประกัน">
                    </div>
                    <div class="form-group">
                      <label class="form-label">ทุนประกันที่คาดหวัง (บาท)</label>
                      <input type="number" id="emp_proposed_capital" class="form-control" placeholder="ทุนประกัน">
                    </div>
                  </div>
                </div>

                <!-- Buttons -->
                <div class="col-12 d-flex gap-2">
                  <button type="button" id="btnSave" class="btn btn-primary">
                    <i class="fas fa-save"></i> บันทึกข้อมูล
                  </button>
                  <button type="button" id="btnClear" class="btn btn-secondary">
                    <i class="fas fa-broom"></i> ล้างฟอร์ม
                  </button>
                  <div class="ms-auto small-muted align-self-center" id="formStatus"></div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- LIST / SEARCH PANEL -->
        <div id="panel-list" class="content-panel">
          <div class="page-header">
            <div class="page-title">
              <i class="fas fa-list"></i> รายการลูกค้า / ค้นหา
            </div>
            <div class="page-actions">
              <button class="btn btn-sm btn-secondary" id="btn-back-list">
                <i class="fas fa-arrow-left"></i> ย้อนกลับ
              </button>
              <button class="btn btn-sm btn-primary" id="btn-home-list">
                <i class="fas fa-home"></i> หน้าแรก
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div class="filter-section">
                <div class="filter-group">
                  <div class="filter-label">ค้นหาลูกค้า</div>
                  <input type="text" id="search_customer" class="form-control" placeholder="Search Customer ID หรือชื่อ">
                </div>
                <div class="filter-group">
                  <div class="filter-label">ค้นหาตามพนักงาน</div>
                  <input type="text" id="search_by_creator" class="form-control" placeholder="Search by Employee ID">
                </div>
                <div class="filter-group">
                  <div class="filter-label">Filter RH</div>
                  <select id="filter_rh" class="form-select">
                    <option value="">ทั้งหมด</option>
                    <option>RH1</option>
                    <option>RH2</option>
                    <option>RH3</option>
                    <option>RH4</option>
                    <option>RH5</option>
                  </select>
                </div>
                <div class="d-flex gap-2 align-items-end">
                  <button class="btn btn-outline-primary btn-sm" id="btnSearch">
                    <i class="fas fa-search"></i> ค้นหา
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" id="btnRefresh">
                    <i class="fas fa-sync-alt"></i> รีเฟรช
                  </button>
                </div>
              </div>

              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="small-muted" id="searchResultsCount"></div>
                <div>
                  <button class="btn btn-outline-success btn-sm" id="btnBulkExport">
                    <i class="fas fa-file-pdf"></i> Export PDF
                  </button>
                </div>
              </div>

              <div class="table-responsive table-fixed">
                <table class="table table-striped" id="customerTable">
                  <thead class="table-light">
                    <tr>
                      <th><input type="checkbox" id="selectAll"></th>
                      <th>Customer ID</th>
                      <th>Name</th>
                      <th>อายุ</th>
                      <th>อาชีพ</th>
                      <th>Branch</th>
                      <th>RH</th>
                      <th>Created By</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="customerTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- REPORTS PANEL -->
        <div id="panel-report" class="content-panel">
          <div class="page-header">
            <div class="page-title">
              <i class="fas fa-chart-bar"></i> รายงาน / Dashboard
            </div>
            <div class="page-actions">
              <button class="btn btn-sm btn-secondary" id="btn-back-report">
                <i class="fas fa-arrow-left"></i> ย้อนกลับ
              </button>
              <button class="btn btn-sm btn-primary" id="btn-home-report">
                <i class="fas fa-home"></i> หน้าแรก
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div id="reportLocked" class="mb-4">
                <p class="small-muted">กรุณาใส่ Passcode เพื่อเข้าใช้งานเมนูรายงาน</p>
                <div class="d-flex gap-2 align-items-end">
                  <div class="flex-grow-1">
                    <label class="form-label">Passcode</label>
                    <input type="password" id="reportPass" class="form-control" placeholder="Passcode">
                  </div>
                  <button id="btnUnlock" class="btn btn-primary">
                    <i class="fas fa-lock-open"></i> Unlock
                  </button>
                </div>
                <div class="mt-2 small-muted">
                  (default demo passcode: <strong>2568</strong>)
                </div>
              </div>

              <div id="reportPanel" style="display:none;">
                <div class="filter-section">
                  <div class="filter-group">
                    <div class="filter-label">Region</div>
                    <select id="filter_report_region" class="form-select">
                      <option value="all">ทั้งหมด</option>
                      <option>RH1</option>
                      <option>RH2</option>
                      <option>RH3</option>
                      <option>RH4</option>
                      <option>RH5</option>
                    </select>
                  </div>
                  <div class="filter-group">
                    <div class="filter-label">วันที่เริ่ม</div>
                    <input type="date" id="filter_start_date" class="form-control">
                  </div>
                  <div class="filter-group">
                    <div class="filter-label">วันที่สิ้นสุด</div>
                    <input type="date" id="filter_end_date" class="form-control">
                  </div>
                  <button class="btn btn-secondary btn-sm" id="btnApplyFilters">
                    <i class="fas fa-filter"></i> Apply
                  </button>
                </div>

                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-number" id="kpi_total">0</div>
                    <div class="stat-label">Total Cases MTD</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="kpi_opp_count">0</div>
                    <div class="stat-label">New Opportunities MTD</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="kpi_opp_value">0</div>
                    <div class="stat-label">Est. Opportunity Value (MTD)</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="kpi_top_branch">-</div>
                    <div class="stat-label">Top Branch (cases)</div>
                  </div>
                </div>

                <div class="d-flex gap-2 mt-3">
                  <button id="btnExportAll" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-file-pdf"></i> Export All PDF
                  </button>
                  <button id="btnExportCSV" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-file-csv"></i> Export CSV
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="panel-admin" class="content-panel">
          <div class="page-header">
            <div class="page-title">
              <i class="fas fa-cog"></i> Admin / Audit
            </div>
            <div class="page-actions">
              <button class="btn btn-sm btn-secondary" id="btn-back-admin">
                <i class="fas fa-arrow-left"></i> ย้อนกลับ
              </button>
              <button class="btn btn-sm btn-primary" id="btn-home-admin">
                <i class="fas fa-home"></i> หน้าแรก
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div id="adminLocked" class="mb-4">
                <p class="small-muted">กรุณาใส่ Passcode เพื่อเข้าใช้งานเมนู Admin</p>
                <div class="d-flex gap-2 align-items-end">
                  <div class="flex-grow-1">
                    <label class="form-label">Passcode</label>
                    <input type="password" id="adminPass" class="form-control" placeholder="Passcode">
                  </div>
                  <button id="btnUnlockAdmin" class="btn btn-primary">
                    <i class="fas fa-lock-open"></i> Unlock
                  </button>
                </div>
                <div class="mt-2 small-muted">
                  (default demo passcode: <strong>2025</strong>)
                </div>
              </div>

              <div id="adminPanel" style="display:none;">
                <ul class="nav nav-tabs admin-tabs" id="adminTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit-tab-pane" type="button" role="tab" aria-controls="audit-tab-pane" aria-selected="true">Audit Log</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-tab-pane" type="button" role="tab" aria-controls="settings-tab-pane" aria-selected="false">Settings</button>
                  </li>
                </ul>
                <div class="tab-content admin-tab-content" id="adminTabContent">
                  <div class="tab-pane fade show active" id="audit-tab-pane" role="tabpanel" aria-labelledby="audit-tab" tabindex="0">
                    <p class="small-muted mb-3">Audit log (view only) — บันทึกการสร้าง แก้ไข และ export</p>
                    
                    <div class="d-flex gap-2 mb-3">
                      <button class="btn btn-sm btn-outline-primary" id="btnRefreshAudit">
                        <i class="fas fa-sync-alt"></i> Refresh
                      </button>
                      <button class="btn btn-sm btn-outline-secondary" id="btnExportAudit">
                        <i class="fas fa-download"></i> Export Log
                      </button>
                    </div>
                    
                    <div id="auditList" class="small-muted"></div>
                  </div>
                  <div class="tab-pane fade" id="settings-tab-pane" role="tabpanel" aria-labelledby="settings-tab" tabindex="0">
                    <div class="settings-grid">
                      <!-- Security Settings -->
                      <div class="setting-card">
                        <div class="setting-title">
                          <i class="fas fa-shield-alt"></i> การรักษาความปลอดภัย
                        </div>
                        <div class="setting-description">
                          ตั้งค่ารหัสผ่านสำหรับการเข้าถึงฟังก์ชันต่างๆ
                        </div>
                        
                        <div class="form-group">
                          <label class="form-label">รหัสผ่านรายงาน</label>
                          <div class="input-with-button">
                            <input type="password" id="reportPassInput" class="form-control" placeholder="รหัสผ่านรายงาน">
                            <button class="btn btn-outline-primary btn-sm" id="btnChangeReportPass">เปลี่ยน</button>
                          </div>
                          <div class="small-muted mt-1">รหัสผ่านสำหรับเข้าถึงเมนูรายงาน</div>
                        </div>

                        <div class="form-group">
                          <label class="form-label">รหัสผ่าน Admin</label>
                          <div class="input-with-button">
                            <input type="password" id="adminPassInput" class="form-control" placeholder="รหัสผ่าน Admin">
                            <button class="btn btn-outline-primary btn-sm" id="btnChangeAdminPass">เปลี่ยน</button>
                          </div>
                          <div class="small-muted mt-1">รหัสผ่านสำหรับเข้าถึงเมนู Admin</div>
                        </div>
                      </div>

                      <!-- Data Management -->
                      <div class="setting-card">
                        <div class="setting-title">
                          <i class="fas fa-database"></i> การจัดการข้อมูล
                        </div>
                        <div class="setting-description">
                          การสำรองข้อมูลและการจัดการข้อมูลในระบบ
                        </div>
                        
                        <div class="form-group">
                          <button class="btn btn-outline-primary w-100 mb-2" id="btnExportAllData">
                            <i class="fas fa-download"></i> ส่งออกข้อมูลทั้งหมด
                          </button>
                          <div class="small-muted mb-3">ดาวน์โหลดข้อมูลทั้งหมดในรูปแบบ JSON</div>
                          
                          <button class="btn btn-outline-secondary w-100 mb-2" id="btnImportData">
                            <i class="fas fa-upload"></i> นำเข้าข้อมูล
                          </button>
                          <div class="small-muted">นำเข้าข้อมูลจากไฟล์ JSON</div>
                        </div>
                      </div>

                      <!-- System Configuration -->
                      <div class="setting-card">
                        <div class="setting-title">
                          <i class="fas fa-cogs"></i> การตั้งค่าระบบ
                        </div>
                        <div class="setting-description">
                          การกำหนดค่าพื้นฐานของระบบ
                        </div>
                        
                        <div class="form-group">
                          <label class="form-label">จำนวนแถวต่อหน้า</label>
                          <select id="pageSizeSelect" class="form-select">
                            <option value="10">10 แถว</option>
                            <option value="25">25 แถว</option>
                            <option value="50">50 แถว</option>
                            <option value="100">100 แถว</option>
                          </select>
                        </div>
                        
                        <div class="form-group">
                          <label class="form-label">รูปแบบวันที่</label>
                          <select id="dateFormatSelect" class="form-select">
                            <option value="th-TH">ไทย (DD/MM/YYYY)</option>
                            <option value="en-US">อเมริกัน (MM/DD/YYYY)</option>
                            <option value="en-GB">ยุโรป (DD/MM/YYYY)</option>
                          </select>
                        </div>
                        
                        <div class="form-group">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoSaveCheck">
                            <label class="form-check-label">บันทึกอัตโนมัติ</label>
                          </div>
                          <div class="small-muted">บันทึกข้อมูลอัตโนมัติทุก 5 นาที</div>
                        </div>
                      </div>

                      <!-- Danger Zone -->
                      <div class="setting-card danger-zone">
                        <div class="setting-title text-danger">
                          <i class="fas fa-exclamation-triangle"></i> โซนอันตราย
                        </div>
                        <div class="setting-description">
                          การดำเนินการที่ไม่อาจย้อนกลับได้
                        </div>
                        
                        <div class="form-group">
                          <button class="btn btn-outline-danger w-100 mb-2" id="btnClearAllData">
                            <i class="fas fa-eraser"></i> ล้างข้อมูลทั้งหมด
                          </button>
                          <div class="small-muted text-danger mb-3">ลบข้อมูลลูกค้าและประวัติทั้งหมด</div>
                          
                          <button class="btn btn-danger w-100" id="btnResetSystem">
                            <i class="fas fa-trash-alt"></i> รีเซ็ตระบบทั้งหมด
                          </button>
                          <div class="small-muted text-danger">ล้างการตั้งค่าและข้อมูลทั้งหมด</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="watermark">PLT-ttb Training</div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /**************************************************************************
     * Enhanced Account Planning System with Supabase Backend
     * Features: Loading screen, Passcode protection for Reports and Admin
     * Passcodes: Reports (2568), Admin (2025)
     **************************************************************************/

    // ---------- Supabase Configuration ----------
    // เปลี่ยนค่าเหล่านี้เป็นค่าจาก Supabase project ของคุณ
    const SUPABASE_URL = 'https://tzatkemyixpkmxykufse.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6YXRrZW15aXhwa214eWt1ZnNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTM5MjcsImV4cCI6MjA3ODYyOTkyN30.bCWuUcSe1BMSrLHzbBhP_sPOgmrEY1BEAOQ8YfNu5H0';
    
    // สร้าง Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- Constants and Utilities ----------
    const STORAGE_KEY = 'aps_customers';
    const AUDIT_KEY = 'aps_audit';
    const COUNTER_KEY = 'aps_counters';
    const SETTINGS_KEY = 'aps_settings';
    const DEFAULT_REPORT_PASS = '2568';
    const DEFAULT_ADMIN_PASS = '2025';

    // DOM Helper
    const $ = (id) => document.getElementById(id);

    // System State
    let currentPanel = 'start';
    let reportUnlocked = false;
    let adminUnlocked = false;
    let systemSettings = {};
    let currentCustomerId = '';
    let insurancePolicyCount = 0;

    // Date and Time Utilities
    function nowISO() {
      return new Date().toISOString();
    }

    function formatDateISOToLocalShort(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleString('th-TH', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    // ---------- Settings Management ----------
    function loadSettings() {
      try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (raw) {
          return JSON.parse(raw);
        } else {
          // Initialize default settings
          return {
            reportPassword: DEFAULT_REPORT_PASS,
            adminPassword: DEFAULT_ADMIN_PASS,
            pageSize: 10,
            dateFormat: 'th-TH',
            autoSave: true
          };
        }
      } catch(e) { 
        console.error('Error loading settings:', e);
        return {};
      }
    }

    function saveSettings(settings) {
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      systemSettings = settings;
      updateSettingsUI();
    }

    function updateSettingsUI() {
      // Update settings form inputs
      if ($('reportPassInput')) $('reportPassInput').value = systemSettings.reportPassword || '';
      if ($('adminPassInput')) $('adminPassInput').value = systemSettings.adminPassword || '';
      if ($('pageSizeSelect')) $('pageSizeSelect').value = systemSettings.pageSize || '10';
      if ($('dateFormatSelect')) $('dateFormatSelect').value = systemSettings.dateFormat || 'th-TH';
      if ($('autoSaveCheck')) $('autoSaveCheck').checked = systemSettings.autoSave !== false;
    }

    // ---------- Data Management with Supabase ----------
    async function loadData() {
      try {
        const { data, error } = await supabase
          .from('customers')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Supabase error:', error);
          // Fallback to localStorage if Supabase fails
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : [];
        }
        
        return data || [];
      } catch(e) { 
        console.error('Error loading data:', e);
        // Fallback to localStorage
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      }
    }

    async function saveData(arr) { 
      try {
        // Save to Supabase
        const { error } = await supabase
          .from('customers')
          .upsert(arr, { onConflict: 'customer_id' });
        
        if (error) {
          console.error('Supabase error:', error);
          // Fallback to localStorage
          localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
        } else {
          // Also save to localStorage as backup
          localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
        }
      } catch(e) {
        console.error('Error saving data:', e);
        // Fallback to localStorage
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      }
    }

    async function saveCustomerToSupabase(customer) {
      try {
        const { data, error } = await supabase
          .from('customers')
          .insert([customer])
          .select();
        
        if (error) throw error;
        return data;
      } catch(e) {
        console.error('Error saving customer to Supabase:', e);
        throw e;
      }
    }

    async function updateCustomerInSupabase(customerId, updates) {
      try {
        const { data, error } = await supabase
          .from('customers')
          .update(updates)
          .eq('customer_id', customerId)
          .select();
        
        if (error) throw error;
        return data;
      } catch(e) {
        console.error('Error updating customer in Supabase:', e);
        throw e;
      }
    }

    async function deleteCustomerFromSupabase(customerId) {
      try {
        const { error } = await supabase
          .from('customers')
          .delete()
          .eq('customer_id', customerId);
        
        if (error) throw error;
        return true;
      } catch(e) {
        console.error('Error deleting customer from Supabase:', e);
        throw e;
      }
    }

    async function loadAudit() {
      try { 
        const { data, error } = await supabase
          .from('audit_logs')
          .select('*')
          .order('time', { ascending: false });
        
        if (error) {
          console.error('Supabase error:', error);
          // Fallback to localStorage
          return JSON.parse(localStorage.getItem(AUDIT_KEY) || '[]');
        }
        
        return data || [];
      } catch(e) { 
        console.error('Error loading audit:', e);
        return JSON.parse(localStorage.getItem(AUDIT_KEY) || '[]'); 
      }
    }

    async function saveAudit(a) { 
      try {
        // Save to Supabase
        const { error } = await supabase
          .from('audit_logs')
          .insert(a);
        
        if (error) {
          console.error('Supabase error:', error);
          // Fallback to localStorage
          localStorage.setItem(AUDIT_KEY, JSON.stringify(a));
        } else {
          // Also save to localStorage as backup
          localStorage.setItem(AUDIT_KEY, JSON.stringify(a));
        }
      } catch(e) {
        console.error('Error saving audit:', e);
        localStorage.setItem(AUDIT_KEY, JSON.stringify(a));
      }
    }

    async function appendAudit(action, entityId, performedBy, data = null) {
      const auditEntry = {
        action, 
        entity: entityId, 
        performed_by: performedBy, 
        time: nowISO(), 
        data
      };
      
      const a = await loadAudit();
      a.unshift(auditEntry);
      await saveAudit(a);
      renderAuditList();
    }

    // Customer Code Generation
    function genCustomerCode() {
      const counters = JSON.parse(localStorage.getItem(COUNTER_KEY) || '{}');
      const dateKey = new Date().toISOString().slice(0,10).replace(/-/g,'');
      counters[dateKey] = (counters[dateKey] || 0) + 1;
      localStorage.setItem(COUNTER_KEY, JSON.stringify(counters));
      const seq = String(counters[dateKey]).padStart(4,'0');
      return `CUST${dateKey}-${seq}`;
    }

    // ---------- Loading Screen Management ----------
    function simulateLoading() {
      let progress = 0;
      const progressBar = $('loadingProgress');
      const enterBtn = $('enterBtn');
      
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          enterBtn.style.display = 'block';
        }
        progressBar.style.width = `${progress}%`;
      }, 300);
    }

    function showMainApp() {
      $('loadingScreen').style.opacity = '0';
      setTimeout(() => {
        $('loadingScreen').style.display = 'none';
        $('appContainer').style.display = 'flex';
        
        // Initialize settings
        systemSettings = loadSettings();
        updateSettingsUI();
        
        // Initialize demo data if empty
        initDemoData();
        refreshList();
        renderAuditList();
        showPanel('start');
      }, 500);
    }

    // ---------- Navigation Management ----------
    function showPanel(panelName) {
      // Hide all panels
      document.querySelectorAll('.content-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      
      // Remove active class from all menu items
      document.querySelectorAll('.nav-btn').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected panel and activate menu
      $(`panel-${panelName}`).classList.add('active');
      $(`tab-${panelName}`).classList.add('active');
      
      // Update current panel
      currentPanel = panelName;
      
      // Special handling for reports panel
      if (panelName === 'report' && !reportUnlocked) {
        $('reportLocked').style.display = 'block';
        $('reportPanel').style.display = 'none';
      } else if (panelName === 'report' && reportUnlocked) {
        $('reportLocked').style.display = 'none';
        $('reportPanel').style.display = 'block';
        renderReport();
      }
      
      // Special handling for admin panel
      if (panelName === 'admin' && !adminUnlocked) {
        $('adminLocked').style.display = 'block';
        $('adminPanel').style.display = 'none';
      } else if (panelName === 'admin' && adminUnlocked) {
        $('adminLocked').style.display = 'none';
        $('adminPanel').style.display = 'block';
        renderAuditList();
      }
      
      // Refresh data if needed
      if (panelName === 'list') {
        refreshList();
      }
      
      // Special handling for form panel
      if (panelName === 'form') {
        if (!currentCustomerId) {
          currentCustomerId = genCustomerCode();
          $('customerIdDisplay').textContent = `Customer ID: ${currentCustomerId}`;
        }
      }
    }

    function goHome() {
      showPanel('start');
    }

    function goBack() {
      showPanel('start');
    }

    function logout() {
      if (confirm('คุณต้องการออกจากระบบหรือไม่?')) {
        reportUnlocked = false;
        adminUnlocked = false;
        $('appContainer').style.display = 'none';
        $('loadingScreen').style.display = 'flex';
        $('loadingScreen').style.opacity = '1';
        $('enterBtn').style.display = 'none';
        $('loadingProgress').style.width = '0%';
        simulateLoading();
      }
    }

    // ---------- Form Management ----------
    function clearForm() {
      document.getElementById('customerForm').reset();
      currentCustomerId = '';
      insurancePolicyCount = 0;
      $('insurance-policies').innerHTML = '';
      $('customerIdDisplay').textContent = 'Customer ID: กำลังสร้าง...';
      $('formStatus').textContent = '';
      $('business-section').style.display = 'none';
      $('children-section').style.display = 'none';
      $('dependents-section').style.display = 'none';
      calculateYearlyIncome();
    }

    function validateForm() {
      const required = [
        ['employee_name', 'กรอกชื่อผู้กรอก'],
        ['employee_id', 'กรอก Employee ID'],
        ['branch', 'กรอก Branch'],
        ['cust_name', 'กรอกชื่อนามสมมุติ'],
        ['cust_age', 'กรอกอายุ'],
        ['cust_gender', 'เลือกเพศ'],
        ['cust_occupation', 'เลือกอาชีพ'],
        ['cust_monthly_income', 'กรอกรายได้ต่อเดือน'],
        ['rh', 'เลือก RH']
      ];

      for (let [id, msg] of required) {
        const el = $(id);
        if (!el) continue;
        if (!el.value || el.value.trim() === '') {
          alert(msg);
          el.focus();
          return false;
        }
      }
      return true;
    }

    function calculateYearlyIncome() {
      const monthlyIncome = parseFloat($('cust_monthly_income').value) || 0;
      const yearlyIncome = monthlyIncome * 12;
      $('cust_yearly_income').value = yearlyIncome.toLocaleString();
    }

    function addInsurancePolicy() {
      insurancePolicyCount++;
      const policyHtml = `
        <div class="insurance-policy form-row border-bottom pb-2 mb-2" id="insurance-policy-${insurancePolicyCount}">
          <div class="form-group">
            <label class="form-label">ประเภทกรมธรรม์</label>
            <select class="form-select insurance-type">
              <option value="">เลือกประเภท</option>
              <option>สะสมทรัพย์</option>
              <option>สุขภาพ</option>
              <option>ตลอดชีพ</option>
              <option>บำนาญ</option>
              <option>UL</option>
              <option>อื่นๆ</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ทุน (บาท)</label>
            <input type="number" class="form-control insurance-capital" placeholder="ทุน">
          </div>
          <div class="form-group">
            <label class="form-label">เบี้ย (บาท)</label>
            <input type="number" class="form-control insurance-premium" placeholder="เบี้ย">
          </div>
          <div class="form-group">
            <label class="form-label">สถานะการชำระเบี้ย</label>
            <select class="form-select insurance-status">
              <option value="">เลือกสถานะ</option>
              <option>อยู่ระหว่างชำระเบี้ย</option>
              <option>ชำระเบี้ยประกันครบ</option>
              <option>ใกล้ครบกำหนดสัญญา</option>
            </select>
          </div>
          <div class="form-group d-flex align-items-end">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeInsurancePolicy(${insurancePolicyCount})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
      $('insurance-policies').insertAdjacentHTML('beforeend', policyHtml);
    }

    function removeInsurancePolicy(id) {
      const policyElement = $(`insurance-policy-${id}`);
      if (policyElement) {
        policyElement.remove();
      }
    }

    function getInsurancePolicies() {
      const policies = [];
      for (let i = 1; i <= insurancePolicyCount; i++) {
        const policyElement = $(`insurance-policy-${i}`);
        if (policyElement) {
          const type = policyElement.querySelector('.insurance-type').value;
          const capital = policyElement.querySelector('.insurance-capital').value;
          const premium = policyElement.querySelector('.insurance-premium').value;
          const status = policyElement.querySelector('.insurance-status').value;
          
          if (type || capital || premium || status) {
            policies.push({
              type,
              capital: parseFloat(capital) || 0,
              premium: parseFloat(premium) || 0,
              status
            });
          }
        }
      }
      return policies;
    }

    async function saveCustomer() {
      if (!validateForm()) return;

      const createdBy = $('employee_id').value.trim();
      const empName = $('employee_name').value.trim();
      const branch = $('branch').value.trim();
      const zone = $('zone').value.trim();
      const rh = $('rh').value.trim();

      const customer = {
        customer_id: currentCustomerId,
        name: $('cust_name').value.trim(),
        age: parseInt($('cust_age').value) || 0,
        gender: $('cust_gender').value,
        occupation: $('cust_occupation').value,
        monthly_income: parseFloat($('cust_monthly_income').value) || 0,
        yearly_income: parseFloat($('cust_monthly_income').value) * 12 || 0,
        welfare: $('cust_welfare').value,
        insurance_capital: parseFloat($('cust_insurance_capital').value) || 0,
        marital_status: $('cust_marital_status').value,
        spouse_age: parseInt($('cust_spouse_age').value) || 0,
        spouse_occupation: $('cust_spouse_occupation').value,
        has_children: $('cust_has_children').value,
        children_count: parseInt($('cust_children_count').value) || 0,
        children_ages: $('cust_children_ages').value,
        children_occupation: $('cust_children_occupation').value,
        has_dependents: $('cust_has_dependents').value,
        dependents_details: $('cust_dependents_details').value,
        business_type: $('cust_business_type').value,
        business_capital: parseFloat($('cust_business_capital').value) || 0,
        business_income: parseFloat($('cust_business_income').value) || 0,
        business_profit: parseFloat($('cust_business_profit').value) || 0,
        business_tax: parseFloat($('cust_business_tax').value) || 0,
        business_share: parseFloat($('cust_business_share').value) || 0,
        financial_products: {
          savings: parseFloat($('prod_savings').value) || 0,
          fixed: parseFloat($('prod_fixed').value) || 0,
          fund: parseFloat($('prod_fund').value) || 0,
          credit_card: parseFloat($('prod_credit_card').value) || 0,
          home_loan: parseFloat($('prod_home_loan').value) || 0,
          car_loan: parseFloat($('prod_car_loan').value) || 0,
          personal_loan: parseFloat($('prod_personal_loan').value) || 0
        },
        insurance_policies: getInsurancePolicies(),
        employee_comments: {
          presented_before: $('emp_presented_before').value,
          customer_feedback: $('emp_customer_feedback').value,
          proposed_product: $('emp_proposed_product').value,
          proposed_premium: parseFloat($('emp_proposed_premium').value) || 0,
          proposed_capital: parseFloat($('emp_proposed_capital').value) || 0
        },
        additional_comments: [],
        branch, 
        zone, 
        rh,
        created_by: createdBy,
        created_by_name: empName,
        created_at: nowISO(),
        updated_at: nowISO()
      };

      try {
        // Try to save to Supabase first
        await saveCustomerToSupabase(customer);
        
        // Also save to localStorage as backup
        const all = await loadData();
        all.unshift(customer);
        await saveData(all);
        
        await appendAudit('create', customer.customer_id, createdBy, { 
          name: customer.name, 
          branch 
        });
        
        clearForm();
        $('formStatus').textContent = `บันทึกเรียบร้อย: ${customer.customer_id}`;
        alert(`บันทึกข้อมูลลูกค้า ${customer.customer_id} เรียบร้อยแล้ว`);
        
        await refreshList();
        if (reportUnlocked) await renderReport();
        
      } catch(error) {
        console.error('Error saving customer:', error);
        alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message);
      }
    }

    // ---------- List and Search Functionality ----------
    async function renderTableRows(list) {
      const tbody = $('customerTbody');
      const countElement = $('searchResultsCount');
      
      countElement.textContent = `พบทั้งหมด ${list.length} รายการ`;
      
      tbody.innerHTML = list.map(c => `
        <tr>
          <td><input type="checkbox" class="rowSelect" data-id="${c.customer_id}"></td>
          <td><strong>${c.customer_id}</strong></td>
          <td>${c.name}</td>
          <td>${c.age || '-'}</td>
          <td>${c.occupation || '-'}</td>
          <td>${c.branch || '-'}</td>
          <td><span class="badge bg-primary">${c.rh || '-'}</span></td>
          <td>${c.created_by || '-'}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="viewDetail('${c.customer_id}')" title="View">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-outline-secondary" onclick="exportSinglePDF('${c.customer_id}')" title="PDF">
                <i class="fas fa-file-pdf"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="deleteRecord('${c.customer_id}')" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="9" class="text-center text-muted py-3">ไม่มีข้อมูลลูกค้า</td></tr>';
    }

    async function refreshList() {
      const all = await loadData();
      renderTableRows(all);
    }

    async function searchCustomers() {
      const q = $('search_customer').value.trim().toLowerCase();
      const by = $('search_by_creator').value.trim().toLowerCase();
      const rh = $('filter_rh').value.trim();
      
      let all = await loadData();
      
      if (q) {
        all = all.filter(c => 
          c.customer_id.toLowerCase().includes(q) || 
          (c.name || '').toLowerCase().includes(q)
        );
      }
      
      if (by) {
        all = all.filter(c => 
          (c.created_by || '').toLowerCase().includes(by) || 
          (c.created_by_name || '').toLowerCase().includes(by)
        );
      }
      
      if (rh) {
        all = all.filter(c => (c.rh || '') === rh);
      }
      
      renderTableRows(all);
    }

    // ---------- PDF Export Functions ----------
    async function exportSinglePDF(customerId) {
      const all = await loadData();
      const c = all.find(x => x.customer_id === customerId);
      if (!c) {
        alert('ไม่พบข้อมูลลูกค้า');
        return;
      }
      
      // Verify employee access
      const employeeId = prompt('กรุณากรอกรหัสพนักงานเพื่อยืนยันตัวตน:');
      if (!employeeId || employeeId.trim() !== c.created_by) {
        alert('รหัสพนักงานไม่ถูกต้อง');
        return;
      }
      
      await exportMultiplePDF([c]);
      await appendAudit('export_pdf', customerId, 'local-user', null);
      alert(`Export PDF สำหรับ ${customerId} เรียบร้อยแล้ว`);
    }

    async function exportMultiplePDF(items) {
      if (!items || items.length === 0) {
        alert('ไม่มีข้อมูลสำหรับ export');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'px', format: 'a4' });
      
      for (let i = 0; i < items.length; i++) {
        const c = items[i];
        const wrapper = document.createElement('div');
        wrapper.style.width = '794px';
        wrapper.style.padding = '20px';
        wrapper.style.background = '#fff';
        wrapper.style.fontFamily = 'Arial, Helvetica, sans-serif';
        
        wrapper.innerHTML = `
          <div style="color:#111;">
            <h2 style="margin:0;color:#007AFF;">Customer Summary — ${c.customer_id}</h2>
            <div style="color:#666;margin-bottom:20px;">Generated: ${formatDateISOToLocalShort(nowISO())}</div>
            
            <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
              <h4 style="margin:0 0 10px 0;color:#333;">Basic Information</h4>
              <div><strong>Name:</strong> ${c.name}</div>
              <div><strong>Age / Gender:</strong> ${c.age || '-'} / ${c.gender || '-'}</div>
              <div><strong>Occupation:</strong> ${c.occupation || '-'}</div>
              <div><strong>Monthly Income / Yearly Income:</strong> ${c.monthly_income || 0} / ${c.yearly_income || 0}</div>
              <div><strong>Branch / Zone / RH:</strong> ${c.branch || '-'} / ${c.zone || '-'} / ${c.rh || '-'}</div>
            </div>
            
            <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
              <h4 style="margin:0 0 10px 0;color:#333;">Financial Products</h4>
              <table style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr style="background:#e9ecef;">
                    <th style="text-align:left;padding:8px;">Product</th>
                    <th style="text-align:right;padding:8px;">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="padding:8px;border-bottom:1px solid #dee2e6;">Savings</td>
                    <td style="text-align:right;padding:8px;border-bottom:1px solid #dee2e6;">${c.financial_products?.savings || 0}</td>
                  </tr>
                  <tr>
                    <td style="padding:8px;border-bottom:1px solid #dee2e6;">Fixed Deposit</td>
                    <td style="text-align:right;padding:8px;border-bottom:1px solid #dee2e6;">${c.financial_products?.fixed || 0}</td>
                  </tr>
                  <tr>
                    <td style="padding:8px;border-bottom:1px solid #dee2e6;">Fund</td>
                    <td style="text-align:right;padding:8px;border-bottom:1px solid #dee2e6;">${c.financial_products?.fund || 0}</td>
                  </tr>
                  <tr>
                    <td style="padding:8px;border-bottom:1px solid #dee2e6;">Credit Card</td>
                    <td style="text-align:right;padding:8px;border-bottom:1px solid #dee2e6;">${c.financial_products?.credit_card || 0}</td>
                  </tr>
                  <tr>
                    <td style="padding:8px;border-bottom:1px solid #dee2e6;">Home Loan</td>
                    <td style="text-align:right;padding:8px;border-bottom:1px solid #dee2e6;">${c.financial_products?.home_loan || 0}</td>
                  </tr>
                  <tr>
                    <td style="padding:8px;border-bottom:1px solid #dee2e6;">Car Loan</td>
                    <td style="text-align:right;padding:8px;border-bottom:1px solid #dee2e6;">${c.financial_products?.car_loan || 0}</td>
                  </tr>
                  <tr>
                    <td style="padding:8px;border-bottom:1px solid #dee2e6;">Personal Loan</td>
                    <td style="text-align:right;padding:8px;border-bottom:1px solid #dee2e6;">${c.financial_products?.personal_loan || 0}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div style="font-size:11px;color:#999;text-align:center;margin-top:30px;">
              PLT-ttb Training — Confidential — For internal use only.
            </div>
          </div>
        `;
        
        document.body.appendChild(wrapper);
        
        try {
          const canvas = await html2canvas(wrapper, { 
            scale: 2, 
            useCORS: true, 
            backgroundColor: '#ffffff',
            logging: false
          });
          
          const imgData = canvas.toDataURL('image/png');
          const imgProps = doc.getImageProperties(imgData);
          const pdfWidth = doc.internal.pageSize.getWidth();
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
          
          doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
          if (i < items.length - 1) doc.addPage();
        } catch (error) {
          console.error('Error generating PDF:', error);
          alert('เกิดข้อผิดพลาดในการสร้าง PDF');
        } finally {
          document.body.removeChild(wrapper);
        }
      }
      
      doc.save(`APS_Export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')}.pdf`);
    }

    // ---------- Report and Dashboard Functions ----------
    function unlockReports() {
      const v = $('reportPass').value.trim();
      if (v === systemSettings.reportPassword) {
        reportUnlocked = true;
        $('reportLocked').style.display = 'none';
        $('reportPanel').style.display = 'block';
        appendAudit('report_unlock', 'report_panel', 'local-user', null);
        renderReport();
        alert('เข้าสู่ระบบรายงานเรียบร้อยแล้ว');
      } else {
        alert('Passcode ไม่ถูกต้อง');
      }
    }

    function unlockAdmin() {
      const v = $('adminPass').value.trim();
      if (v === systemSettings.adminPassword) {
        adminUnlocked = true;
        $('adminLocked').style.display = 'none';
        $('adminPanel').style.display = 'block';
        appendAudit('admin_unlock', 'admin_panel', 'local-user', null);
        renderAuditList();
        alert('เข้าสู่ระบบ Admin เรียบร้อยแล้ว');
      } else {
        alert('Passcode ไม่ถูกต้อง');
      }
    }

    function isMTD(isoDate) {
      if (!isoDate) return false;
      const d = new Date(isoDate);
      const now = new Date();
      return d.getFullYear() === now.getFullYear() && 
             d.getMonth() === now.getMonth() && 
             d.getDate() <= now.getDate();
    }

    async function renderReport() {
      if (!reportUnlocked) return;
      
      const region = $('filter_report_region').value;
      const startDate = $('filter_start_date').value;
      const endDate = $('filter_end_date').value;
      
      let all = await loadData();
      
      // Apply filters
      if (region && region !== 'all') {
        all = all.filter(c => c.rh === region);
      }
      
      if (startDate && endDate) {
        all = all.filter(c => {
          const custDate = new Date(c.created_at);
          return custDate >= new Date(startDate) && custDate <= new Date(endDate);
        });
      }
      
      // Filter MTD for KPI
      const listMTD = all.filter(c => isMTD(c.created_at));
      
      // Update KPIs
      $('kpi_total').textContent = listMTD.length;
      
      // Top branch
      const branchCounts = {};
      listMTD.forEach(c => { 
        branchCounts[c.branch] = (branchCounts[c.branch] || 0) + 1; 
      });
      
      const topBranch = Object.entries(branchCounts).sort((a, b) => b[1] - a[1])[0];
      $('kpi_top_branch').textContent = topBranch ? `${topBranch[0]} (${topBranch[1]})` : '-';
    }

    // ---------- Admin and Audit Functions ----------
    async function renderAuditList() {
      const a = await loadAudit();
      const container = $('auditList');
      
      container.innerHTML = a.map(x => `
        <div class="border-bottom pb-2 mb-2">
          <div class="d-flex justify-content-between">
            <strong>${x.action}</strong>
            <small class="text-muted">${formatDateISOToLocalShort(x.time)}</small>
          </div>
          <div>Entity: ${x.entity} | โดย: ${x.performed_by}</div>
          ${x.data ? `<small class="text-muted">ข้อมูล: ${JSON.stringify(x.data)}</small>` : ''}
        </div>
      `).join('') || '<div class="text-muted text-center py-3">ยังไม่มีบันทึกการใช้งาน</div>';
    }

    // ---------- Settings Functions ----------
    function changeReportPassword() {
      const newPass = $('reportPassInput').value.trim();
      if (!newPass) {
        alert('กรุณากรอกรหัสผ่านใหม่');
        return;
      }
      
      systemSettings.reportPassword = newPass;
      saveSettings(systemSettings);
      alert('เปลี่ยนรหัสผ่านรายงานเรียบร้อยแล้ว');
    }

    function changeAdminPassword() {
      const newPass = $('adminPassInput').value.trim();
      if (!newPass) {
        alert('กรุณากรอกรหัสผ่านใหม่');
        return;
      }
      
      systemSettings.adminPassword = newPass;
      saveSettings(systemSettings);
      alert('เปลี่ยนรหัสผ่าน Admin เรียบร้อยแล้ว');
    }

    async function exportAllData() {
      const data = {
        customers: await loadData(),
        audit: await loadAudit(),
        settings: systemSettings,
        exportDate: nowISO()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `aps_backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      await appendAudit('export_all_data', 'system', 'admin', null);
      alert('ส่งออกข้อมูลทั้งหมดเรียบร้อยแล้ว');
    }

    async function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = async e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = async event => {
          try {
            const data = JSON.parse(event.target.result);
            
            if (data.customers) {
              await saveData(data.customers);
            }
            if (data.audit) {
              await saveAudit(data.audit);
            }
            if (data.settings) {
              saveSettings(data.settings);
            }
            
            await refreshList();
            await renderAuditList();
            alert('นำเข้าข้อมูลเรียบร้อยแล้ว');
            await appendAudit('import_data', 'system', 'admin', null);
          } catch (error) {
            alert('ไฟล์ไม่ถูกต้องหรือเสียหาย');
          }
        };
        
        reader.readAsText(file);
      };
      
      input.click();
    }

    async function clearAllData() {
      if (!confirm('คุณแน่ใจหรือไม่ที่จะล้างข้อมูลทั้งหมด? การกระทำนี้ไม่สามารถย้อนกลับได้!')) {
        return;
      }
      
      try {
        // Delete from Supabase
        const { error } = await supabase
          .from('customers')
          .delete()
          .neq('customer_id', 'dummy'); // Delete all records
        
        if (error) throw error;
      } catch (e) {
        console.error('Error clearing data from Supabase:', e);
      }
      
      // Clear localStorage
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(AUDIT_KEY);
      localStorage.removeItem(COUNTER_KEY);
      
      await refreshList();
      await renderAuditList();
      if (reportUnlocked) await renderReport();
      
      await appendAudit('clear_all_data', 'system', 'admin', null);
      alert('ล้างข้อมูลทั้งหมดเรียบร้อยแล้ว');
    }

    function resetSystem() {
      if (!confirm('คุณแน่ใจหรือไม่ที่จะรีเซ็ตระบบทั้งหมด? การกระทำนี้จะลบข้อมูลและการตั้งค่าทั้งหมด!')) {
        return;
      }
      
      localStorage.clear();
      
      // Reload page to reset everything
      location.reload();
    }

    function updateSystemSettings() {
      systemSettings.pageSize = $('pageSizeSelect').value;
      systemSettings.dateFormat = $('dateFormatSelect').value;
      systemSettings.autoSave = $('autoSaveCheck').checked;
      
      saveSettings(systemSettings);
      alert('บันทึกการตั้งค่าระบบเรียบร้อยแล้ว');
    }

    // ---------- Demo Data Initialization ----------
    async function initDemoData() {
      const data = await loadData();
      if (data.length === 0) {
        const demo = [
          { 
            customer_id: genCustomerCode(), 
            name: 'สมชาย ใจดี', 
            age: 35,
            gender: 'ชาย',
            occupation: 'พนักงานบริษัท',
            monthly_income: 50000,
            yearly_income: 600000,
            welfare: 'มี - วงเงินสูง',
            insurance_capital: 1000000,
            marital_status: 'สมรส',
            spouse_age: 32,
            spouse_occupation: 'ครู',
            has_children: 'มี',
            children_count: 2,
            children_ages: '8,5',
            children_occupation: 'นักเรียน',
            has_dependents: 'ไม่มี',
            financial_products: {
              savings: 50000,
              fixed: 200000,
              fund: 150000,
              credit_card: 50000,
              home_loan: 2000000,
              car_loan: 500000,
              personal_loan: 0
            },
            insurance_policies: [
              {
                type: 'สะสมทรัพย์',
                capital: 1000000,
                premium: 50000,
                status: 'ชำระปกติ'
              }
            ],
            employee_comments: {
              presented_before: 'ยังไม่เคยนำเสนอ',
              customer_feedback: '',
              proposed_product: 'ประกันสุขภาพ',
              proposed_premium: 30000,
              proposed_capital: 1000000
            },
            additional_comments: [],
            branch: 'Bangkok Central', 
            zone: 'Zone A', 
            rh: 'RH1',
            created_by: 'BR1001', 
            created_by_name: 'Somchai', 
            created_at: nowISO(), 
            updated_at: nowISO()
          }
        ];
        await saveData(demo);
      }
    }

    // ---------- Event Listeners and Initialization ----------
    document.addEventListener('DOMContentLoaded', function() {
      // Start loading simulation
      simulateLoading();
      
      // Enter button click
      $('enterBtn').addEventListener('click', showMainApp);
      
      // Start button click
      $('btn-start').addEventListener('click', function() {
        showPanel('form');
      });
      
      // Navigation event listeners
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const panel = this.getAttribute('data-panel');
          showPanel(panel);
        });
      });
      
      // Back and Home buttons for each panel
      document.querySelectorAll('[id^="btn-back-"]').forEach(btn => {
        btn.addEventListener('click', goBack);
      });
      
      document.querySelectorAll('[id^="btn-home-"]').forEach(btn => {
        btn.addEventListener('click', goHome);
      });
      
      // Logout button
      $('btn-logout').addEventListener('click', logout);
      
      // Form event listeners
      $('btnAddInsurance').addEventListener('click', addInsurancePolicy);
      
      // Calculate yearly income when monthly income changes
      $('cust_monthly_income').addEventListener('input', calculateYearlyIncome);
      
      // Show/hide business section based on occupation
      $('cust_occupation').addEventListener('change', function() {
        if (this.value === 'เจ้าของกิจการ/ธุรกิจส่วนตัว') {
          $('business-section').style.display = 'block';
        } else {
          $('business-section').style.display = 'none';
        }
      });
      
      // Show/hide children section
      $('cust_has_children').addEventListener('change', function() {
        if (this.value === 'มี') {
          $('children-section').style.display = 'block';
        } else {
          $('children-section').style.display = 'none';
        }
      });
      
      // Show/hide dependents section
      $('cust_has_dependents').addEventListener('change', function() {
        if (this.value === 'มี') {
          $('dependents-section').style.display = 'block';
        } else {
          $('dependents-section').style.display = 'none';
        }
      });
      
      $('btnClear').addEventListener('click', clearForm);
      $('btnSave').addEventListener('click', saveCustomer);
      
      // List and search event listeners
      $('btnSearch').addEventListener('click', searchCustomers);
      $('btnRefresh').addEventListener('click', refreshList);
      $('btnBulkExport').addEventListener('click', async () => {
        const checks = Array.from(document.querySelectorAll('.rowSelect:checked'));
        if (!checks.length) {
          alert('เลือกอย่างน้อย 1 รายการเพื่อ export');
          return;
        }
        
        const ids = checks.map(ch => ch.dataset.id);
        const all = await loadData();
        const items = all.filter(c => ids.includes(c.customer_id));
        
        await exportMultiplePDF(items);
        await appendAudit('export_bulk_pdf', `bulk:${ids.join(',')}`, 'local-user', { 
          count: items.length 
        });
        
        alert(`Export PDF จำนวน ${items.length} รายการเรียบร้อยแล้ว`);
      });
      
      $('selectAll').addEventListener('change', (e) => {
        document.querySelectorAll('.rowSelect').forEach(cb => {
          cb.checked = e.target.checked;
        });
      });
      
      // Report event listeners
      $('btnUnlock').addEventListener('click', unlockReports);
      $('btnExportAll').addEventListener('click', async () => {
        const all = await loadData();
        if (!all.length) {
          alert('ไม่มีข้อมูลสำหรับ export');
          return;
        }
        
        await exportMultiplePDF(all);
        await appendAudit('export_all_pdf', 'all', 'local-user', { 
          count: all.length 
        });
        
        alert(`Export PDF ทั้งหมด ${all.length} รายการเรียบร้อยแล้ว`);
      });
      
      $('btnExportCSV').addEventListener('click', async () => {
        const all = await loadData();
        const rows = all.map(c => ({
          customer_id: c.customer_id,
          name: c.name,
          age: c.age,
          occupation: c.occupation,
          branch: c.branch,
          rh: c.rh,
          created_by: c.created_by,
          created_at: c.created_at
        }));
        
        const csv = [Object.keys(rows[0] || {}).join(',')]
          .concat(rows.map(r => 
            Object.values(r).map(v => 
              `"${String(v || '').replace(/"/g, '""')}"`
            ).join(','))
          ).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `aps_export_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        await appendAudit('export_csv', 'all', 'local-user', { 
          count: rows.length 
        });
        
        alert('Export CSV เรียบร้อยแล้ว');
      });
      
      $('btnApplyFilters').addEventListener('click', renderReport);
      
      // Admin event listeners
      $('btnUnlockAdmin').addEventListener('click', unlockAdmin);
      $('btnRefreshAudit').addEventListener('click', renderAuditList);
      $('btnExportAudit').addEventListener('click', async () => {
        const audit = await loadAudit();
        const csv = [['Action', 'Entity', 'Performed By', 'Time', 'Data'].join(',')]
          .concat(audit.map(a => 
            [a.action, a.entity, a.performed_by, a.time, JSON.stringify(a.data || '')]
              .map(v => `"${String(v || '').replace(/"/g, '""')}"`)
              .join(',')
          )).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `audit_log_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert('Export Audit Log เรียบร้อยแล้ว');
      });
      
      // Settings event listeners
      $('btnChangeReportPass').addEventListener('click', changeReportPassword);
      $('btnChangeAdminPass').addEventListener('click', changeAdminPassword);
      $('btnExportAllData').addEventListener('click', exportAllData);
      $('btnImportData').addEventListener('click', importData);
      $('btnClearAllData').addEventListener('click', clearAllData);
      $('btnResetSystem').addEventListener('click', resetSystem);
      
      // Settings change listeners
      $('pageSizeSelect').addEventListener('change', updateSystemSettings);
      $('dateFormatSelect').addEventListener('change', updateSystemSettings);
      $('autoSaveCheck').addEventListener('change', updateSystemSettings);
      
      // Check for select all functionality
      document.addEventListener('click', (e) => {
        if (e.target && e.target.matches('.rowSelect')) {
          const all = document.querySelectorAll('.rowSelect');
          const checked = Array.from(all).filter(cb => cb.checked).length;
          $('selectAll').checked = checked === all.length;
        }
      });
    });

    // ---------- Global Functions for HTML onclick ----------
    window.removeInsurancePolicy = removeInsurancePolicy;
    
    window.viewDetail = async function(customerId) {
      const all = await loadData();
      const c = all.find(x => x.customer_id === customerId);
      if (!c) {
        alert('ไม่พบข้อมูลลูกค้า');
        return;
      }
      
      // Create modal for customer details
      const modalHtml = `
        <div class="modal fade" id="customerDetailModal" tabindex="-1" aria-labelledby="customerDetailModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="customerDetailModalLabel">รายละเอียดลูกค้า - ${c.customer_id}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="card mb-4">
                      <div class="card-header bg-primary text-white">
                        <i class="fas fa-info-circle"></i> ข้อมูลพื้นฐาน
                      </div>
                      <div class="card-body">
                        <p><strong>ชื่อนามสมมุติ:</strong> ${c.name}</p>
                        <p><strong>อายุ/เพศ:</strong> ${c.age || '-'} / ${c.gender || '-'}</p>
                        <p><strong>อาชีพ:</strong> ${c.occupation || '-'}</p>
                        <p><strong>รายได้ต่อเดือน/ปี:</strong> ${c.monthly_income || 0} / ${c.yearly_income || 0}</p>
                        <p><strong>สวัสดิการ:</strong> ${c.welfare || '-'}</p>
                        <p><strong>ทุนประกันต่อปี:</strong> ${c.insurance_capital || 0}</p>
                        <p><strong>Branch/Zone/RH:</strong> ${c.branch || '-'} / ${c.zone || '-'} / ${c.rh || '-'}</p>
                      </div>
                    </div>
                    
                    <div class="card mb-4">
                      <div class="card-header bg-success text-white">
                        <i class="fas fa-users"></i> ข้อมูลครอบครัว
                      </div>
                      <div class="card-body">
                        <p><strong>สถานภาพ:</strong> ${c.marital_status || '-'}</p>
                        <p><strong>อายุคู่สมรส:</strong> ${c.spouse_age || '-'}</p>
                        <p><strong>อาชีพคู่สมรส:</strong> ${c.spouse_occupation || '-'}</p>
                        <p><strong>มีบุตร:</strong> ${c.has_children || '-'}</p>
                        ${c.has_children === 'มี' ? `
                          <p><strong>จำนวนบุตร:</strong> ${c.children_count || '-'}</p>
                          <p><strong>อายุบุตร:</strong> ${c.children_ages || '-'}</p>
                          <p><strong>อาชีพบุตร:</strong> ${c.children_occupation || '-'}</p>
                        ` : ''}
                        <p><strong>มีบุคคลอื่นที่ต้องดูแล:</strong> ${c.has_dependents || '-'}</p>
                        ${c.has_dependents === 'มี' ? `
                          <p><strong>รายละเอียด:</strong> ${c.dependents_details || '-'}</p>
                        ` : ''}
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="card mb-4">
                      <div class="card-header bg-info text-white">
                        <i class="fas fa-piggy-bank"></i> ผลิตภัณฑ์ทางการเงิน
                      </div>
                      <div class="card-body">
                        <p><strong>เงินฝากออมทรัพย์:</strong> ${c.financial_products?.savings || 0}</p>
                        <p><strong>เงินฝากประจำ:</strong> ${c.financial_products?.fixed || 0}</p>
                        <p><strong>กองทุน:</strong> ${c.financial_products?.fund || 0}</p>
                        <p><strong>บัตรเครดิต:</strong> ${c.financial_products?.credit_card || 0}</p>
                        <p><strong>เงินกู้บ้าน:</strong> ${c.financial_products?.home_loan || 0}</p>
                        <p><strong>เงินกู้รถ:</strong> ${c.financial_products?.car_loan || 0}</p>
                        <p><strong>เงินกู้ส่วนบุคคล:</strong> ${c.financial_products?.personal_loan || 0}</p>
                      </div>
                    </div>
                    
                    <div class="card mb-4">
                      <div class="card-header bg-warning text-dark">
                        <i class="fas fa-shield-alt"></i> กรมธรรม์ประกัน
                      </div>
                      <div class="card-body">
                        ${c.insurance_policies && c.insurance_policies.length > 0 ? 
                          c.insurance_policies.map(policy => `
                            <div class="border-bottom pb-2 mb-2">
                              <p><strong>ประเภท:</strong> ${policy.type || '-'}</p>
                              <p><strong>ทุน:</strong> ${policy.capital || 0}</p>
                              <p><strong>เบี้ย:</strong> ${policy.premium || 0}</p>
                              <p><strong>สถานะ:</strong> ${policy.status || '-'}</p>
                            </div>
                          `).join('') : 
                          '<p class="text-muted">ไม่มีข้อมูลกรมธรรม์</p>'
                        }
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="card mb-4">
                  <div class="card-header bg-secondary text-white">
                    <i class="fas fa-comments"></i> ความเห็นพนักงาน
                  </div>
                  <div class="card-body">
                    <p><strong>เคยนำเสนอแล้วหรือไม่:</strong> ${c.employee_comments?.presented_before || '-'}</p>
                    <p><strong>ความคิดเห็นลูกค้า:</strong> ${c.employee_comments?.customer_feedback || '-'}</p>
                    <p><strong>ผลิตภัณฑ์ที่คาดหวัง:</strong> ${c.employee_comments?.proposed_product || '-'}</p>
                    <p><strong>เบี้ย/ทุนที่คาดหวัง:</strong> ${c.employee_comments?.proposed_premium || 0} / ${c.employee_comments?.proposed_capital || 0}</p>
                  </div>
                </div>
                
                <div class="comment-section">
                  <h6>ความคิดเห็นเพิ่มเติม</h6>
                  <div id="customerComments">
                    ${c.additional_comments && c.additional_comments.length > 0 ? 
                      c.additional_comments.map(comment => `
                        <div class="comment-item">
                          <div class="comment-meta">${comment.date} โดย ${comment.by}</div>
                          <div>${comment.text}</div>
                        </div>
                      `).join('') : 
                      '<p class="text-muted">ยังไม่มีความคิดเห็น</p>'
                    }
                  </div>
                  <div class="mt-3">
                    <textarea class="form-control mb-2" id="newComment" placeholder="เพิ่มความคิดเห็นใหม่"></textarea>
                    <button class="btn btn-primary btn-sm" onclick="addComment('${c.customer_id}')">
                      <i class="fas fa-plus"></i> เพิ่มความคิดเห็น
                    </button>
                  </div>
                </div>
                
                <div class="mt-4 p-3 bg-light rounded">
                  <small class="text-muted">
                    สร้างโดย: ${c.created_by_name || c.created_by} | 
                    วันที่สร้าง: ${formatDateISOToLocalShort(c.created_at)} | 
                    อัปเดตล่าสุด: ${formatDateISOToLocalShort(c.updated_at)}
                  </small>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('customerDetailModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add modal to document
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('customerDetailModal'));
      modal.show();
    };
    
    window.addComment = async function(customerId) {
      const all = await loadData();
      const c = all.find(x => x.customer_id === customerId);
      if (!c) {
        alert('ไม่พบข้อมูลลูกค้า');
        return;
      }
      
      const newComment = document.getElementById('newComment').value.trim();
      if (!newComment) {
        alert('กรุณากรอกความคิดเห็น');
        return;
      }
      
      // Initialize comments array if it doesn't exist
      if (!c.additional_comments) {
        c.additional_comments = [];
      }
      
      // Add new comment
      c.additional_comments.push({
        text: newComment,
        by: systemSettings.currentUser || 'Unknown',
        date: formatDateISOToLocalShort(nowISO())
      });
      
      // Update customer data
      const index = all.findIndex(x => x.customer_id === customerId);
      if (index !== -1) {
        all[index] = c;
        await saveData(all);
        
        // Try to update in Supabase
        try {
          await updateCustomerInSupabase(customerId, {
            additional_comments: c.additional_comments,
            updated_at: nowISO()
          });
        } catch (e) {
          console.error('Error updating customer in Supabase:', e);
        }
        
        // Clear input
        document.getElementById('newComment').value = '';
        
        // Refresh comments display
        const commentsHtml = c.additional_comments.map(comment => `
          <div class="comment-item">
            <div class="comment-meta">${comment.date} โดย ${comment.by}</div>
            <div>${comment.text}</div>
          </div>
        `).join('');
        
        document.getElementById('customerComments').innerHTML = commentsHtml;
        
        alert('เพิ่มความคิดเห็นเรียบร้อยแล้ว');
      }
    };
    
    window.exportSinglePDF = exportSinglePDF;
    
    window.deleteRecord = async function(customerId) {
      if (!confirm('ลบรายการนี้จริงหรือไม่?')) return;
      
      try {
        // Delete from Supabase
        await deleteCustomerFromSupabase(customerId);
      } catch (e) {
        console.error('Error deleting from Supabase:', e);
      }
      
      // Delete from localStorage
      let all = await loadData();
      const customer = all.find(c => c.customer_id === customerId);
      all = all.filter(x => x.customer_id !== customerId);
      await saveData(all);
      
      await appendAudit('delete', customerId, 'local-user', {
        customer_name: customer ? customer.name : 'Unknown'
      });
      
      await refreshList();
      if (reportUnlocked) await renderReport();
      
      alert('ลบข้อมูลลูกค้าเรียบร้อยแล้ว');
    };
  </script>
</body>
</html>
