<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Account Planning System - Secure Version</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- html2canvas + jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #007AFF;
      --primary-dark: #0056CC;
      --secondary-color: #5856D6;
      --success-color: #34C759;
      --warning-color: #FF9500;
      --error-color: #FF3B30;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.18);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --text-white: #FFFFFF;
      --border-radius: 12px;
      --border-radius-lg: 20px;
      --spacing-xs: 0.5rem;
      --spacing-sm: 1rem;
      --spacing-md: 1.5rem;
      --spacing-lg: 2rem;
      --spacing-xl: 3rem;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* ---------- Loading Screen ---------- */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-gradient);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .loading-logo {
      font-size: 3rem;
      color: white;
      margin-bottom: var(--spacing-md);
      animation: pulse 2s infinite;
    }

    .loading-text {
      color: white;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: var(--spacing-lg);
    }

    .loading-spinner-large {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
      margin-bottom: var(--spacing-lg);
    }

    .loading-progress {
      width: 300px;
      height: 6px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: var(--spacing-md);
    }

    .loading-progress-bar {
      height: 100%;
      background: white;
      width: 0%;
      transition: width 0.3s ease;
    }

    .enter-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.5);
      padding: 0.75rem 2rem;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .enter-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ---------- Login Screen ---------- */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-gradient);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9998;
    }

    .login-container {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-xl);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .login-logo {
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: var(--spacing-md);
    }

    .login-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: var(--spacing-sm);
      color: var(--text-primary);
    }

    .login-subtitle {
      color: var(--text-secondary);
      margin-bottom: var(--spacing-lg);
    }

    /* ---------- Main App ---------- */
    .app-container {
      min-height: 100vh;
      display: none;
      flex-direction: column;
      padding: 1.25rem;
    }

    .glass-container {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      flex: 1;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    /* ---------- Compact Navigation ---------- */
    .compact-nav {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-md);
    }

    .nav-brand {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .nav-menu {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .nav-btn {
      background: white;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
      font-weight: 500;
      text-decoration: none;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.85rem;
      position: relative;
    }

    .nav-btn:hover {
      transform: translateY(-1px);
      border-color: var(--primary-color);
      box-shadow: 0 2px 6px rgba(0, 122, 255, 0.15);
    }

    .nav-btn.active {
      background: var(--primary-color);
      color: white;
    }

    .nav-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 122, 255, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: var(--text-white);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.8rem;
    }

    /* ---------- Page Header ---------- */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .page-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .page-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* ---------- Content Panels ---------- */
    .content-panel {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .content-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      margin-bottom: 1rem;
      border: none;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .card-body {
      padding: var(--spacing-md);
    }

    .small-muted {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .required::after {
      content: " *";
      color: var(--error-color);
    }

    .table-fixed {
      max-height: 240px;
      overflow: auto;
      display: block;
    }

    .watermark {
      position: fixed;
      right: 10px;
      bottom: 10px;
      opacity: 0.12;
      font-weight: 700;
      font-size: 12px;
      color: var(--text-primary);
    }

    .form-container {
      max-width: 100%;
      margin: 0 auto;
    }

    .form-section {
      background: white;
      border-radius: var(--border-radius);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .form-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: var(--spacing-sm);
      color: var(--text-primary);
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: var(--spacing-xs);
    }

    .form-group {
      margin-bottom: var(--spacing-sm);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-sm);
    }

    .form-label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.6rem;
      border: 2px solid #E5E5EA;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: white;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .input-with-button {
      display: flex;
      gap: var(--spacing-sm);
    }

    .input-with-button .form-input {
      flex: 1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }

    .stat-card {
      background: white;
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--error-color);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: var(--spacing-md);
    }

    .modal-content {
      background: white;
      border-radius: var(--border-radius);
      padding: var(--spacing-md);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #E5E5EA;
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .form-subsection {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid var(--primary-color);
    }
    
    .subsection-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: #333;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .financial-products {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .product-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem;
      background: white;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    
    .product-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 130px;
    }
    
    .product-inputs {
      display: flex;
      gap: 0.75rem;
      flex: 1;
    }
    
    .add-button {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
    }
    
    .remove-button {
      background: var(--error-color);
      color: white;
      border: none;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
    }
    
    .unknown-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
      font-size: 0.8rem;
      color: #666;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .chart-container {
      background: white;
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .chart-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      text-align: center;
    }

    .filter-section {
      background: white;
      padding: var(--spacing-sm);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: var(--spacing-md);
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
      align-items: end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .filter-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .setting-card {
      background: white;
      padding: var(--spacing-md);
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .setting-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .setting-description {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: var(--spacing-sm);
    }

    .danger-zone {
      border-left: 4px solid var(--error-color);
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .compact-nav {
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.5rem;
      }
      
      .nav-menu {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .filter-section {
        flex-direction: column;
        align-items: stretch;
      }
      
      .page-header {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }
      
      .page-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .settings-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">
      <i class="fas fa-chart-line"></i>
    </div>
    <div class="loading-text">Account Planning System</div>
    <div class="loading-spinner-large"></div>
    <div class="loading-progress">
      <div class="loading-progress-bar" id="loadingProgress"></div>
    </div>
    <button class="enter-btn" id="enterBtn" style="display: none;">เข้าใช้งานระบบ</button>
  </div>

  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-container glass-card">
      <div class="login-logo">
        <i class="fas fa-lock"></i>
      </div>
      <h2 class="login-title">ระบบ Account Planning</h2>
      <p class="login-subtitle">กรุณากรอกรหัสผ่านเพื่อเข้าใช้งาน</p>
      
      <div class="form-group">
        <label class="form-label">รหัสผ่านระบบ</label>
        <input type="password" id="systemPassword" class="form-input" placeholder="กรอกรหัสผ่าน">
      </div>
      
      <div class="form-group">
        <button class="btn btn-primary w-100" id="loginBtn">
          <i class="fas fa-sign-in-alt"></i> เข้าสู่ระบบ
        </button>
      </div>
      
      <div class="small-muted">
        รหัสผ่านเริ่มต้น: <strong>2025</strong> (สามารถเปลี่ยนได้ในหน้าตั้งค่า)
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div class="app-container" id="appContainer">
    <div class="glass-container">
      <!-- Compact Navigation -->
      <nav class="compact-nav">
        <div class="nav-brand">
          <i class="fas fa-chart-line"></i>
          APS
        </div>
        <div class="nav-menu">
          <button class="nav-btn active" id="tab-form" data-panel="form">
            <i class="fas fa-user-plus"></i> Create
          </button>
          <button class="nav-btn" id="tab-list" data-panel="list">
            <i class="fas fa-list"></i> List
          </button>
          <button class="nav-btn" id="tab-report" data-panel="report">
            <i class="fas fa-chart-bar"></i> Reports
          </button>
          <button class="nav-btn" id="tab-admin" data-panel="admin">
            <i class="fas fa-cog"></i> Admin
          </button>
          <button class="nav-btn" id="tab-settings" data-panel="settings">
            <i class="fas fa-sliders-h"></i> Settings
          </button>
        </div>
        <div class="nav-actions">
          <button class="btn btn-sm btn-secondary" id="btn-logout">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </nav>

      <!-- Content Area -->
      <div id="content-area">
        
        <!-- FORM PANEL -->
        <div id="panel-form" class="content-panel active">
          <div class="page-header">
            <div class="page-title">
              <i class="fas fa-user-plus"></i> ฟอร์มกรอกข้อมูลลูกค้า
            </div>
            <div class="page-actions">
              <button class="btn btn-sm btn-secondary" id="btn-back-form">
                <i class="fas fa-arrow-left"></i> ย้อนกลับ
              </button>
              <button class="btn btn-sm btn-primary" id="btn-home-form">
                <i class="fas fa-home"></i> หน้าแรก
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <p class="small-muted mb-3">กรอกข้อมูลให้ครบ — ระบบจะสร้าง Customer ID อัตโนมัติ</p>

              <form id="customerForm" class="row g-3">
                <!-- Employee Information -->
                <div class="form-subsection">
                  <div class="subsection-title">
                    <i class="fas fa-user-tie"></i> ข้อมูลพนักงาน
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label required">ชื่อพนักงาน</label>
                      <input type="text" id="employee_name" class="form-control" placeholder="ชื่อผู้กรอก (เช่น Somchai)">
                    </div>
                    <div class="form-group">
                      <label class="form-label required">รหัสพนักงาน</label>
                      <input type="text" id="employee_id" class="form-control" placeholder="BR1234">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label required">Branch</label>
                      <input type="text" id="branch" class="form-control" placeholder="Bangkok Central">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Zone</label>
                      <input type="text" id="zone" class="form-control" placeholder="Zone A">
                    </div>
                    <div class="form-group">
                      <label class="form-label required">RH (RH1-RH5)</label>
                      <select id="rh" class="form-select">
                        <option value="">เลือก RH</option>
                        <option>RH1</option>
                        <option>RH2</option>
                        <option>RH3</option>
                        <option>RH4</option>
                        <option>RH5</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Customer Personal Information -->
                <div class="form-subsection">
                  <div class="subsection-title">
                    <i class="fas fa-user"></i> ข้อมูลส่วนตัวลูกค้า
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label required">ชื่อ</label>
                      <input type="text" id="cust_first" class="form-control" placeholder="ชื่อ">
                    </div>
                    <div class="form-group">
                      <label class="form-label required">นามสกุล</label>
                      <input type="text" id="cust_last" class="form-control" placeholder="นามสกุล">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">เบอร์โทรศัพท์</label>
                      <input type="tel" id="cust_phone" class="form-control" placeholder="0812345678">
                    </div>
                    <div class="form-group">
                      <label class="form-label">อีเมล</label>
                      <input type="email" id="cust_email" class="form-control" placeholder="example@domain.com">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">ที่อยู่</label>
                    <textarea id="cust_address" rows="2" class="form-control" placeholder="ที่อยู่"></textarea>
                  </div>
                </div>

                <!-- Products -->
                <div class="form-subsection">
                  <div class="subsection-title">
                    <i class="fas fa-box"></i> ผลิตภัณฑ์ที่มีอยู่
                  </div>
                  <div class="form-group">
                    <label class="form-label">ผลิตภัณฑ์ที่มีอยู่ (เพิ่มได้หลายรายการ)</label>
                    <div class="d-flex gap-2 mb-2">
                      <input type="text" id="prod_name" class="form-control" placeholder="ชื่อผลิตภัณฑ์ (เช่น ABC Life 20Y)">
                      <input type="number" id="prod_sum" class="form-control" placeholder="Sum Assured / มูลค่า">
                      <input type="number" id="prod_premium" class="form-control" placeholder="เบี้ย/ปี">
                      <button type="button" id="btnAddProd" class="btn btn-outline-primary btn-sm">เพิ่ม</button>
                    </div>
                    <div id="prodList" class="mb-2"></div>
                  </div>
                </div>

                <!-- Buttons -->
                <div class="col-12 d-flex gap-2">
                  <button type="button" id="btnSave" class="btn btn-primary">
                    <i class="fas fa-save"></i> บันทึกข้อมูล
                  </button>
                  <button type="button" id="btnClear" class="btn btn-secondary">
                    <i class="fas fa-broom"></i> ล้างฟอร์ม
                  </button>
                  <div class="ms-auto small-muted align-self-center" id="formStatus"></div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- LIST / SEARCH PANEL -->
        <div id="panel-list" class="content-panel">
          <div class="page-header">
            <div class="page-title">
              <i class="fas fa-list"></i> รายการลูกค้า / ค้นหา
            </div>
            <div class="page-actions">
              <button class="btn btn-sm btn-secondary" id="btn-back-list">
                <i class="fas fa-arrow-left"></i> ย้อนกลับ
              </button>
              <button class="btn btn-sm btn-primary" id="btn-home-list">
                <i class="fas fa-home"></i> หน้าแรก
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div class="filter-section">
                <div class="filter-group">
                  <div class="filter-label">ค้นหาลูกค้า</div>
                  <input type="text" id="search_customer" class="form-control" placeholder="Search Customer ID หรือชื่อ">
                </div>
                <div class="filter-group">
                  <div class="filter-label">ค้นหาตามพนักงาน</div>
                  <input type="text" id="search_by_creator" class="form-control" placeholder="Search by Employee ID">
                </div>
                <div class="filter-group">
                  <div class="filter-label">Filter RH</div>
                  <select id="filter_rh" class="form-select">
                    <option value="">ทั้งหมด</option>
                    <option>RH1</option>
                    <option>RH2</option>
                    <option>RH3</option>
                    <option>RH4</option>
                    <option>RH5</option>
                  </select>
                </div>
                <div class="d-flex gap-2 align-items-end">
                  <button class="btn btn-outline-primary btn-sm" id="btnSearch">
                    <i class="fas fa-search"></i> ค้นหา
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" id="btnRefresh">
                    <i class="fas fa-sync-alt"></i> รีเฟรช
                  </button>
                </div>
              </div>

              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="small-muted" id="searchResultsCount"></div>
                <div>
                  <button class="btn btn-outline-success btn-sm" id="btnBulkExport">
                    <i class="fas fa-file-pdf"></i> Export PDF
                  </button>
                </div>
              </div>

              <div class="table-responsive table-fixed">
                <table class="table table-striped" id="customerTable">
                  <thead class="table-light">
                    <tr>
                      <th><input type="checkbox" id="selectAll"></th>
                      <th>Customer ID</th>
                      <th>Name</th>
                      <th>Branch</th>
                      <th>RH</th>
                      <th>Created By</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="customerTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- REPORTS PANEL -->
        <div id="panel-report" class="content-panel">
          <div class="page-header">
            <div class="page-title">
              <i class="fas fa-chart-bar"></i> รายงาน / Dashboard
            </div>
            <div class="page-actions">
              <button class="btn btn-sm btn-secondary" id="btn-back-report">
                <i class="fas fa-arrow-left"></i> ย้อนกลับ
              </button>
              <button class="btn btn-sm btn-primary" id="btn-home-report">
                <i class="fas fa-home"></i> หน้าแรก
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div id="reportLocked" class="mb-4">
                <p class="small-muted">กรุณาใส่ Passcode เพื่อเข้าใช้งานเมนูรายงาน</p>
                <div class="d-flex gap-2 align-items-end">
                  <div class="flex-grow-1">
                    <label class="form-label">Passcode</label>
                    <input type="password" id="reportPass" class="form-control" placeholder="Passcode">
                  </div>
                  <button id="btnUnlock" class="btn btn-primary">
                    <i class="fas fa-lock-open"></i> Unlock
                  </button>
                </div>
                <div class="mt-2 small-muted">
                  (default demo passcode: <strong>2568</strong>)
                </div>
              </div>

              <div id="reportPanel" style="display:none;">
                <div class="filter-section">
                  <div class="filter-group">
                    <div class="filter-label">Region</div>
                    <select id="filter_report_region" class="form-select">
                      <option value="all">ทั้งหมด</option>
                      <option>RH1</option>
                      <option>RH2</option>
                      <option>RH3</option>
                      <option>RH4</option>
                      <option>RH5</option>
                    </select>
                  </div>
                  <div class="filter-group">
                    <div class="filter-label">วันที่เริ่ม</div>
                    <input type="date" id="filter_start_date" class="form-control">
                  </div>
                  <div class="filter-group">
                    <div class="filter-label">วันที่สิ้นสุด</div>
                    <input type="date" id="filter_end_date" class="form-control">
                  </div>
                  <button class="btn btn-secondary btn-sm" id="btnApplyFilters">
                    <i class="fas fa-filter"></i> Apply
                  </button>
                </div>

                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-number" id="kpi_total">0</div>
                    <div class="stat-label">Total Cases MTD</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="kpi_opp_count">0</div>
                    <div class="stat-label">New Opportunities MTD</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="kpi_opp_value">0</div>
                    <div class="stat-label">Est. Opportunity Value (MTD)</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="kpi_top_branch">-</div>
                    <div class="stat-label">Top Branch (cases)</div>
                  </div>
                </div>

                <div class="d-flex gap-2 mt-3">
                  <button id="btnExportAll" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-file-pdf"></i> Export All PDF
                  </button>
                  <button id="btnExportCSV" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-file-csv"></i> Export CSV
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="panel-admin" class="content-panel">
          <div class="page-header">
            <div class="page-title">
              <i class="fas fa-cog"></i> Admin / Audit
            </div>
            <div class="page-actions">
              <button class="btn btn-sm btn-secondary" id="btn-back-admin">
                <i class="fas fa-arrow-left"></i> ย้อนกลับ
              </button>
              <button class="btn btn-sm btn-primary" id="btn-home-admin">
                <i class="fas fa-home"></i> หน้าแรก
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <p class="small-muted mb-3">Audit log (view only) — บันทึกการสร้าง แก้ไข และ export</p>
              
              <div class="d-flex gap-2 mb-3">
                <button class="btn btn-sm btn-outline-primary" id="btnRefreshAudit">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="btnExportAudit">
                  <i class="fas fa-download"></i> Export Log
                </button>
              </div>
              
              <div id="auditList" class="small-muted"></div>
            </div>
          </div>
        </div>

        <!-- SETTINGS PANEL -->
        <div id="panel-settings" class="content-panel">
          <div class="page-header">
            <div class="page-title">
              <i class="fas fa-sliders-h"></i> ตั้งค่าระบบ
            </div>
            <div class="page-actions">
              <button class="btn btn-sm btn-secondary" id="btn-back-settings">
                <i class="fas fa-arrow-left"></i> ย้อนกลับ
              </button>
              <button class="btn btn-sm btn-primary" id="btn-home-settings">
                <i class="fas fa-home"></i> หน้าแรก
              </button>
            </div>
          </div>

          <div class="settings-grid">
            <!-- Security Settings -->
            <div class="setting-card">
              <div class="setting-title">
                <i class="fas fa-shield-alt"></i> การรักษาความปลอดภัย
              </div>
              <div class="setting-description">
                ตั้งค่ารหัสผ่านสำหรับการเข้าถึงระบบและฟังก์ชันต่างๆ
              </div>
              
              <div class="form-group">
                <label class="form-label">รหัสผ่านระบบหลัก</label>
                <div class="input-with-button">
                  <input type="password" id="systemPassInput" class="form-control" placeholder="รหัสผ่านระบบหลัก">
                  <button class="btn btn-outline-primary btn-sm" id="btnChangeSystemPass">เปลี่ยน</button>
                </div>
                <div class="small-muted mt-1">รหัสผ่านสำหรับเข้าสู่ระบบทั้งหมด</div>
              </div>
              
              <div class="form-group">
                <label class="form-label">รหัสผ่านรายงาน</label>
                <div class="input-with-button">
                  <input type="password" id="reportPassInput" class="form-control" placeholder="รหัสผ่านรายงาน">
                  <button class="btn btn-outline-primary btn-sm" id="btnChangeReportPass">เปลี่ยน</button>
                </div>
                <div class="small-muted mt-1">รหัสผ่านสำหรับเข้าถึงเมนูรายงาน</div>
              </div>
            </div>

            <!-- Data Management -->
            <div class="setting-card">
              <div class="setting-title">
                <i class="fas fa-database"></i> การจัดการข้อมูล
              </div>
              <div class="setting-description">
                การสำรองข้อมูลและการจัดการข้อมูลในระบบ
              </div>
              
              <div class="form-group">
                <button class="btn btn-outline-primary w-100 mb-2" id="btnExportAllData">
                  <i class="fas fa-download"></i> ส่งออกข้อมูลทั้งหมด
                </button>
                <div class="small-muted mb-3">ดาวน์โหลดข้อมูลทั้งหมดในรูปแบบ JSON</div>
                
                <button class="btn btn-outline-secondary w-100 mb-2" id="btnImportData">
                  <i class="fas fa-upload"></i> นำเข้าข้อมูล
                </button>
                <div class="small-muted">นำเข้าข้อมูลจากไฟล์ JSON</div>
              </div>
            </div>

            <!-- System Configuration -->
            <div class="setting-card">
              <div class="setting-title">
                <i class="fas fa-cogs"></i> การตั้งค่าระบบ
              </div>
              <div class="setting-description">
                การกำหนดค่าพื้นฐานของระบบ
              </div>
              
              <div class="form-group">
                <label class="form-label">จำนวนแถวต่อหน้า</label>
                <select id="pageSizeSelect" class="form-select">
                  <option value="10">10 แถว</option>
                  <option value="25">25 แถว</option>
                  <option value="50">50 แถว</option>
                  <option value="100">100 แถว</option>
                </select>
              </div>
              
              <div class="form-group">
                <label class="form-label">รูปแบบวันที่</label>
                <select id="dateFormatSelect" class="form-select">
                  <option value="th-TH">ไทย (DD/MM/YYYY)</option>
                  <option value="en-US">อเมริกัน (MM/DD/YYYY)</option>
                  <option value="en-GB">ยุโรป (DD/MM/YYYY)</option>
                </select>
              </div>
              
              <div class="form-group">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="autoSaveCheck">
                  <label class="form-check-label">บันทึกอัตโนมัติ</label>
                </div>
                <div class="small-muted">บันทึกข้อมูลอัตโนมัติทุก 5 นาที</div>
              </div>
            </div>

            <!-- Danger Zone -->
            <div class="setting-card danger-zone">
              <div class="setting-title text-danger">
                <i class="fas fa-exclamation-triangle"></i> โซนอันตราย
              </div>
              <div class="setting-description">
                การดำเนินการที่ไม่อาจย้อนกลับได้
              </div>
              
              <div class="form-group">
                <button class="btn btn-outline-danger w-100 mb-2" id="btnClearAllData">
                  <i class="fas fa-eraser"></i> ล้างข้อมูลทั้งหมด
                </button>
                <div class="small-muted text-danger mb-3">ลบข้อมูลลูกค้าและประวัติทั้งหมด</div>
                
                <button class="btn btn-danger w-100" id="btnResetSystem">
                  <i class="fas fa-trash-alt"></i> รีเซ็ตระบบทั้งหมด
                </button>
                <div class="small-muted text-danger">ล้างการตั้งค่าและข้อมูลทั้งหมด</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="watermark">Secure Account Planning System</div>
  </div>

  <script>
    /**************************************************************************
     * Enhanced Account Planning System with Security Features
     * Features: Loading screen, Login system, Settings panel, Admin security
     * Passcodes: System (2025), Reports (2568)
     **************************************************************************/

    // ---------- Constants and Utilities ----------
    const STORAGE_KEY = 'aps_customers';
    const AUDIT_KEY = 'aps_audit';
    const COUNTER_KEY = 'aps_counters';
    const SETTINGS_KEY = 'aps_settings';
    const DEFAULT_SYSTEM_PASS = '2025';
    const DEFAULT_REPORT_PASS = '2568';

    // DOM Helper
    const $ = (id) => document.getElementById(id);

    // System State
    let currentPanel = 'form';
    let reportUnlocked = false;
    let systemSettings = {};
    let tmpProducts = [];
    let tmpAttachments = [];

    // Date and Time Utilities
    function nowISO() {
      return new Date().toISOString();
    }

    function formatDateISOToLocalShort(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleString('th-TH', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    // ---------- Settings Management ----------
    function loadSettings() {
      try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (raw) {
          return JSON.parse(raw);
        } else {
          // Initialize default settings
          return {
            systemPassword: DEFAULT_SYSTEM_PASS,
            reportPassword: DEFAULT_REPORT_PASS,
            pageSize: 10,
            dateFormat: 'th-TH',
            autoSave: true
          };
        }
      } catch(e) { 
        console.error('Error loading settings:', e);
        return {};
      }
    }

    function saveSettings(settings) {
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      systemSettings = settings;
      updateSettingsUI();
    }

    function updateSettingsUI() {
      // Update settings form inputs
      if ($('systemPassInput')) $('systemPassInput').value = systemSettings.systemPassword || '';
      if ($('reportPassInput')) $('reportPassInput').value = systemSettings.reportPassword || '';
      if ($('pageSizeSelect')) $('pageSizeSelect').value = systemSettings.pageSize || '10';
      if ($('dateFormatSelect')) $('dateFormatSelect').value = systemSettings.dateFormat || 'th-TH';
      if ($('autoSaveCheck')) $('autoSaveCheck').checked = systemSettings.autoSave !== false;
    }

    // ---------- Data Management ----------
    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch(e) { 
        console.error('Error loading data:', e);
        return []; 
      }
    }

    function saveData(arr) { 
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); 
    }

    function loadAudit() {
      try { 
        return JSON.parse(localStorage.getItem(AUDIT_KEY) || '[]'); 
      } catch(e) { 
        console.error('Error loading audit:', e);
        return []; 
      }
    }

    function saveAudit(a) { 
      localStorage.setItem(AUDIT_KEY, JSON.stringify(a)); 
    }

    function appendAudit(action, entityId, performedBy, data = null) {
      const a = loadAudit();
      a.unshift({ 
        action, 
        entity: entityId, 
        performed_by: performedBy, 
        time: nowISO(), 
        data 
      });
      saveAudit(a);
      renderAuditList();
    }

    // Customer Code Generation
    function genCustomerCode() {
      const counters = JSON.parse(localStorage.getItem(COUNTER_KEY) || '{}');
      const dateKey = new Date().toISOString().slice(0,10).replace(/-/g,'');
      counters[dateKey] = (counters[dateKey] || 0) + 1;
      localStorage.setItem(COUNTER_KEY, JSON.stringify(counters));
      const seq = String(counters[dateKey]).padStart(4,'0');
      return `CUST${dateKey}-${seq}`;
    }

    // ---------- Loading Screen Management ----------
    function simulateLoading() {
      let progress = 0;
      const progressBar = $('loadingProgress');
      const enterBtn = $('enterBtn');
      
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          enterBtn.style.display = 'block';
        }
        progressBar.style.width = `${progress}%`;
      }, 300);
    }

    function showLoginScreen() {
      $('loadingScreen').style.opacity = '0';
      setTimeout(() => {
        $('loadingScreen').style.display = 'none';
        $('loginScreen').style.display = 'flex';
      }, 500);
    }

    function showMainApp() {
      $('loginScreen').style.display = 'none';
      $('appContainer').style.display = 'flex';
      
      // Initialize settings
      systemSettings = loadSettings();
      updateSettingsUI();
      
      // Initialize demo data if empty
      initDemoData();
      refreshList();
      renderAuditList();
      showPanel('form');
      
      // Initial render of product and attachment lists
      renderProdList();
      renderAttachList();
    }

    // ---------- Navigation Management ----------
    function showPanel(panelName) {
      // Hide all panels
      document.querySelectorAll('.content-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      
      // Remove active class from all menu items
      document.querySelectorAll('.nav-btn').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected panel and activate menu
      $(`panel-${panelName}`).classList.add('active');
      $(`tab-${panelName}`).classList.add('active');
      
      // Update current panel
      currentPanel = panelName;
      
      // Special handling for reports panel
      if (panelName === 'report' && !reportUnlocked) {
        $('reportLocked').style.display = 'block';
        $('reportPanel').style.display = 'none';
      } else if (panelName === 'report' && reportUnlocked) {
        $('reportLocked').style.display = 'none';
        $('reportPanel').style.display = 'block';
        renderReport();
      }
      
      // Refresh data if needed
      if (panelName === 'list') {
        refreshList();
      } else if (panelName === 'admin') {
        renderAuditList();
      }
    }

    function goHome() {
      showPanel('form');
    }

    function goBack() {
      showPanel('form');
    }

    function logout() {
      if (confirm('คุณต้องการออกจากระบบหรือไม่?')) {
        reportUnlocked = false;
        $('appContainer').style.display = 'none';
        $('loginScreen').style.display = 'flex';
        $('systemPassword').value = '';
      }
    }

    // ---------- Products Management ----------
    function renderProdList() {
      const container = $('prodList');
      container.innerHTML = tmpProducts.map((p, idx) => `
        <div class="d-flex align-items-center mb-2 p-2 border rounded" data-idx="${idx}">
          <div class="me-auto">
            <strong>${p.product_name || ''}</strong>
            <div class="small-muted">Sum: ${p.sum_assured || 0} | Premium: ${p.premium || 0}</div>
          </div>
          <button class="btn btn-sm btn-outline-danger" onclick="removeProd(${idx})">
            <i class="fas fa-trash"></i> ลบ
          </button>
        </div>
      `).join('') || '<div class="text-muted p-2 border rounded">ยังไม่มีผลิตภัณฑ์</div>';
    }

    function renderAttachList() {
      const container = $('attachList');
      container.innerHTML = tmpAttachments.map((f, idx) => `
        <div class="d-flex align-items-center mb-2 p-2 border rounded">
          <div class="me-auto small-muted">
            <i class="fas fa-file"></i> ${f.name} (${f.type})
          </div>
          <button class="btn btn-sm btn-outline-danger" onclick="removeAttach(${idx})">
            <i class="fas fa-trash"></i> ลบ
          </button>
        </div>
      `).join('') || '<div class="text-muted p-2 border rounded">ยังไม่มีไฟล์แนบ</div>';
    }

    // ---------- Form Management ----------
    function clearForm() {
      document.getElementById('customerForm').reset();
      tmpProducts = []; 
      tmpAttachments = [];
      renderProdList(); 
      renderAttachList();
      $('formStatus').textContent = '';
    }

    function validateForm() {
      const required = [
        ['employee_name', 'กรอกชื่อผู้กรอก'],
        ['employee_id', 'กรอก Employee ID'],
        ['branch', 'กรอก Branch'],
        ['cust_first', 'กรอกชื่อ'],
        ['cust_last', 'กรอกนามสกุล'],
        ['rh', 'เลือก RH']
      ];

      for (let [id, msg] of required) {
        const el = $(id);
        if (!el) continue;
        if (!el.value || el.value.trim() === '') {
          alert(msg);
          el.focus();
          return false;
        }
      }
      return true;
    }

    function saveCustomer() {
      if (!validateForm()) return;

      const createdBy = $('employee_id').value.trim();
      const empName = $('employee_name').value.trim();
      const branch = $('branch').value.trim();
      const zone = $('zone').value.trim();
      const rh = $('rh').value.trim();

      const customer = {
        customer_id: genCustomerCode(),
        first_name: $('cust_first').value.trim(),
        last_name: $('cust_last').value.trim(),
        phone: $('cust_phone').value.trim(),
        email: $('cust_email').value.trim(),
        address: $('cust_address').value.trim(),
        branch, 
        zone, 
        rh,
        products: [...tmpProducts],
        created_by: createdBy,
        created_by_name: empName,
        created_at: nowISO(),
        updated_at: nowISO()
      };

      const all = loadData();
      all.unshift(customer);
      saveData(all);
      
      appendAudit('create', customer.customer_id, createdBy, { 
        first_name: customer.first_name, 
        branch 
      });
      
      clearForm();
      $('formStatus').textContent = `บันทึกเรียบร้อย: ${customer.customer_id}`;
      alert(`บันทึกข้อมูลลูกค้า ${customer.customer_id} เรียบร้อยแล้ว`);
      
      refreshList();
      if (reportUnlocked) renderReport();
    }

    // ---------- List and Search Functionality ----------
    function renderTableRows(list) {
      const tbody = $('customerTbody');
      const countElement = $('searchResultsCount');
      
      countElement.textContent = `พบทั้งหมด ${list.length} รายการ`;
      
      tbody.innerHTML = list.map(c => `
        <tr>
          <td><input type="checkbox" class="rowSelect" data-id="${c.customer_id}"></td>
          <td><strong>${c.customer_id}</strong></td>
          <td>${c.first_name} ${c.last_name}</td>
          <td>${c.branch || '-'}</td>
          <td><span class="badge bg-primary">${c.rh || '-'}</span></td>
          <td>${c.created_by || '-'}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="viewDetail('${c.customer_id}')" title="View">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-outline-secondary" onclick="exportSinglePDF('${c.customer_id}')" title="PDF">
                <i class="fas fa-file-pdf"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="deleteRecord('${c.customer_id}')" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="7" class="text-center text-muted py-3">ไม่มีข้อมูลลูกค้า</td></tr>';
    }

    function refreshList() {
      const all = loadData();
      renderTableRows(all);
    }

    function searchCustomers() {
      const q = $('search_customer').value.trim().toLowerCase();
      const by = $('search_by_creator').value.trim().toLowerCase();
      const rh = $('filter_rh').value.trim();
      
      let all = loadData();
      
      if (q) {
        all = all.filter(c => 
          c.customer_id.toLowerCase().includes(q) || 
          (c.first_name + ' ' + c.last_name).toLowerCase().includes(q)
        );
      }
      
      if (by) {
        all = all.filter(c => 
          (c.created_by || '').toLowerCase().includes(by) || 
          (c.created_by_name || '').toLowerCase().includes(by)
        );
      }
      
      if (rh) {
        all = all.filter(c => (c.rh || '') === rh);
      }
      
      renderTableRows(all);
    }

    // ---------- PDF Export Functions ----------
    async function exportSinglePDF(customerId) {
      const all = loadData();
      const c = all.find(x => x.customer_id === customerId);
      if (!c) {
        alert('ไม่พบข้อมูลลูกค้า');
        return;
      }
      
      // Verify employee access
      const employeeId = prompt('กรุณากรอกรหัสพนักงานเพื่อยืนยันตัวตน:');
      if (!employeeId || employeeId.trim() !== c.created_by) {
        alert('รหัสพนักงานไม่ถูกต้อง');
        return;
      }
      
      await exportMultiplePDF([c]);
      appendAudit('export_pdf', customerId, 'local-user', null);
      alert(`Export PDF สำหรับ ${customerId} เรียบร้อยแล้ว`);
    }

    async function exportMultiplePDF(items) {
      if (!items || items.length === 0) {
        alert('ไม่มีข้อมูลสำหรับ export');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'px', format: 'a4' });
      
      for (let i = 0; i < items.length; i++) {
        const c = items[i];
        const wrapper = document.createElement('div');
        wrapper.style.width = '794px';
        wrapper.style.padding = '20px';
        wrapper.style.background = '#fff';
        wrapper.style.fontFamily = 'Arial, Helvetica, sans-serif';
        
        wrapper.innerHTML = `
          <div style="color:#111;">
            <h2 style="margin:0;color:#007AFF;">Customer Summary — ${c.customer_id}</h2>
            <div style="color:#666;margin-bottom:20px;">Generated: ${formatDateISOToLocalShort(nowISO())}</div>
            
            <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
              <h4 style="margin:0 0 10px 0;color:#333;">Basic Information</h4>
              <div><strong>Name:</strong> ${c.first_name} ${c.last_name}</div>
              <div><strong>Phone / Email:</strong> ${c.phone || '-'} / ${c.email || '-'}</div>
              <div><strong>Branch / Zone / RH:</strong> ${c.branch || '-'} / ${c.zone || '-'} / ${c.rh || '-'}</div>
            </div>
            
            <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
              <h4 style="margin:0 0 10px 0;color:#333;">Products</h4>
              <table style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr style="background:#e9ecef;">
                    <th style="text-align:left;padding:8px;">Name</th>
                    <th style="text-align:right;padding:8px;">Sum</th>
                    <th style="text-align:right;padding:8px;">Premium</th>
                  </tr>
                </thead>
                <tbody>
                  ${(c.products || []).map(p => `
                    <tr>
                      <td style="padding:8px;border-bottom:1px solid #dee2e6;">${p.product_name}</td>
                      <td style="text-align:right;padding:8px;border-bottom:1px solid #dee2e6;">${p.sum_assured || 0}</td>
                      <td style="text-align:right;padding:8px;border-bottom:1px solid #dee2e6;">${p.premium || 0}</td>
                    </tr>
                  `).join('') || '<tr><td colspan="3" style="padding:8px;text-align:center;">-</td></tr>'}
                </tbody>
              </table>
            </div>
            
            <div style="font-size:11px;color:#999;text-align:center;margin-top:30px;">
              Confidential — For internal use only. Exported by enhanced account planning system.
            </div>
          </div>
        `;
        
        document.body.appendChild(wrapper);
        
        try {
          const canvas = await html2canvas(wrapper, { 
            scale: 2, 
            useCORS: true, 
            backgroundColor: '#ffffff',
            logging: false
          });
          
          const imgData = canvas.toDataURL('image/png');
          const imgProps = doc.getImageProperties(imgData);
          const pdfWidth = doc.internal.pageSize.getWidth();
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
          
          doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
          if (i < items.length - 1) doc.addPage();
        } catch (error) {
          console.error('Error generating PDF:', error);
          alert('เกิดข้อผิดพลาดในการสร้าง PDF');
        } finally {
          document.body.removeChild(wrapper);
        }
      }
      
      doc.save(`APS_Export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')}.pdf`);
    }

    // ---------- Report and Dashboard Functions ----------
    function unlockReports() {
      const v = $('reportPass').value.trim();
      if (v === systemSettings.reportPassword) {
        reportUnlocked = true;
        $('reportLocked').style.display = 'none';
        $('reportPanel').style.display = 'block';
        appendAudit('report_unlock', 'report_panel', 'local-user', null);
        renderReport();
        alert('เข้าสู่ระบบรายงานเรียบร้อยแล้ว');
      } else {
        alert('Passcode ไม่ถูกต้อง');
      }
    }

    function isMTD(isoDate) {
      if (!isoDate) return false;
      const d = new Date(isoDate);
      const now = new Date();
      return d.getFullYear() === now.getFullYear() && 
             d.getMonth() === now.getMonth() && 
             d.getDate() <= now.getDate();
    }

    function renderReport() {
      if (!reportUnlocked) return;
      
      const region = $('filter_report_region').value;
      const startDate = $('filter_start_date').value;
      const endDate = $('filter_end_date').value;
      
      let all = loadData();
      
      // Apply filters
      if (region && region !== 'all') {
        all = all.filter(c => c.rh === region);
      }
      
      if (startDate && endDate) {
        all = all.filter(c => {
          const custDate = new Date(c.created_at);
          return custDate >= new Date(startDate) && custDate <= new Date(endDate);
        });
      }
      
      // Filter MTD for KPI
      const listMTD = all.filter(c => isMTD(c.created_at));
      
      // Update KPIs
      $('kpi_total').textContent = listMTD.length;
      
      // Top branch
      const branchCounts = {};
      listMTD.forEach(c => { 
        branchCounts[c.branch] = (branchCounts[c.branch] || 0) + 1; 
      });
      
      const topBranch = Object.entries(branchCounts).sort((a, b) => b[1] - a[1])[0];
      $('kpi_top_branch').textContent = topBranch ? `${topBranch[0]} (${topBranch[1]})` : '-';
    }

    // ---------- Admin and Audit Functions ----------
    function renderAuditList() {
      const a = loadAudit();
      const container = $('auditList');
      
      container.innerHTML = a.map(x => `
        <div class="border-bottom pb-2 mb-2">
          <div class="d-flex justify-content-between">
            <strong>${x.action}</strong>
            <small class="text-muted">${formatDateISOToLocalShort(x.time)}</small>
          </div>
          <div>Entity: ${x.entity} | โดย: ${x.performed_by}</div>
          ${x.data ? `<small class="text-muted">ข้อมูล: ${JSON.stringify(x.data)}</small>` : ''}
        </div>
      `).join('') || '<div class="text-muted text-center py-3">ยังไม่มีบันทึกการใช้งาน</div>';
    }

    // ---------- Settings Functions ----------
    function changeSystemPassword() {
      const newPass = $('systemPassInput').value.trim();
      if (!newPass) {
        alert('กรุณากรอกรหัสผ่านใหม่');
        return;
      }
      
      systemSettings.systemPassword = newPass;
      saveSettings(systemSettings);
      alert('เปลี่ยนรหัสผ่านระบบเรียบร้อยแล้ว');
    }

    function changeReportPassword() {
      const newPass = $('reportPassInput').value.trim();
      if (!newPass) {
        alert('กรุณากรอกรหัสผ่านใหม่');
        return;
      }
      
      systemSettings.reportPassword = newPass;
      saveSettings(systemSettings);
      alert('เปลี่ยนรหัสผ่านรายงานเรียบร้อยแล้ว');
    }

    function exportAllData() {
      const data = {
        customers: loadData(),
        audit: loadAudit(),
        settings: systemSettings,
        exportDate: nowISO()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `aps_backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      appendAudit('export_all_data', 'system', 'admin', null);
      alert('ส่งออกข้อมูลทั้งหมดเรียบร้อยแล้ว');
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = event => {
          try {
            const data = JSON.parse(event.target.result);
            
            if (data.customers) {
              saveData(data.customers);
            }
            if (data.audit) {
              saveAudit(data.audit);
            }
            if (data.settings) {
              saveSettings(data.settings);
            }
            
            refreshList();
            renderAuditList();
            alert('นำเข้าข้อมูลเรียบร้อยแล้ว');
            appendAudit('import_data', 'system', 'admin', null);
          } catch (error) {
            alert('ไฟล์ไม่ถูกต้องหรือเสียหาย');
          }
        };
        
        reader.readAsText(file);
      };
      
      input.click();
    }

    function clearAllData() {
      if (!confirm('คุณแน่ใจหรือไม่ที่จะล้างข้อมูลทั้งหมด? การกระทำนี้ไม่สามารถย้อนกลับได้!')) {
        return;
      }
      
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(AUDIT_KEY);
      localStorage.removeItem(COUNTER_KEY);
      
      refreshList();
      renderAuditList();
      if (reportUnlocked) renderReport();
      
      appendAudit('clear_all_data', 'system', 'admin', null);
      alert('ล้างข้อมูลทั้งหมดเรียบร้อยแล้ว');
    }

    function resetSystem() {
      if (!confirm('คุณแน่ใจหรือไม่ที่จะรีเซ็ตระบบทั้งหมด? การกระทำนี้จะลบข้อมูลและการตั้งค่าทั้งหมด!')) {
        return;
      }
      
      localStorage.clear();
      
      // Reload page to reset everything
      location.reload();
    }

    function updateSystemSettings() {
      systemSettings.pageSize = $('pageSizeSelect').value;
      systemSettings.dateFormat = $('dateFormatSelect').value;
      systemSettings.autoSave = $('autoSaveCheck').checked;
      
      saveSettings(systemSettings);
      alert('บันทึกการตั้งค่าระบบเรียบร้อยแล้ว');
    }

    // ---------- Demo Data Initialization ----------
    function initDemoData() {
      if (loadData().length === 0) {
        const demo = [
          { 
            customer_id: genCustomerCode(), 
            first_name: 'สมชาย', 
            last_name: 'ใจดี', 
            phone: '0811111111', 
            email: 's@example.com', 
            branch: 'Bangkok Central', 
            zone: 'Zone A', 
            rh: 'RH1', 
            products: [
              { product_name: 'ABC Life 20Y', sum_assured: 1000000, premium: 50000 }
            ], 
            created_by: 'BR1001', 
            created_by_name: 'Somchai', 
            created_at: nowISO(), 
            updated_at: nowISO()
          },
          { 
            customer_id: genCustomerCode(), 
            first_name: 'มาลี', 
            last_name: 'สมหวัง', 
            phone: '0822222222', 
            email: 'm@example.com', 
            branch: 'North Branch', 
            zone: 'Zone B', 
            rh: 'RH3', 
            products: [], 
            created_by: 'BR2002', 
            created_by_name: 'Malee', 
            created_at: nowISO(), 
            updated_at: nowISO()
          }
        ];
        saveData(demo);
      }
    }

    // ---------- Event Listeners and Initialization ----------
    document.addEventListener('DOMContentLoaded', function() {
      // Start loading simulation
      simulateLoading();
      
      // Enter button click
      $('enterBtn').addEventListener('click', showLoginScreen);
      
      // Login button click
      $('loginBtn').addEventListener('click', function() {
        const password = $('systemPassword').value.trim();
        if (password === systemSettings.systemPassword) {
          showMainApp();
        } else {
          alert('รหัสผ่านไม่ถูกต้อง');
        }
      });
      
      // Allow Enter key to submit login form
      $('systemPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          $('loginBtn').click();
        }
      });
      
      // Navigation event listeners
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const panel = this.getAttribute('data-panel');
          showPanel(panel);
        });
      });
      
      // Back and Home buttons for each panel
      document.querySelectorAll('[id^="btn-back-"]').forEach(btn => {
        btn.addEventListener('click', goBack);
      });
      
      document.querySelectorAll('[id^="btn-home-"]').forEach(btn => {
        btn.addEventListener('click', goHome);
      });
      
      // Logout button
      $('btn-logout').addEventListener('click', logout);
      
      // Form event listeners
      $('btnAddProd').addEventListener('click', () => {
        const name = $('prod_name').value.trim();
        const sum = Number($('prod_sum').value || 0);
        const prem = Number($('prod_premium').value || 0);
        
        if (!name) {
          alert('กรุณาใส่ชื่อผลิตภัณฑ์');
          return;
        }
        
        tmpProducts.push({ product_name: name, sum_assured: sum, premium: prem });
        $('prod_name').value = '';
        $('prod_sum').value = '';
        $('prod_premium').value = '';
        renderProdList();
      });
      
      $('file_attach').addEventListener('change', async (ev) => {
        const f = ev.target.files[0];
        if (!f) return;
        
        // Limit file size to 2MB for demo
        if (f.size > 2 * 1024 * 1024) {
          alert('ไฟล์ใหญ่เกิน 2MB (demo limit)');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = () => {
          tmpAttachments.push({ 
            name: f.name, 
            type: f.type, 
            dataUrl: reader.result 
          });
          renderAttachList();
        };
        reader.readAsDataURL(f);
        ev.target.value = '';
      });
      
      $('btnClear').addEventListener('click', clearForm);
      $('btnSave').addEventListener('click', saveCustomer);
      
      // List and search event listeners
      $('btnSearch').addEventListener('click', searchCustomers);
      $('btnRefresh').addEventListener('click', refreshList);
      $('btnBulkExport').addEventListener('click', async () => {
        const checks = Array.from(document.querySelectorAll('.rowSelect:checked'));
        if (!checks.length) {
          alert('เลือกอย่างน้อย 1 รายการเพื่อ export');
          return;
        }
        
        const ids = checks.map(ch => ch.dataset.id);
        const all = loadData();
        const items = all.filter(c => ids.includes(c.customer_id));
        
        await exportMultiplePDF(items);
        appendAudit('export_bulk_pdf', `bulk:${ids.join(',')}`, 'local-user', { 
          count: items.length 
        });
        
        alert(`Export PDF จำนวน ${items.length} รายการเรียบร้อยแล้ว`);
      });
      
      $('selectAll').addEventListener('change', (e) => {
        document.querySelectorAll('.rowSelect').forEach(cb => {
          cb.checked = e.target.checked;
        });
      });
      
      // Report event listeners
      $('btnUnlock').addEventListener('click', unlockReports);
      $('btnExportAll').addEventListener('click', async () => {
        const all = loadData();
        if (!all.length) {
          alert('ไม่มีข้อมูลสำหรับ export');
          return;
        }
        
        await exportMultiplePDF(all);
        appendAudit('export_all_pdf', 'all', 'local-user', { 
          count: all.length 
        });
        
        alert(`Export PDF ทั้งหมด ${all.length} รายการเรียบร้อยแล้ว`);
      });
      
      $('btnExportCSV').addEventListener('click', () => {
        const all = loadData();
        const rows = all.map(c => ({
          customer_id: c.customer_id,
          name: `${c.first_name} ${c.last_name}`,
          branch: c.branch,
          rh: c.rh,
          created_by: c.created_by,
          created_at: c.created_at
        }));
        
        const csv = [Object.keys(rows[0] || {}).join(',')]
          .concat(rows.map(r => 
            Object.values(r).map(v => 
              `"${String(v || '').replace(/"/g, '""')}"`
            ).join(','))
          ).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `aps_export_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        appendAudit('export_csv', 'all', 'local-user', { 
          count: rows.length 
        });
        
        alert('Export CSV เรียบร้อยแล้ว');
      });
      
      $('btnApplyFilters').addEventListener('click', renderReport);
      
      // Admin event listeners
      $('btnRefreshAudit').addEventListener('click', renderAuditList);
      $('btnExportAudit').addEventListener('click', () => {
        const audit = loadAudit();
        const csv = [['Action', 'Entity', 'Performed By', 'Time', 'Data'].join(',')]
          .concat(audit.map(a => 
            [a.action, a.entity, a.performed_by, a.time, JSON.stringify(a.data || '')]
              .map(v => `"${String(v || '').replace(/"/g, '""')}"`)
              .join(',')
          )).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `audit_log_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert('Export Audit Log เรียบร้อยแล้ว');
      });
      
      // Settings event listeners
      $('btnChangeSystemPass').addEventListener('click', changeSystemPassword);
      $('btnChangeReportPass').addEventListener('click', changeReportPassword);
      $('btnExportAllData').addEventListener('click', exportAllData);
      $('btnImportData').addEventListener('click', importData);
      $('btnClearAllData').addEventListener('click', clearAllData);
      $('btnResetSystem').addEventListener('click', resetSystem);
      
      // Settings change listeners
      $('pageSizeSelect').addEventListener('change', updateSystemSettings);
      $('dateFormatSelect').addEventListener('change', updateSystemSettings);
      $('autoSaveCheck').addEventListener('change', updateSystemSettings);
      
      // Check for select all functionality
      document.addEventListener('click', (e) => {
        if (e.target && e.target.matches('.rowSelect')) {
          const all = document.querySelectorAll('.rowSelect');
          const checked = Array.from(all).filter(cb => cb.checked).length;
          $('selectAll').checked = checked === all.length;
        }
      });

      // Load initial settings for login screen
      systemSettings = loadSettings();
    });

    // ---------- Global Functions for HTML onclick ----------
    window.removeProd = function(i) { 
      tmpProducts.splice(i, 1); 
      renderProdList(); 
    };
    
    window.removeAttach = function(i) { 
      tmpAttachments.splice(i, 1); 
      renderAttachList(); 
    };
    
    window.viewDetail = function(customerId) {
      const all = loadData();
      const c = all.find(x => x.customer_id === customerId);
      if (!c) {
        alert('ไม่พบข้อมูลลูกค้า');
        return;
      }
      
      const html = `
        <div class="container-fluid py-4">
          <h3>${c.first_name} ${c.last_name} (${c.customer_id})</h3>
          
          <div class="row mt-3">
            <div class="col-md-6">
              <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                  <i class="fas fa-info-circle"></i> ข้อมูลพื้นฐาน
                </div>
                <div class="card-body">
                  <p><strong>ชื่อ-นามสกุล:</strong> ${c.first_name} ${c.last_name}</p>
                  <p><strong>เบอร์โทร:</strong> ${c.phone || '-'}</p>
                  <p><strong>อีเมล:</strong> ${c.email || '-'}</p>
                  <p><strong>ที่อยู่:</strong> ${c.address || '-'}</p>
                  <p><strong>Branch/Zone/RH:</strong> ${c.branch || '-'} / ${c.zone || '-'} / ${c.rh || '-'}</p>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card mb-4">
                <div class="card-header bg-success text-white">
                  <i class="fas fa-boxes"></i> ผลิตภัณฑ์ที่มีอยู่
                </div>
                <div class="card-body">
                  ${(c.products || []).length > 0 
                    ? c.products.map(p => `
                        <div class="border-bottom pb-2 mb-2">
                          <strong>${p.product_name}</strong><br>
                          <small class="text-muted">Sum: ${p.sum_assured || 0} | Premium: ${p.premium || 0}</small>
                        </div>
                      `).join('')
                    : '<p class="text-muted">ไม่มีข้อมูลผลิตภัณฑ์</p>'
                  }
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-4 p-3 bg-light rounded">
            <small class="text-muted">
              สร้างโดย: ${c.created_by_name || c.created_by} | 
              วันที่สร้าง: ${formatDateISOToLocalShort(c.created_at)} | 
              อัปเดตล่าสุด: ${formatDateISOToLocalShort(c.updated_at)}
            </small>
          </div>
        </div>
      `;
      
      const w = window.open('', '_blank', 'width=1000,height=700');
      w.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Customer Detail - ${c.customer_id}</title>
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        </head>
        <body>
          ${html}
        </body>
        </html>
      `);
      w.document.close();
    };
    
    window.exportSinglePDF = exportSinglePDF;
    
    window.deleteRecord = function(customerId) {
      if (!confirm('ลบรายการนี้จริงหรือไม่?')) return;
      
      let all = loadData();
      const customer = all.find(c => c.customer_id === customerId);
      all = all.filter(x => x.customer_id !== customerId);
      saveData(all);
      
      appendAudit('delete', customerId, 'local-user', {
        customer_name: customer ? `${customer.first_name} ${customer.last_name}` : 'Unknown'
      });
      
      refreshList();
      if (reportUnlocked) renderReport();
      
      alert('ลบข้อมูลลูกค้าเรียบร้อยแล้ว');
    };
  </script>
</body>
</html>
