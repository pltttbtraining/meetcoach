<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Account Strategy Intelligence (ASI)</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary: #60A5FA;
      --primary-dark: #3B82F6;
      --secondary: #5856D6;
      --green: #34C759;
      --orange: #FF9500;
      --red: #FF3B30;
      --gray-1: #8E8E93;
      --gray-2: #AEAEB2;
      --gray-3: #C7C7CC;
      --gray-4: #D1D1D6;
      --gray-5: #E5E5EA;
      --gray-6: #F2F2F7;
      --background: #FFFFFF;
      --card-background: #FFFFFF;
      --text-primary: #000000;
      --text-secondary: #8E8E93;
      --system-blur: rgba(255, 255, 255, 0.8);
      --system-border: rgba(0, 0, 0, 0.1);
      --light-blue-bg: rgba(96, 165, 250, 0.05);
      --light-gray-bg: rgba(142, 142, 147, 0.05);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background: #000000;
        --card-background: #1C1C1E;
        --text-primary: #FFFFFF;
        --text-secondary: #8E8E93;
        --system-blur: rgba(30, 30, 32, 0.8);
        --system-border: rgba(255, 255, 255, 0.1);
        --light-blue-bg: rgba(96, 165, 250, 0.1);
        --light-gray-bg: rgba(142, 142, 147, 0.1);
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.47;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* iOS Style Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--background);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .loading-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      animation: logoPulse 2s ease-in-out infinite;
    }

    .loading-logo i {
      font-size: 32px;
      color: white;
    }

    .loading-text {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .loading-subtext {
      font-size: 17px;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .ios-progress {
      width: 200px;
      height: 4px;
      background: var(--gray-5);
      border-radius: 2px;
      overflow: hidden;
    }

    .ios-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      width: 0%;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 2px;
    }

    /* Main App Container */
    .app-container {
      min-height: 100vh;
      display: none;
      flex-direction: column;
      background: var(--background);
    }

    /* iOS Style Navigation Bar */
    .ios-navbar {
      background: var(--system-blur);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--system-border);
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .nav-brand {
      font-size: 21px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-brand-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-brand-icon i {
      font-size: 16px;
      color: white;
    }

    .nav-actions {
      display: flex;
      gap: 8px;
    }

    /* iOS Style Buttons */
    .ios-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
    }

    .ios-btn-primary {
      background: var(--primary);
      color: white;
    }

    .ios-btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .ios-btn-secondary {
      background: var(--gray-6);
      color: var(--text-primary);
    }

    .ios-btn-secondary:hover {
      background: var(--gray-5);
    }

    /* Content Area */
    .content-area {
      flex: 1;
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    /* iOS Style Cards */
    .ios-card {
      background: var(--card-background);
      border-radius: 12px;
      padding: 0;
      margin-bottom: 16px;
      border: 1px solid var(--system-border);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .ios-card-header {
      padding: 16px;
      border-bottom: 1px solid var(--system-border);
      background: var(--light-blue-bg);
    }

    .ios-card-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ios-card-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
    }

    .ios-card-body {
      padding: 16px;
    }

    /* iOS Style Form Elements */
    .form-section {
      margin-bottom: 24px;
      background: var(--light-gray-bg);
      border-radius: 10px;
      padding: 16px;
      border: 1px solid var(--system-border);
    }

    .section-header {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 12px;
      padding: 12px 16px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--light-blue-bg);
      border-radius: 8px;
      margin: -12px -12px 16px -12px;
    }

    .ios-input-group {
      margin-bottom: 16px;
    }

    .ios-label {
      display: block;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-primary);
      padding: 0 16px;
    }

    .ios-label.required::after {
      content: " *";
      color: var(--red);
    }

    .ios-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--card-background);
      border: 1px solid var(--system-border);
      border-radius: 10px;
      font-size: 16px;
      color: var(--text-primary);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ios-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
    }

    .ios-select {
      width: 100%;
      padding: 12px 16px;
      background: var(--card-background);
      border: 1px solid var(--system-border);
      border-radius: 10px;
      font-size: 16px;
      color: var(--text-primary);
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%238E8E93' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 10px;
    }

    /* Checkbox Styles */
    .unknown-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding: 0 16px;
    }

    .unknown-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 2px solid var(--gray-3);
      background: var(--card-background);
    }

    .unknown-checkbox label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Customer ID Display */
    .customer-id-display {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      font-weight: 600;
      font-size: 16px;
      display: none;
    }

    /* iOS Style Analysis Results */
    .analysis-section {
      margin-top: 24px;
    }

    .recommendation-grid {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    .recommendation-card {
      background: var(--card-background);
      border: 1px solid var(--system-border);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .recommendation-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .recommendation-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .recommendation-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .recommendation-badge {
      background: var(--primary);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }

    .recommendation-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .detail-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .detail-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .recommendation-reason {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* iOS Style Tabs */
    .ios-tabs {
      display: flex;
      background: var(--card-background);
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 20px;
      border: 1px solid var(--system-border);
    }

    .ios-tab {
      flex: 1;
      padding: 8px 12px;
      text-align: center;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ios-tab.active {
      background: var(--primary);
      color: white;
    }

    /* Form Status */
    .form-status {
      padding: 12px 16px;
      background: var(--green);
      color: white;
      border-radius: 10px;
      margin-top: 16px;
      font-size: 14px;
      display: none;
    }

    /* Content Panels */
    .content-panel {
      display: none;
    }

    .content-panel.active {
      display: block;
    }

    /* Animations */
    @keyframes logoPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .content-area {
        padding: 12px;
      }
      
      .nav-content {
        flex-direction: column;
        gap: 12px;
      }
      
      .recommendation-details {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Form Grid */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: var(--gray-6);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-3);
      border-radius: 2px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-2);
    }

    /* CSS สำหรับ urgency levels */
    .urgency-critical {
      border-left: 4px solid #FF3B30;
      background: linear-gradient(135deg, rgba(255, 59, 48, 0.05), rgba(255, 149, 0, 0.05));
    }

    .urgency-high {
      border-left: 4px solid #FF9500;
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.05), rgba(255, 204, 0, 0.05));
    }

    .urgency-medium {
      border-left: 4px solid #34C759;
      background: linear-gradient(135deg, rgba(52, 199, 89, 0.05), rgba(88, 86, 214, 0.05));
    }

    .urgency-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 4px;
      display: inline-block;
    }

    .urgency-badge.critical {
      background: #FF3B30;
      color: white;
    }

    .urgency-badge.high {
      background: #FF9500;
      color: white;
    }

    .urgency-badge.medium {
      background: #34C759;
      color: white;
    }

    .analysis-details {
      margin-top: 12px;
    }

    .detail-section {
      margin-bottom: 12px;
    }

    .detail-section .detail-label {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      font-size: 14px;
    }

    .detail-section .detail-value {
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.4;
    }

    .product-tag {
      display: inline-block;
      background: var(--primary);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      margin: 2px 4px 2px 0;
      font-size: 12px;
    }

    .customer-id-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .popup-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }

    .popup-content {
      position: relative;
      background: var(--card-background);
      border-radius: 16px;
      padding: 0;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--system-border);
    }

    .popup-header {
      padding: 20px 20px 0;
      text-align: center;
    }

    .popup-body {
      padding: 20px;
      text-align: center;
    }

    .customer-id-large {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      margin: 16px 0;
      padding: 16px;
      background: var(--light-blue-bg);
      border-radius: 12px;
      border: 2px dashed var(--primary);
    }

    .popup-footer {
      padding: 0 20px 20px;
      text-align: center;
    }

    /* Search and Filter Styles */
    .search-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .customer-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .customer-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--system-border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .customer-item:hover {
      background: var(--light-gray-bg);
    }

    .customer-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .customer-name {
      font-weight: 600;
      font-size: 16px;
    }

    .customer-id {
      color: var(--primary);
      font-size: 14px;
    }

    .customer-details {
      display: flex;
      gap: 12px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Security Modal */
    .security-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .security-content {
      background: var(--card-background);
      border-radius: 12px;
      padding: 20px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    /* Dashboard Styles */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--card-background);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--system-border);
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Chart Containers */
    .chart-container {
      position: relative;
      height: 200px;
      margin: 16px 0;
    }

    /* Policy Items */
    .policy-item {
      background: var(--card-background);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--system-border);
    }

    .btn-remove-policy {
      margin-top: 12px;
    }

    /* Portfolio Analysis */
    .portfolio-analysis {
      margin-top: 20px;
    }

    .analysis-item {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 4px solid var(--primary);
      background: var(--light-blue-bg);
    }

    .analysis-item.warning {
      border-left-color: var(--orange);
      background: rgba(255, 149, 0, 0.1);
    }

    .analysis-item.critical {
      border-left-color: var(--red);
      background: rgba(255, 59, 48, 0.1);
    }

    /* Export Options */
    .export-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    /* Data Management */
    .data-management {
      margin-top: 24px;
    }

    .delete-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .delete-warning {
      background: rgba(255, 59, 48, 0.1);
      border: 1px solid var(--red);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      font-size: 14px;
    }

    .spinner-border {
      width: 2rem;
      height: 2rem;
      border: 0.25em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spinner-border .75s linear infinite;
    }

    @keyframes spinner-border {
      to { transform: rotate(360deg); }
    }

    /* No Insurance Button */
    .no-insurance-btn {
      margin-top: 12px;
      width: 100%;
    }

    .search-placeholder {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .action-security {
      margin-top: 12px;
      padding: 12px;
      background: var(--light-gray-bg);
      border-radius: 8px;
      border: 1px solid var(--system-border);
    }
  </style>
</head>
<body>
  <!-- iOS Style Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">
      <i class="fas fa-brain"></i>
    </div>
    <h1 class="loading-text">RH5</h1>
    <p class="loading-subtext">Account Strategy Intelligence System</p>
    <div class="ios-progress">
      <div class="ios-progress-bar" id="loadingProgress"></div>
    </div>
  </div>

  <!-- Main Application -->
  <div class="app-container" id="appContainer">
    <!-- iOS Style Navigation Bar -->
    <nav class="ios-navbar">
      <div class="nav-content">
        <div class="nav-brand">
          <div class="nav-brand-icon">
            <i class="fas fa-brain"></i>
          </div>
          <span>[RH5] Account Strategy Intelligence (ASI)</span>
        </div>
        <div class="nav-actions">
          <button class="ios-btn ios-btn-secondary" id="btnLogout">
            <i class="fas fa-door-open"></i>
            Sign Out
          </button>
        </div>
      </div>
    </nav>

    <!-- Content Area -->
    <div class="content-area">
      <!-- iOS Style Tabs -->
      <div class="ios-tabs">
        <div class="ios-tab active" data-panel="start">
          <i class="fas fa-house"></i>
          หน้าแรก
        </div>
        <div class="ios-tab" data-panel="form">
          <i class="fas fa-user-plus"></i>
          สร้างลูกค้า
        </div>
        <div class="ios-tab" data-panel="search">
          <i class="fas fa-search"></i>
          ค้นหาข้อมูล
        </div>
        <div class="ios-tab" data-panel="report">
          <i class="fas fa-chart-bar"></i>
          รายงาน
        </div>
      </div>

      <!-- Start Panel -->
      <div id="panel-start" class="content-panel active fade-in">
        <div class="ios-card">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-rocket" style="color: var(--primary);"></i>
              ยินดีต้อนรับสู่ ASI
            </h2>
            <p class="ios-card-subtitle">ระบบวิเคราะห์และวางแผนกลยุทธ์ลูกค้าแบบบูรณาการ</p>
          </div>
          <div class="ios-card-body">
            <div style="text-align: center; padding: 40px 20px;">
              <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 24px;">
                <i class="fas fa-chart-network" style="font-size: 32px; color: white;"></i>
              </div>
              <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">เริ่มต้นใช้งานระบบ</h3>
              <p style="color: var(--text-secondary); margin-bottom: 32px;">ระบบ AI ขั้นสูงจะช่วยวิเคราะห์และแนะนำผลิตภัณฑ์ที่เหมาะสมที่สุดตามโปรไฟล์ลูกค้า</p>
              <button class="ios-btn ios-btn-primary" id="btnStart" style="padding: 12px 32px; font-size: 17px;">
                <i class="fas fa-play"></i>
                เริ่มต้นใช้งาน
              </button>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="dashboard-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalCustomers">0</div>
            <div class="stat-label">ลูกค้าทั้งหมด</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalAnalysis">0</div>
            <div class="stat-label">การวิเคราะห์</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="successRate">0%</div>
            <div class="stat-label">อัตราความสำเร็จ</div>
          </div>
        </div>
      </div>

      <!-- Form Panel -->
      <div id="panel-form" class="content-panel">
        <div class="ios-card">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-user-plus" style="color: var(--primary);"></i>
              สร้างโปรไฟล์ลูกค้า
            </h2>
            <p class="ios-card-subtitle">กรอกข้อมูลลูกค้าเพื่อรับการวิเคราะห์จาก AI</p>
          </div>
          <div class="ios-card-body">
            <!-- Customer ID Display -->
            <div class="customer-id-display" id="customerIdDisplay">
              <i class="fas fa-id-card"></i>
              Customer ID: กำลังสร้าง...
            </div>

            <!-- Employee Information -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-user-tie"></i>
                ข้อมูลพนักงาน
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">ชื่อพนักงาน</label>
                  <input type="text" class="ios-input" id="employee_name" placeholder="กรอกชื่อพนักงาน">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label required">รหัสพนักงาน</label>
                  <input type="text" class="ios-input" id="employee_id" placeholder="กรอกรหัสพนักงาน">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">ตำแหน่ง</label>
                  <select class="ios-select" id="employee_position">
                    <option value="">เลือกตำแหน่ง</option>
                    <option value="BM">BM</option>
                    <option value="Wealth">Wealth</option>
                    <option value="CISA">CISA</option>
                    <option value="CFSA">CFSA</option>
                    <option value="Yindee">Yindee</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label required">RH</label>
                  <select class="ios-select" id="rh">
                    <option value="">เลือก RH</option>
                    <option value="RH1">RH1</option>
                    <option value="RH2">RH2</option>
                    <option value="RH3">RH3</option>
                    <option value="RH4">RH4</option>
                    <option value="RH5">RH5</option>
                  </select>
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">Zone</label>
                  <select class="ios-select" id="zone" disabled>
                    <option value="">เลือก RH ก่อน</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Customer Personal Information -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-user"></i>
                ข้อมูลส่วนตัวลูกค้า
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">ชื่อนามสมมุติ</label>
                  <input type="text" class="ios-input" id="cust_name" placeholder="กรอกชื่อลูกค้า">
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_name_unknown">
                    <label for="cust_name_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label required">อายุ</label>
                  <input type="number" class="ios-input" id="cust_age" placeholder="กรอกอายุ">
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_age_unknown">
                    <label for="cust_age_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">เพศ</label>
                  <select class="ios-select" id="cust_gender">
                    <option value="">เลือกเพศ</option>
                    <option>ชาย</option>
                    <option>หญิง</option>
                    <option>อื่นๆ</option>
                  </select>
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_gender_unknown">
                    <label for="cust_gender_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label required">อาชีพ</label>
                  <select class="ios-select" id="cust_occupation">
                    <option value="">เลือกอาชีพ</option>
                    <option>พนักงานบริษัท</option>
                    <option>ข้าราชการ</option>
                    <option>เจ้าของกิจการ/ธุรกิจส่วนตัว</option>
                    <option>แพทย์</option>
                    <option>วิศวกร</option>
                    <option>ครู</option>
                    <option>นักกฎหมาย</option>
                    <option>อื่นๆ</option>
                  </select>
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_occupation_unknown">
                    <label for="cust_occupation_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">รายได้ต่อเดือน (บาท)</label>
                  <input type="number" class="ios-input" id="cust_monthly_income" placeholder="กรอกรายได้ต่อเดือน">
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_monthly_income_unknown">
                    <label for="cust_monthly_income_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">รายได้ต่อปี (บาท)</label>
                  <input type="text" class="ios-input" id="cust_yearly_income" readonly placeholder="คำนวณอัตโนมัติ">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">มีสวัสดิการหรือไม่</label>
                  <select class="ios-select" id="cust_welfare">
                    <option value="">เลือก</option>
                    <option>ไม่มี</option>
                    <option>มี - วงเงินสูง</option>
                    <option>มี - วงเงินกลาง</option>
                    <option>มี - วงเงินต่ำ</option>
                    <option>มี - ทุนประกันต่อปี</option>
                  </select>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">ทุนประกันต่อปี (บาท)</label>
                  <input type="number" class="ios-input" id="cust_insurance_capital" placeholder="กรอกทุนประกัน">
                </div>
              </div>
            </div>

            <!-- Family Information -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-users"></i>
                ข้อมูลครอบครัว
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">สถานภาพ</label>
                  <select class="ios-select" id="cust_marital_status">
                    <option value="">เลือกสถานภาพ</option>
                    <option>โสด</option>
                    <option>สมรส</option>
                    <option>หม้าย</option>
                    <option>หย่า</option>
                  </select>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">อายุคู่สมรส</label>
                  <input type="number" class="ios-input" id="cust_spouse_age" placeholder="กรอกอายุคู่สมรส">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">อาชีพคู่สมรส</label>
                  <select class="ios-select" id="cust_spouse_occupation">
                    <option value="">เลือกอาชีพ</option>
                    <option>ไม่มี</option>
                    <option>พนักงานบริษัท</option>
                    <option>ข้าราชการ</option>
                    <option>เจ้าของกิจการ/ธุรกิจส่วนตัว</option>
                    <option>แพทย์</option>
                    <option>วิศวกร</option>
                    <option>ครู</option>
                    <option>แม่บ้าน</option>
                    <option>อื่นๆ</option>
                  </select>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">มีบุตรหรือไม่</label>
                  <select class="ios-select" id="cust_has_children">
                    <option value="">เลือก</option>
                    <option>ไม่มี</option>
                    <option>มี</option>
                  </select>
                </div>
              </div>
              <div id="children-section" style="display: none;">
                <div class="form-grid">
                  <div class="ios-input-group">
                    <label class="ios-label">จำนวนบุตร</label>
                    <input type="number" class="ios-input" id="cust_children_count" placeholder="กรอกจำนวนบุตร">
                  </div>
                  <div class="ios-input-group">
                    <label class="ios-label">อายุบุตร</label>
                    <input type="text" class="ios-input" id="cust_children_ages" placeholder="เช่น 8,5,2">
                  </div>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">อาชีพบุตร</label>
                  <select class="ios-select" id="cust_children_occupation">
                    <option value="">เลือกอาชีพ</option>
                    <option>นักเรียน</option>
                    <option>นักศึกษา</option>
                    <option>พนักงานบริษัท</option>
                    <option>อื่นๆ</option>
                  </select>
                </div>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">มีบุคคลอื่นที่ต้องดูแลหรือไม่</label>
                <select class="ios-select" id="cust_has_dependents">
                  <option value="">เลือก</option>
                    <option>ไม่มี</option>
                    <option>มี</option>
                </select>
              </div>
              <div id="dependents-section" style="display: none;">
                <div class="ios-input-group">
                  <label class="ios-label">รายละเอียดบุคคลที่ต้องดูแล</label>
                  <textarea class="ios-input" id="cust_dependents_details" rows="3" placeholder="กรอกรายละเอียด"></textarea>
                </div>
              </div>
            </div>

            <!-- Business Information -->
            <div class="form-section" id="business-section" style="display: none;">
              <h3 class="section-header">
                <i class="fas fa-briefcase"></i>
                ข้อมูลธุรกิจ
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">ประเภทธุรกิจ/กิจการ</label>
                  <input type="text" class="ios-input" id="cust_business_type" placeholder="กรอกประเภทธุรกิจ">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">ทุนจดทะเบียน (บาท)</label>
                  <input type="number" class="ios-input" id="cust_business_capital" placeholder="กรอกทุนจดทะเบียน">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">รายได้ต่อปี (บาท)</label>
                  <input type="number" class="ios-input" id="cust_business_income" placeholder="กรอกรายได้ต่อปี">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">กำไร (บาท)</label>
                  <input type="number" class="ios-input" id="cust_business_profit" placeholder="กรอกกำไร">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">ภาษีที่เสียปีล่าสุด (บาท)</label>
                  <input type="number" class="ios-input" id="cust_business_tax" placeholder="กรอกภาษี">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">สัดส่วนหุ้นที่ถือครอง (%)</label>
                  <input type="number" class="ios-input" id="cust_business_share" placeholder="กรอกสัดส่วนหุ้น" min="0" max="100">
                </div>
              </div>
            </div>

            <!-- Financial Products -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-piggy-bank"></i>
                ผลิตภัณฑ์ทางการเงินที่ถือครอง
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">เงินฝากออมทรัพย์ (บาท)</label>
                  <input type="number" class="ios-input" id="prod_savings" placeholder="กรอกจำนวนเงิน">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">เงินฝากประจำ (บาท)</label>
                  <input type="number" class="ios-input" id="prod_fixed" placeholder="กรอกจำนวนเงิน">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">กองทุน (บาท)</label>
                  <input type="number" class="ios-input" id="prod_fund" placeholder="กรอกจำนวนเงิน">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">บัตรเครดิต (บาท)</label>
                  <input type="number" class="ios-input" id="prod_credit_card" placeholder="กรอกจำนวนเงิน">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">เงินกู้บ้าน (บาท)</label>
                  <input type="number" class="ios-input" id="prod_home_loan" placeholder="กรอกจำนวนเงิน">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">เงินกู้รถ (บาท)</label>
                  <input type="number" class="ios-input" id="prod_car_loan" placeholder="กรอกจำนวนเงิน">
                </div>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">เงินกู้ส่วนบุคคล (บาท)</label>
                <input type="number" class="ios-input" id="prod_personal_loan" placeholder="กรอกจำนวนเงิน">
              </div>
            </div>

            <!-- Insurance Policies Section -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-file-contract"></i>
                ข้อมูลประกันชีวิตที่มีอยู่
              </h3>
              <div id="insurance-policies-container">
                <!-- Policies will be added here dynamically -->
              </div>
              <div style="display: flex; gap: 12px; margin-top: 12px;">
                <button type="button" class="ios-btn ios-btn-secondary" id="btn-add-policy" style="flex: 1;">
                  <i class="fas fa-plus"></i>
                  เพิ่มกรมธรรม์
                </button>
                <button type="button" class="ios-btn ios-btn-secondary no-insurance-btn" id="btn-no-insurance" style="flex: 1;">
                  <i class="fas fa-times"></i>
                  ไม่มีประกันชีวิต
                </button>
              </div>
            </div>

            <!-- AI Analysis Section -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-robot"></i>
                AI Insurance Advisor
              </h3>
              <div style="text-align: center; padding: 20px;">
                <button class="ios-btn ios-btn-primary" id="btnAnalyze" style="padding: 16px 32px; font-size: 17px;" disabled>
                  <i class="fas fa-magic"></i>
                  วิเคราะห์ด้วย AI
                </button>
                <p style="color: var(--text-secondary); margin-top: 12px; font-size: 15px;">
                  ระบบจะวิเคราะห์ข้อมูลและแนะนำผลิตภัณฑ์ที่เหมาะสมที่สุด
                </p>
              </div>
            </div>

            <!-- Employee Comments -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-comments"></i>
                ความเห็นพนักงาน
              </h3>
              <div class="ios-input-group">
                <label class="ios-label">ความเห็นเพิ่มเติม</label>
                <textarea class="ios-input" id="emp_additional_comments" rows="3" placeholder="กรอกความเห็นเพิ่มเติม"></textarea>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">เคยนำเสนอผลิตภัณฑ์แล้วหรือไม่</label>
                <select class="ios-select" id="emp_presented_before">
                  <option value="">เลือก</option>
                  <option>ยังไม่เคยนำเสนอ</option>
                  <option>เคยนำเสนอแล้ว</option>
                  <option>เคยนำเสนอมากกว่า 3 ครั้ง</option>
                </select>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">ลูกค้าเคยโต้แย้งหรือมีความคิดเห็นอย่างไร</label>
                <textarea class="ios-input" id="emp_customer_feedback" rows="2" placeholder="กรอกความคิดเห็นลูกค้า"></textarea>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">ผลิตภัณฑ์ที่จะนำเสนอ</label>
                  <input type="text" class="ios-input" id="emp_proposed_product" placeholder="กรอกผลิตภัณฑ์">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">เบี้ยประกันที่คาดหวัง (บาท)</label>
                  <input type="number" class="ios-input" id="emp_proposed_premium" placeholder="กรอกเบี้ยประกัน">
                </div>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">ทุนประกันที่คาดหวัง (บาท)</label>
                <input type="number" class="ios-input" id="emp_proposed_capital" placeholder="กรอกทุนประกัน">
              </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button class="ios-btn ios-btn-secondary" id="btnClear" style="flex: 1;">
                <i class="fas fa-broom"></i>
                ล้างข้อมูล
              </button>
              <button class="ios-btn ios-btn-primary" id="btnSave" style="flex: 1;">
                <i class="fas fa-save"></i>
                บันทึกข้อมูล
              </button>
            </div>

            <!-- Form Status -->
            <div class="form-status" id="formStatus"></div>
          </div>
        </div>

        <!-- Analysis Results -->
        <div class="ios-card" id="analysisResults" style="display: none;">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-chart-line" style="color: var(--green);"></i>
              ผลการวิเคราะห์
            </h2>
            <p class="ios-card-subtitle">คำแนะนำจากระบบ AI Advisor</p>
          </div>
          <div class="ios-card-body">
            <div class="recommendation-grid" id="recommendationList">
              <!-- Recommendations will be inserted here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Search Panel -->
      <div id="panel-search" class="content-panel">
        <div class="ios-card">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-search" style="color: var(--primary);"></i>
              ค้นหาข้อมูลลูกค้า
            </h2>
          </div>
          <div class="ios-card-body">
            <!-- Search Filters -->
            <div class="search-filters">
              <div class="ios-input-group">
                <label class="ios-label">RH</label>
                <select class="ios-select" id="search_rh">
                  <option value="">ทั้งหมด</option>
                  <option value="RH1">RH1</option>
                  <option value="RH2">RH2</option>
                  <option value="RH3">RH3</option>
                  <option value="RH4">RH4</option>
                  <option value="RH5">RH5</option>
                </select>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">Zone</label>
                <select class="ios-select" id="search_zone">
                  <option value="">ทั้งหมด</option>
                </select>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">ชื่อพนักงาน</label>
                <input type="text" class="ios-input" id="search_employee_name" placeholder="ค้นหาชื่อพนักงาน">
              </div>
              <div class="ios-input-group">
                <label class="ios-label">รหัสพนักงาน</label>
                <input type="text" class="ios-input" id="search_employee_id" placeholder="ค้นหารหัสพนักงาน">
              </div>
              <div class="ios-input-group">
                <label class="ios-label">Customer ID</label>
                <input type="text" class="ios-input" id="search_customer_id" placeholder="ค้นหา Customer ID">
              </div>
            </div>

            <!-- Search Actions -->
            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
              <button class="ios-btn ios-btn-secondary" id="btnClearSearch" style="flex: 1;">
                <i class="fas fa-broom"></i>
                ล้างการค้นหา
              </button>
              <button class="ios-btn ios-btn-primary" id="btnSearch" style="flex: 1;">
                <i class="fas fa-search"></i>
                ค้นหา
              </button>
            </div>

            <!-- Customer List -->
            <div class="customer-list" id="customerList">
              <div class="search-placeholder">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; color: var(--gray-4);"></i>
                <p>กรุณาใช้ฟิลเตอร์ด้านบนเพื่อค้นหาข้อมูลลูกค้า</p>
                <small style="color: var(--text-secondary);">ระบบจะแสดงข้อมูลเฉพาะเมื่อค้นหาแล้วเท่านั้น</small>
              </div>
            </div>

            <!-- Portfolio Dashboard -->
            <div class="ios-card" style="margin-top: 20px; display: none;" id="portfolioDashboard">
              <div class="ios-card-header">
                <h2 class="ios-card-title">
                  <i class="fas fa-chart-pie" style="color: var(--primary);"></i>
                  แดชบอร์ดสรุปสัดส่วนการเงิน
                </h2>
              </div>
              <div class="ios-card-body">
                <div class="dashboard-grid">
                  <div class="stat-card">
                    <div class="chart-container">
                      <canvas id="insuranceTypeChart"></canvas>
                    </div>
                    <div class="stat-label">สัดส่วนประเภทประกัน</div>
                  </div>
                  
                  <div class="stat-card">
                    <div class="chart-container">
                      <canvas id="financialRatioChart"></canvas>
                    </div>
                    <div class="stat-label">สัดส่วนการเงิน</div>
                  </div>
                </div>

                <!-- Portfolio Analysis -->
                <div class="portfolio-analysis">
                  <h4 style="margin-bottom: 16px;">การวิเคราะห์พอร์ตประกัน</h4>
                  <div id="portfolio-analysis">
                    <!-- Analysis will be inserted here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Report Panel -->
      <div id="panel-report" class="content-panel">
        <div class="ios-card">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-chart-bar" style="color: var(--primary);"></i>
              รายงานและสถิติ
            </h2>
          </div>
          <div class="ios-card-body">
            <!-- Security Notice -->
            <div style="text-align: center; padding: 20px; background: var(--light-blue-bg); border-radius: 10px; margin-bottom: 20px;">
              <i class="fas fa-lock" style="font-size: 24px; color: var(--primary); margin-bottom: 8px;"></i>
              <p>เมนูนี้ต้องการการยืนยันตัวตนก่อนเข้าใช้งาน</p>
              <button class="ios-btn ios-btn-primary" id="btnAccessReport" style="margin-top: 12px;">
                <i class="fas fa-key"></i>
                ยืนยันตัวตน
              </button>
            </div>

            <!-- Report Content (Initially Hidden) -->
            <div id="reportContent" style="display: none;">
              <!-- Dashboard Stats -->
              <div class="dashboard-grid">
                <div class="stat-card">
                  <div class="stat-value" id="reportTotalCustomers">0</div>
                  <div class="stat-label">ลูกค้าทั้งหมด</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="reportMTD">0</div>
                  <div class="stat-label">ลูกค้าเดือนนี้</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="reportByRH">0</div>
                  <div class="stat-label">แยกตาม RH</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="reportByPosition">0</div>
                  <div class="stat-label">แยกตามตำแหน่ง</div>
                </div>
              </div>

              <!-- Export Options -->
              <div class="form-section">
                <h3 class="section-header">
                  <i class="fas fa-download"></i>
                  ส่งออกข้อมูล
                </h3>
                <div class="export-options">
                  <button class="ios-btn ios-btn-primary" id="btnExportPDF">
                    <i class="fas fa-file-pdf"></i>
                    Export PDF
                  </button>
                  <button class="ios-btn ios-btn-primary" id="btnExportExcel">
                    <i class="fas fa-file-excel"></i>
                    Export Excel
                  </button>
                </div>
              </div>

              <!-- Data Management -->
              <div class="data-management">
                <h3 class="section-header">
                  <i class="fas fa-database"></i>
                  การจัดการข้อมูล
                </h3>
                <div class="delete-options">
                  <button class="ios-btn ios-btn-secondary" id="btnDeleteSelected">
                    <i class="fas fa-trash"></i>
                    ลบข้อมูลที่เลือก
                  </button>
                  <button class="ios-btn ios-btn-secondary" id="btnDeleteLastMonth">
                    <i class="fas fa-calendar-minus"></i>
                    ลบข้อมูลเดือนล่าสุด
                  </button>
                  <button class="ios-btn ios-btn-secondary" id="btnDeleteOldest">
                    <i class="fas fa-history"></i>
                    ลบข้อมูลเก่าที่สุด
                  </button>
                  <button class="ios-btn ios-btn-secondary" id="btnDeleteAll">
                    <i class="fas fa-bomb"></i>
                    ลบข้อมูลทั้งหมด
                  </button>
                </div>
                <div class="delete-warning" id="deleteWarning" style="display: none;">
                  <i class="fas fa-exclamation-triangle"></i>
                  การลบข้อมูลไม่สามารถกู้คืนได้ กรุณายืนยันอีกครั้ง
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Security Modal -->
  <div class="security-modal" id="securityModal" style="display: none;">
    <div class="security-content">
      <h3 style="margin-bottom: 16px; text-align: center;">ยืนยันตัวตน</h3>
      <div class="ios-input-group">
        <label class="ios-label">รหัสผ่าน</label>
        <input type="password" class="ios-input" id="securityPassword" placeholder="กรอกรหัสผ่าน">
      </div>
      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button class="ios-btn ios-btn-secondary" id="btnCancelSecurity" style="flex: 1;">
          ยกเลิก
        </button>
        <button class="ios-btn ios-btn-primary" id="btnConfirmSecurity" style="flex: 1;">
          ยืนยัน
        </button>
      </div>
    </div>
  </div>

  <script>
    // =============================================
    // System Configuration
    // =============================================
    const STORAGE_KEY = 'asi_customers';
    const AUDIT_KEY = 'asi_audit';
    const COUNTER_KEY = 'asi_counters';

    // Security Passcodes
    const REPORT_PASSCODE = "2025";
    const EXPORT_PASSCODE = "1234";
    const SPECIAL_PASSCODE = "0229"; // Special pass code สำหรับปลดล็อคทุกอย่าง

    // Supabase Configuration
    const supabaseUrl = 'https://ycyrvyghiybfaimixkvo.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljeXJ2eWdoaXliZmFpbWl4a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwOTM5NTcsImV4cCI6MjA3ODY2OTk1N30.cX90v29O1uxtjlv3ykCasej9KIlh-bmPcCmsoGRyMVo';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // DOM Helper
    const $ = (id) => document.getElementById(id);

    // System State
    let currentPanel = 'start';
    let currentCustomerId = '';
    let selectedCustomer = null;
    let customersData = [];
    let policyCount = 0;
    let hasInsurancePolicies = true; // Track if user has insurance policies

    // =============================================
    // Enhanced Insurance Advisor Classes
    // =============================================

    class ComprehensiveRiskAnalyzer {
      constructor() {
        this.riskCategories = this.initializeRiskCategories();
        this.urgencyIcons = {
          critical: '🚨',
          high: '⚠️', 
          medium: 'ℹ️',
          low: '💡'
        };
      }

      initializeRiskCategories() {
        return [
          {
            id: 'income_risk',
            name: 'ความเสี่ยงรายได้หลัก',
            analyzer: this.analyzeIncomeRisk.bind(this),
            urgency: 'critical',
            icon: '🚨'
          },
          {
            id: 'inflation_risk',
            name: 'ความเสี่ยงเงินฝากและเงินเฟ้อ',
            analyzer: this.analyzeInflationRisk.bind(this),
            urgency: 'high',
            icon: '⚠️'
          },
          {
            id: 'lifecycle_risk',
            name: 'ความเสี่ยงตามช่วงอายุ',
            analyzer: this.analyzeLifecycleRisk.bind(this),
            urgency: 'medium',
            icon: 'ℹ️'
          },
          {
            id: 'health_risk',
            name: 'ความเสี่ยงด้านสุขภาพตามอาชีพ',
            analyzer: this.analyzeHealthRisk.bind(this),
            urgency: 'high',
            icon: '⚠️'
          },
          {
            id: 'education_risk',
            name: 'ความเสี่ยงการศึกษาบุตร',
            analyzer: this.analyzeEducationRisk.bind(this),
            urgency: 'medium',
            icon: 'ℹ️'
          },
          {
            id: 'business_risk',
            name: 'ความเสี่ยงการส่งต่อธุรกิจ',
            analyzer: this.analyzeBusinessRisk.bind(this),
            urgency: 'critical',
            icon: '🚨'
          },
          {
            id: 'debt_risk',
            name: 'ความเสี่ยงจากหนี้สิน',
            analyzer: this.analyzeDebtRisk.bind(this),
            urgency: 'high',
            icon: '⚠️'
          },
          {
            id: 'investment_risk',
            name: 'ความเสี่ยงการลงทุนไม่หลากหลาย',
            analyzer: this.analyzeInvestmentRisk.bind(this),
            urgency: 'medium',
            icon: 'ℹ️'
          },
          {
            id: 'liquidity_risk',
            name: 'ความเสี่ยงสภาพคล่องจากเบี้ยประกัน',
            analyzer: this.analyzeLiquidityRisk.bind(this),
            urgency: 'high',
            icon: '⚠️'
          },
          {
            id: 'portfolio_risk',
            name: 'ความเสี่ยงการกระจุกตัวพอร์ตประกัน',
            analyzer: this.analyzePortfolioRisk.bind(this),
            urgency: 'medium',
            icon: 'ℹ️'
          }
        ];
      }

      analyzeIncomeRisk(customer) {
        const { marital_status, spouse_occupation, has_children, children_count, monthly_income } = customer;
        const isBreadwinner = spouse_occupation === 'ไม่มี' || spouse_occupation === 'แม่บ้าน';
        const hasSchoolChildren = has_children === 'มี' && children_count > 0;
        const hasDependents = customer.has_dependents === 'มี';

        if ((isBreadwinner && hasSchoolChildren) || (isBreadwinner && hasDependents)) {
          const dependentsText = hasSchoolChildren ? `และมีบุตร ${children_count} คนที่ต้องดูแล` : 
                               hasDependents ? 'และมีบุคคลอื่นที่ต้องดูแล' : '';
          
          return {
            category: 'income_risk',
            name: 'ความเสี่ยงรายได้หลัก',
            urgency: 'critical',
            icon: '🚨',
            analysis: {
              why: `คุณเป็นเสาหลักรายได้เดียวของครอบครัว ${dependentsText} หากเกิดเหตุไม่คาดฝันจะส่งผลกระทบร้ายแรงต่อครอบครัว`,
              recommendedProducts: [
                'ประกันชีวิตแบบชั่วระยะเวลา (Term Life)',
                'ประกันทุพพลภาพ (Disability Insurance)',
                'ประกันรายได้ครอบครัว (Income Protection)'
              ],
              benefits: [
                'คุ้มครองรายได้หลักของครอบครัว',
                'รับประกันการศึกษาบุตรต่อเนื่อง',
                'รักษามาตรฐานการครองชีพของครอบครัว'
              ]
            }
          };
        }
        
        // เพิ่มการวิเคราะห์สำหรับผู้มีรายได้สูงแต่ไม่มีผู้พึ่งพา
        if (monthly_income > 100000 && has_children === 'ไม่มี' && !hasDependents) {
          return {
            category: 'income_risk',
            name: 'ความเสี่ยงรายได้สูง',
            urgency: 'medium',
            icon: 'ℹ️',
            analysis: {
              why: `มีรายได้สูง (${monthly_income.toLocaleString()} บาท/เดือน) แต่ยังไม่มีแผนการคุ้มครองรายได้ที่เหมาะสม`,
              recommendedProducts: [
                'ประกันชีวิตแบบสะสมทรัพย์',
                'ประกันสุขภาพวงเงินสูง',
                'ประกันโรคร้ายแรง'
              ],
              benefits: [
                'คุ้มครองศักยภาพการสร้างรายได้ในอนาคต',
                'สร้างความมั่นคงทางการเงินส่วนบุคคล',
                'วางรากฐานการเงินก่อนสร้างครอบครัว'
              ]
            }
          };
        }
        
        return null;
      }

      analyzeInflationRisk(customer) {
        const { monthly_income, financial_products, age } = customer;
        const savings = financial_products?.savings || 0;
        const fixedDeposits = financial_products?.fixed || 0;
        const totalDeposits = savings + fixedDeposits;
        const yearlyIncome = monthly_income * 12;
        
        if (yearlyIncome > 0) {
          const depositRatio = totalDeposits / yearlyIncome;
          
          if (depositRatio > 5) {
            return {
              category: 'inflation_risk',
              name: 'ความเสี่ยงเงินฝากและเงินเฟ้อ',
              urgency: 'high',
              icon: '⚠️',
              analysis: {
                why: `มีเงินฝากสูงถึง ${(depositRatio).toFixed(1)} เท่าของรายได้ต่อปี (${totalDeposits.toLocaleString()} บาท) กำลังถูกเงินเฟ้อกัดกร่อนมูลค่าปีละ 2-3%`,
                recommendedProducts: [
                  'ประกันชีวิตแบบสะสมทรัพย์ (Endowment)',
                  'กองทุนรวม LTF/RMF',
                  'ประกันบำนาญ (Pension Plan)'
                ],
                benefits: [
                  'ป้องกันการสูญเสียมูลค่าจากเงินเฟ้อ',
                  'ได้ผลตอบแทนสูงกว่าเงินฝาก 3-5% ต่อปี',
                  'ลดหย่อนภาษีได้ตามกฎหมาย'
                ]
              }
            };
          }
          
          // เพิ่มการวิเคราะห์สำหรับผู้ที่มีเงินฝากน้อยเกินไป
          if (depositRatio < 0.5 && age >= 30) {
            return {
              category: 'inflation_risk',
              name: 'ความเสี่ยงเงินออมไม่เพียงพอ',
              urgency: 'medium',
              icon: 'ℹ️',
              analysis: {
                why: `มีเงินออมเพียง ${(depositRatio * 100).toFixed(0)}% ของรายได้ต่อปี ซึ่งต่ำกว่าเกณฑ์ที่แนะนำ (อย่างน้อย 6 เดือนของรายได้)`,
                recommendedProducts: [
                  'ประกันชีวิตแบบสะสมทรัพย์',
                  'ประกันบำนาญ',
                  'กองทุนรวมเพื่อการออม'
                ],
                benefits: [
                  'สร้างวินัยการออมอย่างสม่ำเสมอ',
                  'ได้ผลตอบแทนที่ดีกว่าอัตราเงินเฟ้อ',
                  'เตรียมความพร้อมทางการเงินสำหรับอนาคต'
                ]
              }
            };
          }
        }
        return null;
      }

      analyzeLifecycleRisk(customer) {
        const { age, marital_status, has_children, monthly_income, occupation } = customer;
        let lifeStage = '';
        let recommendations = [];
        let reasoning = '';

        if (age <= 25) {
          lifeStage = 'วัยเริ่มทำงาน';
          recommendations = [
            'ประกันชีวิตแบบสะสมทรัพย์',
            'ประกันอุบัติเหตุส่วนบุคคล',
            'ประกันสุขภาพ IPD/OPD'
          ];
          reasoning = `อายุ ${age} ปี อยู่ในวัยเริ่มทำงาน ควรเริ่มสร้างนิสัยการออมและความคุ้มครองพื้นฐาน`;
        } else if (age <= 35) {
          lifeStage = 'วัยสร้างตัว';
          recommendations = [
            'ประกันชีวิตแบบสะสมทรัพย์',
            'ประกันโรคร้ายแรง',
            'ประกันสุขภาพวงเงินสูง'
          ];
          
          // ตรวจสอบเงื่อนไขการมีบุตรก่อนแนะนำประกันการศึกษา
          if (has_children === 'มี') {
            recommendations.push('ประกันการศึกษา');
            reasoning = `อายุ ${age} ปี ${marital_status === 'สมรส' ? 'สมรส' : 'โสด'} ${has_children === 'มี' ? 'มีบุตร' : 'ไม่มีบุตร'} ควรวางแผนการเงินสำหรับครอบครัวและอนาคต`;
          } else {
            reasoning = `อายุ ${age} ปี ${marital_status === 'สมรส' ? 'สมรส' : 'โสด'} ยังไม่มีบุตร ควรเน้นการออมและคุ้มครองรายได้`;
          }
          
        } else if (age <= 45) {
          lifeStage = 'วัยสร้างครอบครัว';
          recommendations = [
            'ประกันชีวิตระยะยาว',
            'ประกันโรคร้ายแรง',
            'ประกันสุขภาพระยะยาว'
          ];
          
          // ตรวจสอบเงื่อนไขการมีบุตรก่อนแนะนำประกันการศึกษา
          if (has_children === 'มี') {
            recommendations.push('ประกันการศึกษา');
            reasoning = `อายุ ${age} ปี ${marital_status === 'สมรส' ? 'สมรส' : 'โสด'} ${has_children === 'มี' ? 'มีบุตร' : 'ไม่มีบุตร'} อยู่ในช่วงสำคัญของการสร้างครอบครัวและวางแผนการศึกษาบุตร`;
          } else {
            recommendations.push('ประกันบำนาญ');
            reasoning = `อายุ ${age} ปี ${marital_status === 'สมรส' ? 'สมรส' : 'โสด'} ยังไม่มีบุตร ควรเร่งวางแผนการออมเพื่อการเกษียณ`;
          }
          
        } else if (age <= 55) {
          lifeStage = 'วัยใกล้เกษียณ';
          recommendations = [
            'ประกันบำนาญ',
            'ประกันสุขภาพระยะยาว',
            'ประกันโรคร้ายแรง'
          ];
          reasoning = `อายุ ${age} ปี เหลือเวลาอีก ${60 - age} ปีก่อนเกษียณ ควรเร่งสะสมเงินออมและคุ้มครองสุขภาพ`;
        } else {
          lifeStage = 'วัยเกษียณ';
          recommendations = [
            'ประกันสุขภาพระยะยาว',
            'ประกันโรคร้ายแรง',
            'ประกันตลอดชีพ'
          ];
          reasoning = `อายุ ${age} ปี อยู่ในวัยเกษียณ ควรเน้นความคุ้มครองสุขภาพและรายได้มั่นคง`;
        }

        // เพิ่มผลิตภัณฑ์ตามอาชีพและรายได้
        if (monthly_income > 50000 && age <= 50) {
          recommendations.push('ประกันชีวิตแบบมีกองทุน');
        }

        return {
          category: 'lifecycle_risk',
          name: 'ความเสี่ยงตามช่วงอายุ',
          urgency: 'medium',
          icon: 'ℹ️',
          analysis: {
            why: reasoning,
            recommendedProducts: recommendations,
            benefits: [
              'วางแผนการเงินที่เหมาะสมกับช่วงวัย',
              'สร้างวินัยการออมระยะยาว',
              'เตรียมความพร้อมสำหรับชีวิตในอนาคต'
            ]
          }
        };
      }

      analyzeHealthRisk(customer) {
        const { occupation, age, monthly_income, marital_status, has_children } = customer;
        const highRiskOccupations = ['แพทย์', 'พยาบาล', 'วิศวกร', 'เจ้าของกิจการ/ธุรกิจส่วนตัว'];
        const highStressOccupations = ['นักกฎหมาย', 'ผู้จัดการ', 'ธนาคาร'];
        
        let riskLevel = 'medium';
        let reasoning = '';
        let recommendedProducts = [
          'ประกันสุขภาพวงเงินสูง',
          'ประกันโรคร้ายแรง'
        ];

        if (highRiskOccupations.includes(occupation)) {
          riskLevel = 'high';
          reasoning = `อาชีพ ${occupation} มีความเสี่ยงด้านสุขภาพและอุบัติเหตุสูงกว่าอาชีพอื่น`;
          recommendedProducts.push('ประกันอุบัติเหตุกลุ่ม');
        } else if (highStressOccupations.includes(occupation)) {
          riskLevel = 'medium';
          reasoning = `อาชีพ ${occupation} มีความเครียดสะสมและเสี่ยงต่อโรคเรื้อรัง`;
          recommendedProducts.push('ประกันสุขภาพจิต');
        } else {
          reasoning = `อายุ ${age} ปี ควรมีแผนคุ้มครองสุขภาพที่เหมาะสม`;
        }

        // พิจารณาภาระครอบครัว
        if ((marital_status === 'สมรส' || has_children === 'มี') && monthly_income > 30000) {
          recommendedProducts.push('ประกันสุขภาพครอบครัว');
          reasoning += ` ${has_children === 'มี' ? 'และมีบุตรที่ต้องดูแล' : 'และมีครอบครัวที่ต้องดูแล'} ควรพิจารณาความคุ้มครองสุขภาพสำหรับทุกคนในครอบครัว`;
        }

        // พิจารณาอายุ
        if (age >= 40) {
          recommendedProducts.push('ประกันโรคมะเร็ง');
          reasoning += ` อายุมากขึ้นมีความเสี่ยงโรคเรื้อรังเพิ่มขึ้น`;
        }

        return {
          category: 'health_risk',
          name: 'ความเสี่ยงด้านสุขภาพตามอาชีพ',
          urgency: riskLevel,
          icon: riskLevel === 'high' ? '⚠️' : 'ℹ️',
          analysis: {
            why: reasoning,
            recommendedProducts: recommendedProducts,
            benefits: [
              'คุ้มครองค่ารักษาพยาบาลสูง',
              'รับเงินชดเชยเมื่อป่วยเป็นโรคเรื้อรัง',
              'คุ้มครองชีวิตและทุพพลภาพจากอุบัติเหตุ'
            ]
          }
        };
      }

      analyzeEducationRisk(customer) {
        const { has_children, children_count, children_ages, monthly_income, age } = customer;
        
        // ตรวจสอบเงื่อนไขการมีบุตรก่อนวิเคราะห์ความเสี่ยงการศึกษา
        if (has_children !== 'มี' || !children_count || children_count === 0) {
          return null; // ไม่แนะนำประกันการศึกษาหากไม่มีบุตร
        }
        
        const ages = children_ages ? children_ages.split(',').map(age => parseInt(age.trim())) : [];
        const yearsToUni = ages.map(age => 18 - age).filter(years => years > 0);
        
        if (yearsToUni.length > 0) {
          const minYears = Math.min(...yearsToUni);
          const educationCost = 1000000 * children_count;
          const urgency = minYears <= 5 ? 'high' : 'medium';
          
          return {
            category: 'education_risk',
            name: 'ความเสี่ยงการศึกษาบุตร',
            urgency: urgency,
            icon: urgency === 'high' ? '⚠️' : 'ℹ️',
            analysis: {
              why: `มีบุตร ${children_count} คน ที่จะเข้าเรียนมหาวิทยาลัยในอีก ${minYears} ปี ต้องการทุนการศึกษารวมประมาณ ${educationCost.toLocaleString()} บาท`,
              recommendedProducts: [
                'ประกันการศึกษา',
                'ประกันชีวิตแบบสะสมทรัพย์',
                'กองทุนการศึกษา'
              ],
              benefits: [
                'รับประกันทุนการศึกษาเมื่อถึงเวลาที่กำหนด',
                'ได้เงินคืนหากบุตรไม่ใช้ทุนการศึกษา',
                'คุ้มครองชีวิตผู้ปกครองระหว่างการออม'
              ]
            }
          };
        }
        
        // กรณีบุตรอายุมากกว่า 18 ปีแล้ว
        if (ages.length > 0 && Math.max(...ages) >= 18) {
          return {
            category: 'education_risk',
            name: 'ความเสี่ยงการศึกษาบุตรในระดับสูง',
            urgency: 'medium',
            icon: 'ℹ️',
            analysis: {
              why: `มีบุตรในวัยศึกษาต่อในระดับอุดมศึกษา ต้องการการสนับสนุนทางการเงิน`,
              recommendedProducts: [
                'ประกันชีวิตแบบสะสมทรัพย์',
                'กองทุนรวมเพื่อการศึกษา',
                'ประกันสุขภาพนักศึกษา'
              ],
              benefits: [
                'สนับสนุนค่าเล่าเรียนในระดับอุดมศึกษา',
                'คุ้มครองสุขภาพบุตรระหว่างศึกษา',
                'สร้างความมั่นคงทางการเงินสำหรับครอบครัว'
              ]
            }
          };
        }
        
        return null;
      }

      analyzeBusinessRisk(customer) {
        const { occupation, business_capital, age, monthly_income, marital_status, has_children } = customer;
        
        if (occupation === 'เจ้าของกิจการ/ธุรกิจส่วนตัว' && business_capital > 0) {
          const hasFamily = marital_status === 'สมรส' || has_children === 'มี';
          const urgency = business_capital > 10000000 ? 'critical' : 'high';
          
          return {
            category: 'business_risk',
            name: 'ความเสี่ยงการส่งต่อธุรกิจ',
            urgency: urgency,
            icon: '🚨',
            analysis: {
              why: `เป็นเจ้าของธุรกิจที่มีมูลค่าประมาณ ${business_capital.toLocaleString()} บาท และอายุ ${age} ปี ${hasFamily ? 'มีครอบครัวที่ต้องดูแล' : ''} ต้องการแผนการส่งต่อธุรกิจและจัดการภาษีมรดก`,
              recommendedProducts: [
                'ประกันชีวิตเพื่อการส่งต่อธุรกิจ',
                'Trust Planning',
                'ประกันตลอดชีพ'
              ],
              benefits: [
                'มีเงินสดสำหรับจ่ายภาษีมรดก',
                'ส่งต่อธุรกิจให้ทายาทได้ราบรื่น',
                'ป้องกันความขัดแย้งในครอบครัว'
              ]
            }
          };
        }
        
        // เพิ่มการวิเคราะห์สำหรับผู้มีรายได้สูงที่อาจเริ่มธุรกิจ
        if (monthly_income > 80000 && age <= 45 && occupation !== 'เจ้าของกิจการ/ธุรกิจส่วนตัว') {
          return {
            category: 'business_risk',
            name: 'ความเสี่ยงการเริ่มธุรกิจ',
            urgency: 'medium',
            icon: 'ℹ️',
            analysis: {
              why: `มีรายได้สูงและอยู่ในวัยที่เหมาะสมสำหรับการเริ่มธุรกิจ ควรมีแผนคุ้มครองทางการเงิน`,
              recommendedProducts: [
                'ประกันชีวิตแบบสะสมทรัพย์',
                'ประกันทุพพลภาพ',
                'ประกันสุขภาพวงเงินสูง'
              ],
              benefits: [
                'สร้างหลักประกันทางการเงินก่อนเริ่มธุรกิจ',
                'คุ้มครองรายได้หากไม่สามารถทำงานได้',
                'มีเงินทุนสำรองสำหรับโอกาสทางธุรกิจ'
              ]
            }
          };
        }
        
        return null;
      }

      analyzeDebtRisk(customer) {
        const { monthly_income, financial_products, age, marital_status, has_children } = customer;
        const homeLoan = financial_products?.home_loan || 0;
        const carLoan = financial_products?.car_loan || 0;
        const personalLoan = financial_products?.personal_loan || 0;
        const creditCard = financial_products?.credit_card || 0;
        const totalDebt = homeLoan + carLoan + personalLoan + creditCard;
        const yearlyIncome = monthly_income * 12;
        
        if (yearlyIncome > 0) {
          const debtRatio = totalDebt / yearlyIncome;
          
          if (debtRatio > 3) {
            return {
              category: 'debt_risk',
              name: 'ความเสี่ยงจากหนี้สิน',
              urgency: 'high',
              icon: '⚠️',
              analysis: {
                why: `มีหนี้สินรวม ${totalDebt.toLocaleString()} บาท หรือประมาณ ${debtRatio.toFixed(1)} เท่าของรายได้ต่อปี ซึ่งอยู่ในระดับที่สูงและเสี่ยงต่อสภาพคล่อง`,
                recommendedProducts: [
                  'ประกันชีวิตวงเงินเท่าหนี้',
                  'ประกันทุพพลภาพ',
                  'ประกันสุขภาพ'
                ],
                benefits: [
                  'คุ้มครองภาระหนี้หากเกิดเหตุไม่คาดฝัน',
                  'ป้องกันการสูญเสียทรัพย์สินหลัก',
                  'รักษามาตรฐานการครองชีพ'
                ]
              }
            };
          } else if (debtRatio > 1.5) {
            return {
              category: 'debt_risk',
              name: 'ความเสี่ยงจากหนี้สินในระดับปานกลาง',
              urgency: 'medium',
              icon: 'ℹ️',
              analysis: {
                why: `มีหนี้สินรวม ${totalDebt.toLocaleString()} บาท หรือประมาณ ${debtRatio.toFixed(1)} เท่าของรายได้ต่อปี ควรมีแผนจัดการหนี้และความคุ้มครอง`,
                recommendedProducts: [
                  'ประกันชีวิตแบบชั่วระยะเวลา',
                  'ประกันอุบัติเหตุ',
                  'ประกันสุขภาพพื้นฐาน'
                ],
                benefits: [
                  'คุ้มครองภาระหนี้หลักๆ',
                  'ลดความเสี่ยงทางการเงิน',
                  'สร้างความมั่นคงให้ครอบครัว'
                ]
              }
            };
          }
        }
        
        // วิเคราะห์สำหรับผู้ที่กำลังพิจารณากู้ยืมใหญ่
        if (age >= 25 && age <= 40 && monthly_income > 40000 && totalDebt === 0) {
          return {
            category: 'debt_risk',
            name: 'โอกาสในการกู้ยืม',
            urgency: 'low',
            icon: '💡',
            analysis: {
              why: `อยู่ในวัยที่เหมาะสมสำหรับการกู้ยืมเพื่อที่อยู่อาศัยหรือพัฒนาคุณภาพชีวิต ยังไม่มีหนี้สิน`,
              recommendedProducts: [
                'ประกันชีวิตแบบสะสมทรัพย์',
                'ประกันสุขภาพ',
                'ประกันอุบัติเหตุ'
              ],
              benefits: [
                'สร้างเครดิตทางการเงิน',
                'เตรียมความพร้อมก่อนกู้ยืม',
                'คุ้มครองความสามารถในการชำระหนี้'
              ]
            }
          };
        }
        
        return null;
      }

      analyzeInvestmentRisk(customer) {
        const { financial_products, age, monthly_income } = customer;
        const savings = financial_products?.savings || 0;
        const fixed = financial_products?.fixed || 0;
        const fund = financial_products?.fund || 0;
        const totalAssets = savings + fixed + fund;
        
        if (totalAssets > 0) {
          const depositRatio = (savings + fixed) / totalAssets;
          const fundRatio = fund / totalAssets;
          
          if (depositRatio > 0.8) {
            return {
              category: 'investment_risk',
              name: 'ความเสี่ยงการลงทุนไม่หลากหลาย',
              urgency: 'high',
              icon: '⚠️',
              analysis: {
                why: `มีการลงทุนในเงินฝากสูงถึง ${(depositRatio * 100).toFixed(0)}% ของพอร์ตการลงทุนทั้งหมด ทำให้เสียโอกาสในการสร้างผลตอบแทนที่สูงกว่า`,
                recommendedProducts: [
                  'ประกันชีวิตแบบมีกองทุน',
                  'Unit Linked',
                  'กองทุนรวมโครงสร้าง'
                ],
                benefits: [
                  'กระจายความเสี่ยงการลงทุน',
                  'ได้ผู้จัดการกองทุนมืออาชีพ',
                  'ได้ความคุ้มครองชีวิตไปพร้อมกัน'
                ]
              }
            };
          } else if (fundRatio > 0.7) {
            return {
              category: 'investment_risk',
              name: 'ความเสี่ยงการลงทุนในกองทุนรวมสูง',
              urgency: 'medium',
              icon: 'ℹ️',
              analysis: {
                why: `มีการลงทุนในกองทุนรวมสูงถึง ${(fundRatio * 100).toFixed(0)}% ของพอร์ตการลงทุนทั้งหมด ควรกระจายความเสี่ยง`,
                recommendedProducts: [
                  'ประกันชีวิตแบบสะสมทรัพย์',
                  'ประกันบำนาญ',
                  'สินทรัพย์ทางเลือก'
                ],
                benefits: [
                  'ลดความผันผวนของพอร์ตการลงทุน',
                  'ได้ความคุ้มครองชีวิตเพิ่มเติม',
                  'สร้างรายได้มั่นคงในระยะยาว'
                ]
              }
            };
          }
        } else if (monthly_income > 30000 && age >= 25) {
          // กรณีไม่มีเงินลงทุนเลย
          return {
            category: 'investment_risk',
            name: 'ความเสี่ยงจากการไม่มีเงินลงทุน',
            urgency: 'medium',
            icon: 'ℹ️',
            analysis: {
              why: `มีรายได้ ${monthly_income.toLocaleString()} บาท/เดือน แต่ยังไม่มีเงินลงทุน ควรเริ่มออมและลงทุนเพื่อสร้างความมั่งคั่ง`,
              recommendedProducts: [
                'ประกันชีวิตแบบสะสมทรัพย์',
                'กองทุนรวม LTF',
                'กองทุนรวม RMF'
              ],
              benefits: [
                'เริ่มต้นการออมและการลงทุน',
                'ได้ประโยชน์ทางภาษี',
                'สร้างวินัยการเงินระยะยาว'
              ]
            }
          };
        }
        return null;
      }

      analyzeLiquidityRisk(customer, policies) {
        // แก้ไข: ตรวจสอบว่า policies เป็น array ที่ถูกต้อง
        if (!policies || !Array.isArray(policies)) {
          return null;
        }

        const monthlyIncome = customer.monthly_income || 0;
        const totalAnnualPremium = policies.reduce((sum, policy) => {
          return sum + (policy.premium_amount || 0);
        }, 0);
        
        const premiumToIncomeRatio = monthlyIncome > 0 ? 
          totalAnnualPremium / (monthlyIncome * 12) : 0;

        if (premiumToIncomeRatio > 0.20) {
          return {
            category: 'liquidity_risk',
            name: 'ความเสี่ยงด้านสภาพคล่อง',
            urgency: 'high',
            icon: '⚠️',
            analysis: {
              why: `มีเบี้ยประกันรวม ${totalAnnualPremium.toLocaleString()} บาท/ปี (${(premiumToIncomeRatio * 100).toFixed(1)}% ของรายได้) สูงเกินเกณฑ์เหมาะสม 20%`,
              recommendedProducts: ['ปรับโครงสร้างพอร์ตประกัน', 'ประกันแบบเติมเงิน', 'ลดความคุ้มครองที่ไม่จำเป็น'],
              benefits: ['ลดภาระรายเดือน', 'เพิ่มสภาพคล่อง', 'รักษาสมดุลการเงิน']
            }
          };
        } else if (premiumToIncomeRatio > 0.15) {
          return {
            category: 'liquidity_risk',
            name: 'ความเสี่ยงด้านสภาพคล่องในระดับปานกลาง',
            urgency: 'medium',
            icon: 'ℹ️',
            analysis: {
              why: `มีเบี้ยประกันรวม ${totalAnnualPremium.toLocaleString()} บาท/ปี (${(premiumToIncomeRatio * 100).toFixed(1)}% ของรายได้) ใกล้ถึงขีดจำกัดที่แนะนำ`,
              recommendedProducts: ['ทบทวนพอร์ตประกัน', 'พิจารณาประกันแบบชำระเบี้ยครั้งเดียว'],
              benefits: ['ป้องกันปัญหาสภาพคล่อง', 'จัดการทางการเงินได้มีประสิทธิภาพ', 'ลดความเครียดทางการเงิน']
            }
          };
        } else if (premiumToIncomeRatio === 0 && customer.monthly_income > 0) {
          return {
            category: 'liquidity_risk',
            name: 'โอกาสในการเริ่มความคุ้มครอง',
            urgency: 'low',
            icon: '💡',
            analysis: {
              why: `ยังไม่มีเบี้ยประกันชีวิต ควรเริ่มวางแผนความคุ้มครองที่เหมาะสมกับรายได้ ${monthlyIncome.toLocaleString()} บาท/เดือน`,
              recommendedProducts: ['ประกันชีวิตพื้นฐาน', 'ประกันสุขภาพ', 'ประกันอุบัติเหตุ'],
              benefits: ['เริ่มสร้างความคุ้มครอง', 'ใช้จ่ายในงบประมาณที่เหมาะสม', 'สร้างวินัยการออม']
            }
          };
        }
        return null;
      }

      analyzePortfolioRisk(policies) {
        // แก้ไข: ตรวจสอบว่า policies เป็น array ที่ถูกต้อง
        if (!policies || !Array.isArray(policies) || policies.length === 0) {
          return {
            category: 'portfolio_risk',
            name: 'โอกาสในการเริ่มพอร์ตประกัน',
            urgency: 'low',
            icon: '💡',
            analysis: {
              why: 'ยังไม่มีกรมธรรม์ประกันชีวิตในพอร์ต เป็นโอกาสที่ดีที่จะเริ่มสร้างความคุ้มครองที่เหมาะสม',
              recommendedProducts: ['ประกันชีวิตแบบสะสมทรัพย์', 'ประกันสุขภาพ', 'ประกันอุบัติเหตุ'],
              benefits: [
                'เริ่มสร้างหลักประกันทางการเงิน',
                'ได้ความคุ้มครองพื้นฐานที่จำเป็น',
                'สร้างนิสัยการออมผ่านประกันชีวิต'
              ]
            }
          };
        }

        const typeCount = this.countPolicyTypes(policies);
        const totalPolicies = policies.length;

        const dominantType = Object.keys(typeCount).reduce((a, b) => 
          typeCount[a] > typeCount[b] ? a : b
        );

        if (typeCount[dominantType] / totalPolicies > 0.6) {
          return {
            category: 'portfolio_risk',
            name: 'ความเสี่ยงการกระจุกตัวพอร์ตประกัน',
            urgency: 'medium',
            icon: 'ℹ️',
            analysis: {
              why: `พอร์ตประกันกระจุกตัวในประเภท "${dominantType}" ถึง ${((typeCount[dominantType] / totalPolicies) * 100).toFixed(0)}% ของพอร์ตทั้งหมด`,
              recommendedProducts: this.getDiversificationProducts(dominantType),
              benefits: [
                'กระจายความเสี่ยงทางการเงิน',
                'ได้ความคุ้มครองที่ครอบคลุมมากขึ้น',
                'เพิ่มประสิทธิภาพพอร์ตประกันรวม'
              ]
            }
          };
        }
        
        // ตรวจสอบความครอบคลุมของพอร์ต
        const hasHealth = Object.keys(typeCount).some(type => type.includes('สุขภาพ'));
        const hasLife = Object.keys(typeCount).some(type => type.includes('ชีวิต'));
        const hasAccident = Object.keys(typeCount).some(type => type.includes('อุบัติเหตุ'));
        
        if (!hasHealth || !hasLife || !hasAccident) {
          const missingCoverage = [];
          if (!hasHealth) missingCoverage.push('สุขภาพ');
          if (!hasLife) missingCoverage.push('ชีวิต');
          if (!hasAccident) missingCoverage.push('อุบัติเหตุ');
          
          return {
            category: 'portfolio_risk',
            name: 'ความเสี่ยงความคุ้มครองไม่ครบถ้วน',
            urgency: 'medium',
            icon: 'ℹ️',
            analysis: {
              why: `พอร์ตประกันขาดความคุ้มครองด้าน${missingCoverage.join(', ')}`,
              recommendedProducts: this.getMissingCoverageProducts(missingCoverage),
              benefits: [
                'ได้ความคุ้มครองที่สมบูรณ์มากขึ้น',
                'ลดช่องโหว่ทางการเงิน',
                'เพิ่มความมั่นใจในแผนการเงิน'
              ]
            }
          };
        }
        
        return null;
      }

      countPolicyTypes(policies) {
        // แก้ไข: ตรวจสอบว่า policies เป็น array ที่ถูกต้องก่อนใช้ reduce
        if (!policies || !Array.isArray(policies)) {
          return {};
        }
        
        return policies.reduce((acc, policy) => {
          const type = policy.policy_type;
          acc[type] = (acc[type] || 0) + 1;
          return acc;
        }, {});
      }

      getDiversificationProducts(dominantType) {
        const diversificationMap = {
          'สะสมทรัพย์': ['ประกันสุขภาพ', 'ประกันอุบัติเหตุ', 'ประกันโรคร้ายแรง'],
          'สุขภาพ': ['ประกันชีวิตแบบสะสมทรัพย์', 'ประกันบำนาญ', 'ประกันการศึกษา'],
          'ตลอดชีพ': ['ประกันชั่วระยะเวลา', 'ประกันสุขภาพ', 'ประกันบำนาญ'],
          'บำนาญ': ['ประกันชีวิตแบบสะสมทรัพย์', 'ประกันสุขภาพ', 'ประกันการศึกษา'],
          'อุบัติเหตุ': ['ประกันชีวิตแบบสะสมทรัพย์', 'ประกันสุขภาพ', 'ประกันโรคร้ายแรง']
        };
        return diversificationMap[dominantType] || ['ประกันสุขภาพ', 'ประกันชีวิตแบบสะสมทรัพย์', 'ประกันอุบัติเหตุ'];
      }

      getMissingCoverageProducts(missingCoverage) {
        const coverageMap = {
          'สุขภาพ': ['ประกันสุขภาพ IPD/OPD', 'ประกันโรคร้ายแรง'],
          'ชีวิต': ['ประกันชีวิตแบบสะสมทรัพย์', 'ประกันชีวิตแบบชั่วระยะเวลา'],
          'อุบัติเหตุ': ['ประกันอุบัติเหตุส่วนบุคคล', 'ประกันทุพพลภาพ']
        };
        
        return missingCoverage.flatMap(coverage => coverageMap[coverage] || []);
      }

      analyzeAllRisks(customerData, policies = []) {
        const risks = [];
        
        // Analyze customer risks
        this.riskCategories.forEach(category => {
          if (category.id === 'liquidity_risk' || category.id === 'portfolio_risk') {
            const result = category.analyzer(customerData, policies);
            if (result) risks.push(result);
          } else {
            const result = category.analyzer(customerData);
            if (result) risks.push(result);
          }
        });
        
        // เรียงลำดับความสำคัญ
        const urgencyOrder = { critical: 0, high: 1, medium: 2, low: 3 };
        return risks.sort((a, b) => urgencyOrder[a.urgency] - urgencyOrder[b.urgency]);
      }
    }

    class AdvancedInsuranceAdvisor {
      constructor() {
        this.products = this.initializeProducts();
        this.riskFactors = this.initializeRiskFactors();
      }

      initializeProducts() {
        return {
          'ประกันสุขภาพ IPD': { category: 'health', minAge: 0, maxAge: 70, priority: 1 },
          'ประกันสุขภาพ OPD': { category: 'health', minAge: 0, maxAge: 65, priority: 2 },
          'ประกันโรคร้ายแรง': { category: 'health', minAge: 25, maxAge: 60, priority: 3 },
          'ประกันโรคมะเร็ง': { category: 'health', minAge: 20, maxAge: 65, priority: 4 },
          'ประกันชีวิตแบบสะสมทรัพย์': { category: 'life', minAge: 20, maxAge: 55, priority: 5 },
          'ประกันชีวิตแบบตลอดชีพ': { category: 'life', minAge: 25, maxAge: 50, priority: 6 },
          'ประกันชีวิตแบบชั่วระยะเวลา': { category: 'life', minAge: 20, maxAge: 60, priority: 7 },
          'ประกันอุบัติเหตุส่วนบุคคล': { category: 'accident', minAge: 18, maxAge: 65, priority: 8 },
          'ประกันทุพพลภาพ': { category: 'accident', minAge: 20, maxAge: 55, priority: 9 },
          'ประกันบำนาญ': { category: 'retirement', minAge: 30, maxAge: 50, priority: 10 },
          'ประกันการศึกษา': { category: 'savings', minAge: 25, maxAge: 45, priority: 11 },
          'ประกันชีวิตแบบมีกองทุน': { category: 'investment', minAge: 25, maxAge: 50, priority: 12 },
          'Unit Linked': { category: 'investment', minAge: 25, maxAge: 55, priority: 13 }
        };
      }

      initializeRiskFactors() {
        return {
          occupation: {
            'แพทย์': { health: 8, accident: 6, life: 5 },
            'วิศวกร': { health: 5, accident: 7, life: 4 },
            'ครู': { health: 4, accident: 3, life: 4 },
            'นักกฎหมาย': { health: 6, accident: 4, life: 5 },
            'เจ้าของกิจการ/ธุรกิจส่วนตัว': { health: 7, accident: 5, life: 8 },
            'พนักงานบริษัท': { health: 4, accident: 3, life: 4 },
            'ข้าราชการ': { health: 3, accident: 2, life: 3 }
          }
        };
      }

      analyzeCustomer(customer) {
        const profile = this.createDetailedProfile(customer);
        const analysis = this.performMultiDimensionalAnalysis(profile);
        return this.generateRecommendations(analysis, profile);
      }

      createDetailedProfile(customer) {
        return {
          age: customer.age || 0,
          gender: customer.gender || '',
          occupation: customer.occupation || '',
          income: {
            monthly: customer.monthly_income || 0,
            yearly: (customer.monthly_income || 0) * 12,
            tier: this.getIncomeTier(customer.monthly_income || 0)
          },
          family: {
            maritalStatus: customer.marital_status || '',
            hasChildren: customer.has_children === 'มี',
            childrenCount: customer.children_count || 0,
            childrenAges: this.parseChildrenAges(customer.children_ages),
            hasDependents: customer.has_dependents === 'มี'
          },
          lifeStage: this.determineLifeStage(customer),
          risk: {
            occupationRisk: this.calculateOccupationRisk(customer.occupation),
            level: this.calculateOverallRisk(customer)
          }
        };
      }

      performMultiDimensionalAnalysis(profile) {
        return {
          needs: {
            health: this.analyzeHealthNeeds(profile),
            life: this.analyzeLifeInsuranceNeeds(profile),
            retirement: this.analyzeRetirementNeeds(profile),
            education: profile.family.hasChildren ? this.analyzeEducationNeeds(profile) : [],
            investment: this.analyzeInvestmentNeeds(profile)
          }
        };
      }

      analyzeHealthNeeds(profile) {
        const needs = [];
        const age = profile.age;

        needs.push({
          type: 'basic_health',
          priority: 'high',
          reason: 'ความคุ้มครองพื้นฐานสำหรับค่ารักษาพยาบาล'
        });

        if (age >= 30) {
          needs.push({
            type: 'critical_illness',
            priority: age >= 40 ? 'high' : 'medium',
            reason: `อายุ ${age} ปี เป็นกลุ่มเสี่ยงโรคเรื้อรัง`
          });
        }

        if (age >= 35) {
          needs.push({
            type: 'cancer',
            priority: age >= 45 ? 'high' : 'medium',
            reason: 'ความเสี่ยงโรคมะเร็งเพิ่มขึ้นตามอายุ'
          });
        }

        // เพิ่มความต้องการตามอาชีพ
        if (profile.risk.occupationRisk.health >= 6) {
          needs.push({
            type: 'comprehensive_health',
            priority: 'high',
            reason: `อาชีพ ${profile.occupation} มีความเสี่ยงด้านสุขภาพสูง`
          });
        }

        return needs;
      }

      analyzeLifeInsuranceNeeds(profile) {
        const needs = [];
        const { family, income } = profile;

        if (income.monthly > 0) {
          needs.push({
            type: 'income_replacement',
            priority: 'high',
            reason: `แทนที่รายได้ ${income.monthly.toLocaleString()} บาท/เดือน`,
            suggestedCoverage: income.yearly * 5
          });
        }

        if (family.hasChildren || family.maritalStatus === 'สมรส' || family.hasDependents) {
          needs.push({
            type: 'family_protection',
            priority: 'high',
            reason: `มี${family.hasChildren ? 'บุตร' : family.hasDependents ? 'บุคคลที่ต้องดูแล' : 'คู่สมรส'}ที่ต้องดูแล`,
            suggestedCoverage: this.calculateFamilyProtectionNeeds(profile)
          });
        }

        return needs;
      }

      analyzeRetirementNeeds(profile) {
        const needs = [];
        const { age, income } = profile;

        if (age >= 25) {
          const yearsToRetirement = 60 - age;
          const priority = yearsToRetirement <= 20 ? 'medium' : 'low';
          
          needs.push({
            type: 'retirement_savings',
            priority: priority,
            reason: `เหลือเวลาอีก ${yearsToRetirement} ปีก่อนเกษียณ`,
            suggestedSavings: this.calculateRetirementNeeds(profile)
          });
        }

        return needs;
      }

      analyzeEducationNeeds(profile) {
        const needs = [];
        const childrenAges = profile.family.childrenAges;

        // ตรวจสอบว่ามีบุตรก่อนวิเคราะห์
        if (!profile.family.hasChildren || childrenAges.length === 0) {
          return needs;
        }

        childrenAges.forEach((age, index) => {
          const yearsToUniversity = 18 - age;
          if (yearsToUniversity > 0 && yearsToUniversity <= 18) {
            needs.push({
              type: 'education_fund',
              priority: yearsToUniversity <= 10 ? 'medium' : 'low',
              reason: `บุตรคนที่ ${index + 1} วัย ${age} ปี จะเข้าเรียนมหาวิทยาลัยในอีก ${yearsToUniversity} ปี`,
              suggestedSavings: this.calculateEducationNeeds(age)
            });
          }
        });

        return needs;
      }

      analyzeInvestmentNeeds(profile) {
        const needs = [];
        const { income, age } = profile;

        if (income.tier === 'high' || income.tier === 'premium') {
          needs.push({
            type: 'wealth_accumulation',
            priority: age <= 50 ? 'medium' : 'low',
            reason: 'สร้างความมั่งคั่งผ่านการลงทุนระยะยาว',
            suggestedAmount: income.yearly * 0.2
          });
        }

        if (income.monthly > 50000 && age <= 45) {
          needs.push({
            type: 'tax_planning',
            priority: 'medium',
            reason: 'วางแผนภาษีผ่านการลงทุน',
            suggestedAmount: income.yearly * 0.15
          });
        }

        return needs;
      }

      generateRecommendations(analysis, profile) {
        const recommendations = [];
        
        if (analysis.needs.health.length > 0) {
          analysis.needs.health.forEach(need => {
            const product = this.mapNeedToProduct(need.type);
            if (product) {
              recommendations.push(this.createProductRecommendation(product, need, profile));
            }
          });
        }

        if (analysis.needs.life.length > 0) {
          analysis.needs.life.forEach(need => {
            const product = this.mapNeedToProduct(need.type);
            if (product) {
              recommendations.push(this.createProductRecommendation(product, need, profile));
            }
          });
        }

        if (analysis.needs.retirement.length > 0) {
          analysis.needs.retirement.forEach(need => {
            const product = this.mapNeedToProduct(need.type);
            if (product) {
              recommendations.push(this.createProductRecommendation(product, need, profile));
            }
          });
        }

        if (analysis.needs.education && analysis.needs.education.length > 0) {
          analysis.needs.education.forEach(need => {
            const product = this.mapNeedToProduct(need.type);
            if (product) {
              recommendations.push(this.createProductRecommendation(product, need, profile));
            }
          });
        }

        if (analysis.needs.investment && analysis.needs.investment.length > 0) {
          analysis.needs.investment.forEach(need => {
            const product = this.mapNeedToProduct(need.type);
            if (product) {
              recommendations.push(this.createProductRecommendation(product, need, profile));
            }
          });
        }

        return recommendations
          .sort((a, b) => b.score - a.score)
          .slice(0, 6); // เพิ่มจำนวนคำแนะนำเป็น 6 รายการ
      }

      createProductRecommendation(productName, need, profile) {
        const product = this.products[productName];
        const score = this.calculateProductScore(productName, profile, need);
        const capital = this.calculateCapital(productName, profile, need);
        const premium = this.calculatePremium(productName, capital);
        const reason = this.generateReason(productName, need, profile);

        return {
          product: productName,
          score: score,
          capital: capital,
          premium: premium,
          reason: reason,
          source: 'rule_based',
          category: product.category,
          urgency: need.priority === 'high' ? 3 : need.priority === 'medium' ? 2 : 1
        };
      }

      calculateProductScore(productName, profile, need) {
        let score = 50;
        const product = this.products[productName];
        
        if (profile.age >= product.minAge && profile.age <= product.maxAge) {
          score += 20;
        }

        if (profile.income.tier === 'high' || profile.income.tier === 'premium') {
          score += 15;
        }

        if (need.priority === 'high') score += 15;
        else if (need.priority === 'medium') score += 10;

        // ลดคะแนนสำหรับประกันการศึกษาหากไม่มีบุตร
        if (productName === 'ประกันการศึกษา' && !profile.family.hasChildren) {
          score -= 30;
        }

        return Math.min(score, 95);
      }

      calculateCapital(productName, profile, need) {
        const product = this.products[productName];
        let capital = 500000;

        if (profile.income.tier === 'medium') capital = 1000000;
        else if (profile.income.tier === 'high') capital = 2000000;
        else if (profile.income.tier === 'premium') capital = 5000000;

        if (need.suggestedCoverage) {
          capital = Math.max(capital, need.suggestedCoverage);
        }

        if (need.suggestedSavings) {
          capital = Math.max(capital, need.suggestedSavings);
        }

        if (need.suggestedAmount) {
          capital = Math.max(capital, need.suggestedAmount);
        }

        // ปรับทุนประกันการศึกษาให้สอดคล้องกับจำนวนบุตร
        if (productName === 'ประกันการศึกษา' && profile.family.hasChildren) {
          capital = capital * profile.family.childrenCount;
        }

        return Math.min(capital, 10000000);
      }

      calculatePremium(productName, capital) {
        const premiumRates = {
          'ประกันสุขภาพ IPD': 0.02,
          'ประกันสุขภาพ OPD': 0.015,
          'ประกันโรคร้ายแรง': 0.025,
          'ประกันโรคมะเร็ง': 0.02,
          'ประกันชีวิตแบบสะสมทรัพย์': 0.015,
          'ประกันชีวิตแบบตลอดชีพ': 0.02,
          'ประกันชีวิตแบบชั่วระยะเวลา': 0.01,
          'ประกันอุบัติเหตุส่วนบุคคล': 0.005,
          'ประกันทุพพลภาพ': 0.008,
          'ประกันบำนาญ': 0.012,
          'ประกันการศึกษา': 0.01,
          'ประกันชีวิตแบบมีกองทุน': 0.018,
          'Unit Linked': 0.02
        };
        
        return Math.round(capital * (premiumRates[productName] || 0.02));
      }

      generateReason(productName, need, profile) {
        const reasons = {
          'ประกันสุขภาพ IPD': `อายุ ${profile.age} ปี ควรมีความคุ้มครองค่ารักษาพยาบาล`,
          'ประกันสุขภาพ OPD': `เหมาะสำหรับการรักษาพยาบาลทั่วไป`,
          'ประกันโรคร้ายแรง': `กลุ่มอายุ ${profile.age} ปี มีความเสี่ยงโรคเรื้อรัง`,
          'ประกันชีวิตแบบสะสมทรัพย์': `สร้างความมั่นคงทางการเงินพร้อมออมทรัพย์`,
          'ประกันบำนาญ': `วางแผนการเงินหลังเกษียณ อีก ${60 - profile.age} ปี`,
          'ประกันการศึกษา': profile.family.hasChildren ? 
            `วางแผนการศึกษาบุตร ${profile.family.childrenCount} คน` : 
            `ไม่แนะนำ เนื่องจากไม่มีบุตร`,
          'ประกันชีวิตแบบมีกองทุน': `ลงทุนระยะยาวพร้อมความคุ้มครอง`,
          'Unit Linked': `การลงทุนแบบยูนิตลิงค์พร้อมความคุ้มครองชีวิต`
        };

        return reasons[productName] || need.reason;
      }

      // Helper methods
      mapNeedToProduct(needType) {
        const mapping = {
          'basic_health': 'ประกันสุขภาพ IPD',
          'critical_illness': 'ประกันโรคร้ายแรง',
          'cancer': 'ประกันโรคมะเร็ง',
          'comprehensive_health': 'ประกันสุขภาพวงเงินสูง',
          'income_replacement': 'ประกันชีวิตแบบสะสมทรัพย์',
          'family_protection': 'ประกันชีวิตแบบตลอดชีพ',
          'retirement_savings': 'ประกันบำนาญ',
          'education_fund': 'ประกันการศึกษา',
          'wealth_accumulation': 'ประกันชีวิตแบบมีกองทุน',
          'tax_planning': 'Unit Linked'
        };
        return mapping[needType];
      }

      getIncomeTier(monthlyIncome) {
        if (monthlyIncome <= 25000) return 'low';
        if (monthlyIncome <= 50000) return 'medium';
        if (monthlyIncome <= 100000) return 'high';
        return 'premium';
      }

      determineLifeStage(customer) {
        const age = customer.age || 0;
        if (age <= 24) return 'student';
        if (age <= 34) return 'early_career';
        if (age <= 44) return 'family_builder';
        if (age <= 54) return 'peak_earner';
        return 'pre_retirement';
      }

      calculateOccupationRisk(occupation) {
        return this.riskFactors.occupation[occupation] || { health: 4, accident: 3, life: 4 };
      }

      calculateOverallRisk(customer) {
        let risk = 0;
        if (customer.age >= 40) risk += 2;
        if (customer.occupation === 'แพทย์' || customer.occupation === 'วิศวกร') risk += 2;
        if (customer.has_children === 'มี') risk += 1;
        if (customer.has_dependents === 'มี') risk += 1;
        return Math.min(risk, 5);
      }

      parseChildrenAges(agesString) {
        if (!agesString) return [];
        return agesString.split(',').map(age => parseInt(age.trim())).filter(age => !isNaN(age));
      }

      calculateFamilyProtectionNeeds(profile) {
        const base = profile.income.yearly * 3;
        const childrenFactor = profile.family.childrenCount * 500000;
        const dependentsFactor = profile.family.hasDependents ? 1000000 : 0;
        return base + childrenFactor + dependentsFactor;
      }

      calculateRetirementNeeds(profile) {
        const currentAge = profile.age;
        const retirementAge = 60;
        const yearsInRetirement = 25;
        const monthlyNeed = profile.income.monthly * 0.7;
        return monthlyNeed * 12 * yearsInRetirement;
      }

      calculateEducationNeeds(childAge) {
        const yearsToUni = 18 - childAge;
        const inflationAdjusted = 1000000 * Math.pow(1.03, yearsToUni); // คำนวณด้วยอัตราเงินเฟ้อ 3% ต่อปี
        return Math.round(inflationAdjusted);
      }
    }

    class EnhancedInsuranceAdvisor {
      constructor() {
        this.riskAnalyzer = new ComprehensiveRiskAnalyzer();
        this.ruleBasedAdvisor = new AdvancedInsuranceAdvisor();
      }

      async analyzeCustomer(customerData, policies = []) {
        const riskAnalysis = this.riskAnalyzer.analyzeAllRisks(customerData, policies);
        const productRecommendations = this.ruleBasedAdvisor.analyzeCustomer(customerData);
        
        // กรองคำแนะนำที่ไม่เหมาะสม (เช่น ประกันการศึกษาสำหรับผู้ไม่มีบุตร)
        const filteredRecommendations = productRecommendations.filter(rec => {
          if (rec.product === 'ประกันการศึกษา') {
            return customerData.has_children === 'มี';
          }
          return true;
        });
        
        return {
          analysisId: this.generateAnalysisId(),
          timestamp: new Date().toISOString(),
          urgentMatters: riskAnalysis.filter(risk => risk !== null).slice(0, 4), // เพิ่มจำนวน urgent matters
          productRecommendations: filteredRecommendations,
          profileSummary: this.createProfileSummary(customerData)
        };
      }

      generateAnalysisId() {
        return `analysis_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      }

      createProfileSummary(customerData) {
        return {
          lifeStage: this.ruleBasedAdvisor.determineLifeStage(customerData),
          riskLevel: this.ruleBasedAdvisor.calculateOverallRisk(customerData),
          incomeTier: this.ruleBasedAdvisor.getIncomeTier(customerData.monthly_income || 0),
          familyStatus: this.getFamilyStatus(customerData)
        };
      }

      getFamilyStatus(customerData) {
        const { marital_status, has_children, has_dependents } = customerData;
        if (has_children === 'มี' && marital_status === 'สมรส') return 'ครอบครัวสมบูรณ์';
        if (has_children === 'มี') return 'มีบุตร';
        if (has_dependents === 'มี') return 'มีผู้ต้องดูแล';
        if (marital_status === 'สมรส') return 'สมรส';
        return 'โสด';
      }
    }

    // =============================================
    // Data Service for Supabase
    // =============================================

    class SupabaseDataService {
      constructor() {
        this.supabase = supabase;
      }

      async loadCustomers() {
        try {
          const { data, error } = await this.supabase
            .from('customers')
            .select(`
              *,
              insurance_policies (*)
            `)
            .order('created_at', { ascending: false });
          
          if (error) throw error;
          console.log('✅ Loaded customers from Supabase:', data?.length || 0);
          return data || [];
        } catch (error) {
          console.error('❌ Error loading customers:', error);
          return [];
        }
      }

      async saveCustomer(customerData) {
        try {
          const { data, error } = await this.supabase
            .from('customers')
            .upsert([customerData])
            .select()
            .single();
          
          if (error) throw error;
          console.log('✅ Customer saved to Supabase:', data.customer_id);
          return data;
        } catch (error) {
          console.error('❌ Error saving customer:', error);
          throw error;
        }
      }

      async saveInsurancePolicies(customerId, policies) {
        try {
          const policiesWithCustomerId = policies.map(policy => ({
            ...policy,
            customer_id: customerId
          }));

          const { data, error } = await this.supabase
            .from('insurance_policies')
            .upsert(policiesWithCustomerId)
            .select();
          
          if (error) throw error;
          console.log('✅ Insurance policies saved:', data.length);
          return data;
        } catch (error) {
          console.error('❌ Error saving insurance policies:', error);
          throw error;
        }
      }

      async deleteCustomer(customerId) {
        try {
          const { error } = await this.supabase
            .from('customers')
            .delete()
            .eq('customer_id', customerId);
          
          if (error) throw error;
          console.log('✅ Customer deleted:', customerId);
          return true;
        } catch (error) {
          console.error('❌ Error deleting customer:', error);
          throw error;
        }
      }
    }

    // =============================================
    // Dashboard and Visualization
    // =============================================

    class InsuranceDashboard {
      constructor() {
        this.charts = {};
      }

      renderInsuranceTypeChart(policies) {
        const ctx = document.getElementById('insuranceTypeChart');
        if (!ctx) return;

        const typeCount = this.countPolicyTypes(policies);
        
        if (this.charts.insuranceType) {
          this.charts.insuranceType.destroy();
        }

        this.charts.insuranceType = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: Object.keys(typeCount),
            datasets: [{
              data: Object.values(typeCount),
              backgroundColor: ['#60A5FA', '#34C759', '#FF9500', '#5856D6', '#FF3B30', '#AF52DE', '#FFCC00']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                position: 'bottom',
                labels: {
                  boxWidth: 12,
                  font: {
                    size: 11
                  }
                }
              },
              title: { 
                display: true, 
                text: 'สัดส่วนประเภทประกัน',
                font: {
                  size: 14
                }
              }
            }
          }
        });
      }

      renderFinancialRatioChart(customer) {
        const ctx = document.getElementById('financialRatioChart');
        if (!ctx) return;

        const ratios = this.calculateFinancialRatios(customer);
        
        if (this.charts.financialRatio) {
          this.charts.financialRatio.destroy();
        }

        this.charts.financialRatio = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['เงินฝาก', 'การลงทุน', 'เงินกู้', 'เบี้ยประกัน'],
            datasets: [{
              data: [
                ratios.savingsRatio,
                ratios.investmentRatio,
                ratios.debtRatio,
                ratios.insuranceRatio
              ],
              backgroundColor: ['#60A5FA', '#34C759', '#FF3B30', '#FF9500']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                position: 'bottom',
                labels: {
                  boxWidth: 12,
                  font: {
                    size: 11
                  }
                }
              },
              title: { 
                display: true, 
                text: 'สัดส่วนการเงิน',
                font: {
                  size: 14
                }
              }
            }
          }
        });
      }

      countPolicyTypes(policies) {
        // แก้ไข: ตรวจสอบว่า policies เป็น array ที่ถูกต้อง
        if (!policies || !Array.isArray(policies)) {
          return {};
        }
        
        return policies.reduce((acc, policy) => {
          const type = policy.policy_type;
          acc[type] = (acc[type] || 0) + 1;
          return acc;
        }, {});
      }

      calculateFinancialRatios(customer) {
        const financial = customer.financial_products || {};
        const policies = customer.insurance_policies || [];
        
        const totalSavings = (financial.savings || 0) + (financial.fixed || 0);
        const totalInvestment = financial.fund || 0;
        const totalDebt = (financial.home_loan || 0) + (financial.car_loan || 0) + (financial.personal_loan || 0);
        const totalInsurance = policies.reduce((sum, policy) => 
          sum + (policy.premium_amount || 0), 0);

        const total = totalSavings + totalInvestment + totalDebt + totalInsurance;
        
        if (total === 0) {
          return {
            savingsRatio: 25,
            investmentRatio: 25,
            debtRatio: 25,
            insuranceRatio: 25
          };
        }
        
        return {
          savingsRatio: (totalSavings / total) * 100,
          investmentRatio: (totalInvestment / total) * 100,
          debtRatio: (totalDebt / total) * 100,
          insuranceRatio: (totalInsurance / total) * 100
        };
      }

      analyzePortfolio(policies, customer) {
        const analysis = [];
        
        if (!policies || policies.length === 0) {
          analysis.push({
            type: 'info',
            message: 'ยังไม่มีข้อมูลประกันชีวิตในระบบ'
          });
          return analysis;
        }

        const typeCount = this.countPolicyTypes(policies);
        const totalPolicies = policies.length;

        // ตรวจสอบการกระจุกตัว
        Object.entries(typeCount).forEach(([type, count]) => {
          const ratio = (count / totalPolicies) * 100;
          if (ratio > 60) {
            analysis.push({
              type: 'warning',
              message: `พอร์ตประกันกระจุกตัวในประเภท "${type}" เกิน ${ratio.toFixed(0)}%`
            });
          }
        });

        // ตรวจสอบสภาพคล่อง
        const totalPremium = policies.reduce((sum, policy) => sum + (policy.premium_amount || 0), 0);
        const monthlyIncome = customer.monthly_income || 0;
        
        if (monthlyIncome > 0) {
          const premiumToIncome = (totalPremium / (monthlyIncome * 12)) * 100;
          
          if (premiumToIncome > 20) {
            analysis.push({
              type: 'critical',
              message: `เบี้ยประกันรวม ${premiumToIncome.toFixed(1)}% ของรายได้ สูงเกินเกณฑ์เหมาะสม`
            });
          } else if (premiumToIncome > 15) {
            analysis.push({
              type: 'warning',
              message: `เบี้ยประกันรวม ${premiumToIncome.toFixed(1)}% ของรายได้ ใกล้ถึงขีดจำกัด`
            });
          }
        }

        // ตรวจสอบความครอบคลุม
        if (totalPolicies === 1) {
          analysis.push({
            type: 'info',
            message: 'มีประกันชีวิตเพียงประเภทเดียว ขอแนะนำให้พิจารณาประกันเพิ่มเติม'
          });
        }

        return analysis;
      }

      renderPortfolioAnalysis(analysis) {
        const container = document.getElementById('portfolio-analysis');
        if (!container) return;

        container.innerHTML = '';

        if (analysis.length === 0) {
          container.innerHTML = `
            <div class="analysis-item">
              <i class="fas fa-check-circle" style="color: var(--green); margin-right: 8px;"></i>
              พอร์ตประกันมีความสมดุลและเหมาะสม
            </div>
          `;
          return;
        }

        analysis.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.className = `analysis-item ${item.type}`;
          
          const icon = item.type === 'critical' ? 'exclamation-triangle' : 
                      item.type === 'warning' ? 'exclamation-circle' : 'info-circle';
          const color = item.type === 'critical' ? 'var(--red)' : 
                       item.type === 'warning' ? 'var(--orange)' : 'var(--primary)';
          
          itemElement.innerHTML = `
            <i class="fas fa-${icon}" style="color: ${color}; margin-right: 8px;"></i>
            ${item.message}
          `;
          
          container.appendChild(itemElement);
        });
      }
    }

    // =============================================
    // Main Application Logic
    // =============================================

    let enhancedAdvisor = new EnhancedInsuranceAdvisor();
    let dataService = new SupabaseDataService();
    let dashboard = new InsuranceDashboard();

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    function initializeApp() {
      simulateLoading();
      
      setupEventListeners();
      setupPolicyManagement();
      loadInitialData();
    }

    function simulateLoading() {
      let progress = 0;
      const progressBar = $('loadingProgress');
      
      const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          setTimeout(() => {
            $('loadingScreen').style.opacity = '0';
            setTimeout(() => {
              $('loadingScreen').style.display = 'none';
              $('appContainer').style.display = 'flex';
            }, 600);
          }, 500);
        }
        progressBar.style.width = `${progress}%`;
      }, 200);
    }

    function setupEventListeners() {
      // Tab navigation
      document.querySelectorAll('.ios-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const panel = this.getAttribute('data-panel');
          showPanel(panel);
        });
      });

      // Start button
      $('btnStart').addEventListener('click', () => showPanel('form'));

      // Form event listeners
      $('cust_monthly_income').addEventListener('input', calculateYearlyIncome);
      $('cust_has_children').addEventListener('change', toggleChildrenSection);
      $('cust_has_dependents').addEventListener('change', toggleDependentsSection);
      $('cust_occupation').addEventListener('change', toggleBusinessSection);
      $('btnClear').addEventListener('click', clearForm);
      $('btnSave').addEventListener('click', saveCustomer);
      $('btnAnalyze').addEventListener('click', performAnalysis);

      // RH and Zone management
      $('rh').addEventListener('change', updateZones);

      // Unknown checkbox handlers
      setupUnknownCheckboxes();

      // Search functionality
      $('btnSearch').addEventListener('click', performSearch);
      $('btnClearSearch').addEventListener('click', clearSearch);

      // Report functionality
      $('btnAccessReport').addEventListener('click', () => showSecurityModal('report'));
      $('btnExportPDF').addEventListener('click', () => showSecurityModal('export_pdf'));
      $('btnExportExcel').addEventListener('click', () => showSecurityModal('export_excel'));

      // Security modal
      $('btnCancelSecurity').addEventListener('click', hideSecurityModal);
      $('btnConfirmSecurity').addEventListener('click', handleSecurityConfirm);

      // Data management
      $('btnDeleteSelected').addEventListener('click', () => confirmDelete('selected'));
      $('btnDeleteLastMonth').addEventListener('click', () => confirmDelete('last_month'));
      $('btnDeleteOldest').addEventListener('click', () => confirmDelete('oldest'));
      $('btnDeleteAll').addEventListener('click', () => confirmDelete('all'));

      // No insurance button
      $('btn-no-insurance').addEventListener('click', handleNoInsurance);
    }

    function setupPolicyManagement() {
      $('btn-add-policy').addEventListener('click', addInsurancePolicy);
      
      // Add initial policy
      addInsurancePolicy();
    }

    function addInsurancePolicy() {
      const container = $('insurance-policies-container');
      const policyHtml = `
        <div class="policy-item" data-policy-index="${policyCount}">
          <div class="form-grid">
            <div class="ios-input-group">
              <label class="ios-label required">ประเภทประกัน</label>
              <select class="ios-select policy-type" required>
                <option value="">เลือกประเภท</option>
                <option value="สะสมทรัพย์">สะสมทรัพย์</option>
                <option value="ตลอดชีพ">ตลอดชีพ</option>
                <option value="ชั่วระยะเวลา">ชั่วระยะเวลา</option>
                <option value="สุขภาพ">สุขภาพ</option>
                <option value="บำนาญ">บำนาญ</option>
                <option value="อุบัติเหตุ">อุบัติเหตุ</option>
                <option value="โรคร้ายแรง">โรคร้ายแรง</option>
                <option value="การศึกษา">การศึกษา</option>
              </select>
            </div>
            <div class="ios-input-group">
              <label class="ios-label required">จำนวนเงินเอาประกัน (บาท)</label>
              <input type="number" class="ios-input sum-insured" required placeholder="กรอกจำนวนเงิน">
            </div>
          </div>
          
          <div class="form-grid">
            <div class="ios-input-group">
              <label class="ios-label required">เบี้ยประกันต่อปี (บาท)</label>
              <input type="number" class="ios-input premium-amount" required placeholder="กรอกเบี้ยประกัน">
            </div>
            <div class="ios-input-group">
              <label class="ios-label required">สถานะการชำระ</label>
              <select class="ios-select payment-status" required>
                <option value="">เลือกสถานะ</option>
                <option value="กำลังชำระ">กำลังชำระ</option>
                <option value="ชำระครบแล้ว">ชำระครบแล้ว</option>
                <option value="ใกล้ครบสัญญา">ใกล้ครบสัญญา</option>
              </select>
            </div>
          </div>
          
          <button type="button" class="ios-btn ios-btn-secondary btn-remove-policy">
            <i class="fas fa-trash"></i>
            ลบกรมธรรม์นี้
          </button>
          <hr>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', policyHtml);
      
      // Add event listener to remove button
      const newPolicy = container.lastElementChild;
      const removeBtn = newPolicy.querySelector('.btn-remove-policy');
      removeBtn.addEventListener('click', function() {
        newPolicy.remove();
      });
      
      policyCount++;
      hasInsurancePolicies = true;
    }

    function handleNoInsurance() {
      const container = $('insurance-policies-container');
      container.innerHTML = `
        <div style="text-align: center; padding: 20px; background: var(--light-gray-bg); border-radius: 8px; margin-bottom: 12px;">
          <i class="fas fa-check-circle" style="color: var(--green); font-size: 24px; margin-bottom: 8px;"></i>
          <p>บันทึกข้อมูล "ไม่มีประกันชีวิต" เรียบร้อยแล้ว</p>
          <small style="color: var(--text-secondary);">คุณสามารถเพิ่มกรมธรรม์ได้ภายหลังโดยกดปุ่ม "เพิ่มกรมธรรม์"</small>
        </div>
      `;
      hasInsurancePolicies = false;
    }

    function getInsurancePolicies() {
      if (!hasInsurancePolicies) {
        return [];
      }

      const policies = [];
      const policyItems = document.querySelectorAll('.policy-item');
      
      policyItems.forEach(item => {
        const policyType = item.querySelector('.policy-type').value;
        const sumInsured = parseFloat(item.querySelector('.sum-insured').value) || 0;
        const premiumAmount = parseFloat(item.querySelector('.premium-amount').value) || 0;
        const paymentStatus = item.querySelector('.payment-status').value;
        
        if (policyType && sumInsured > 0 && premiumAmount > 0 && paymentStatus) {
          policies.push({
            policy_type: policyType,
            sum_insured: sumInsured,
            premium_amount: premiumAmount,
            payment_status: paymentStatus
          });
        }
      });
      
      return policies;
    }

    function showPanel(panelName) {
      document.querySelectorAll('.ios-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`.ios-tab[data-panel="${panelName}"]`).classList.add('active');

      document.querySelectorAll('.content-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      
      $(`panel-${panelName}`).classList.add('active');
      
      currentPanel = panelName;

      if (panelName === 'search') {
        // ไม่โหลดข้อมูลลูกค้าทั้งหมดเมื่อเปิดหน้า search
        $('customerList').innerHTML = `
          <div class="search-placeholder">
            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; color: var(--gray-4);"></i>
            <p>กรุณาใช้ฟิลเตอร์ด้านบนเพื่อค้นหาข้อมูลลูกค้า</p>
            <small style="color: var(--text-secondary);">ระบบจะแสดงข้อมูลเฉพาะเมื่อค้นหาแล้วเท่านั้น</small>
          </div>
        `;
        $('portfolioDashboard').style.display = 'none';
      } else if (panelName === 'start') {
        updateDashboardStats();
      }
    }

    function calculateYearlyIncome() {
      const monthlyIncome = parseFloat($('cust_monthly_income').value) || 0;
      const yearlyIncome = monthlyIncome * 12;
      $('cust_yearly_income').value = yearlyIncome.toLocaleString();
    }

    function toggleChildrenSection() {
      const hasChildren = $('cust_has_children').value === 'มี';
      $('children-section').style.display = hasChildren ? 'block' : 'none';
    }

    function toggleDependentsSection() {
      const hasDependents = $('cust_has_dependents').value === 'มี';
      $('dependents-section').style.display = hasDependents ? 'block' : 'none';
    }

    function toggleBusinessSection() {
      const isBusinessOwner = $('cust_occupation').value === 'เจ้าของกิจการ/ธุรกิจส่วนตัว';
      $('business-section').style.display = isBusinessOwner ? 'block' : 'none';
    }

    function updateZones() {
      const rh = $('rh').value;
      const zoneSelect = $('zone');
      
      zoneSelect.innerHTML = '<option value="">เลือก Zone</option>';
      
      if (rh) {
        const zones = {
          'RH1': ['จตุจักร', 'ธนบุรี', 'บางกะปิ', 'สาทร', 'สุขุมวิท'],
          'RH2': ['ชลบุรี', 'บางนา', 'พัทยา', 'ระยอง'],
          'RH3': ['เชียงใหม่', 'นครสวรรค์', 'นนทบุรี', 'พิษณุโลก', 'อยุธยา'],
          'RH4': ['ดอนเมือง', 'นครราชสีมา', 'สระบุรี', 'อุดรธานี', 'อุบลราชธานี'],
          'RH5': ['ภูเก็ต', 'ราชบุรี', 'สมุทรสาคร', 'สุราษฎร์ธานี', 'หาดใหญ่']
        };
        
        zones[rh].forEach(zone => {
          zoneSelect.innerHTML += `<option value="${zone}">Zone ${zone}</option>`;
        });
        zoneSelect.disabled = false;
      } else {
        zoneSelect.disabled = true;
      }
    }

    function setupUnknownCheckboxes() {
      const unknownCheckboxes = document.querySelectorAll('.unknown-checkbox input[type="checkbox"]');
      unknownCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const targetId = this.id.replace('_unknown', '');
          const targetElement = $(targetId);
          if (targetElement) {
            targetElement.disabled = this.checked;
            if (this.checked) {
              targetElement.value = '';
            }
          }
        });
      });
    }

    function clearForm() {
      document.querySelectorAll('.ios-input, .ios-select').forEach(input => {
        input.value = '';
        input.disabled = false;
      });
      
      document.querySelectorAll('.unknown-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      $('children-section').style.display = 'none';
      $('dependents-section').style.display = 'none';
      $('business-section').style.display = 'none';
      $('analysisResults').style.display = 'none';
      $('customerIdDisplay').style.display = 'none';
      $('formStatus').style.display = 'none';
      
      // Clear insurance policies
      $('insurance-policies-container').innerHTML = '';
      policyCount = 0;
      addInsurancePolicy();
      hasInsurancePolicies = true;
      
      $('zone').innerHTML = '<option value="">เลือก RH ก่อน</option>';
      $('zone').disabled = true;
      
      calculateYearlyIncome();
      currentCustomerId = '';

      $('btnAnalyze').disabled = true;
      $('btnAnalyze').style.opacity = '0.6';
    }

    function genCustomerCode(rh) {
      const now = new Date();
      const rhNumber = rh.replace('RH', '');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = String(now.getFullYear()).slice(-2);
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      
      return `R${rhNumber}-${month}${year}${hours}${minutes}`;
    }

    function validateForm() {
      const required = [
        ['employee_name', 'กรอกชื่อผู้กรอก'],
        ['employee_id', 'กรอก Employee ID'],
        ['employee_position', 'เลือกตำแหน่ง'],
        ['rh', 'เลือก RH'],
        ['zone', 'เลือก Zone'],
        ['cust_name', 'กรอกชื่อนามสมมุติ'],
        ['cust_age', 'กรอกอายุ'],
        ['cust_gender', 'เลือกเพศ'],
        ['cust_occupation', 'เลือกอาชีพ'],
        ['cust_monthly_income', 'กรอกรายได้ต่อเดือน']
      ];

      for (let [id, msg] of required) {
        const el = $(id);
        if (!el) continue;
        
        const unknownCheckbox = $(`${id}_unknown`);
        if (unknownCheckbox && unknownCheckbox.checked) {
          continue;
        }
        
        if (!el.value || el.value.trim() === '') {
          alert(msg);
          el.focus();
          return false;
        }
      }

      return true;
    }

    function showCustomerIdPopup(customerId) {
      const popup = document.createElement('div');
      popup.className = 'customer-id-popup';
      popup.innerHTML = `
        <div class="popup-overlay"></div>
        <div class="popup-content">
          <div class="popup-header">
            <h3>บันทึกข้อมูลสำเร็จ!</h3>
          </div>
          <div class="popup-body">
            <div class="customer-id-large">${customerId}</div>
            <p>กรุณาจดจำรหัสลูกค้านี้เพื่อใช้ในการค้นหาข้อมูลในครั้งต่อไป</p>
          </div>
          <div class="popup-footer">
            <button class="ios-btn ios-btn-primary" onclick="this.closest('.customer-id-popup').remove()">
              <i class="fas fa-check"></i>
              ตกลง
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(popup);
    }

    async function saveCustomer() {
      if (!validateForm()) return;

      const createdBy = $('employee_id').value.trim();
      const rh = $('rh').value.trim();

      currentCustomerId = genCustomerCode(rh);
      
      const customer = {
        customer_id: currentCustomerId,
        name: $('cust_name').value.trim(),
        age: parseInt($('cust_age').value) || 0,
        gender: $('cust_gender').value,
        occupation: $('cust_occupation').value,
        monthly_income: parseFloat($('cust_monthly_income').value) || 0,
        yearly_income: parseFloat($('cust_monthly_income').value) * 12 || 0,
        welfare: $('cust_welfare').value,
        insurance_capital: parseFloat($('cust_insurance_capital').value) || 0,
        marital_status: $('cust_marital_status').value,
        spouse_age: parseInt($('cust_spouse_age').value) || 0,
        spouse_occupation: $('cust_spouse_occupation').value,
        has_children: $('cust_has_children').value,
        children_count: parseInt($('cust_children_count').value) || 0,
        children_ages: $('cust_children_ages').value,
        children_occupation: $('cust_children_occupation').value,
        has_dependents: $('cust_has_dependents').value,
        dependents_details: $('cust_dependents_details').value,
        business_type: $('cust_business_type').value,
        business_capital: parseFloat($('cust_business_capital').value) || 0,
        business_income: parseFloat($('cust_business_income').value) || 0,
        business_profit: parseFloat($('cust_business_profit').value) || 0,
        business_tax: parseFloat($('cust_business_tax').value) || 0,
        business_share: parseFloat($('cust_business_share').value) || 0,
        financial_products: {
          savings: parseFloat($('prod_savings').value) || 0,
          fixed: parseFloat($('prod_fixed').value) || 0,
          fund: parseFloat($('prod_fund').value) || 0,
          credit_card: parseFloat($('prod_credit_card').value) || 0,
          home_loan: parseFloat($('prod_home_loan').value) || 0,
          car_loan: parseFloat($('prod_car_loan').value) || 0,
          personal_loan: parseFloat($('prod_personal_loan').value) || 0
        },
        employee_comments: {
          additional_comments: $('emp_additional_comments').value,
          presented_before: $('emp_presented_before').value,
          customer_feedback: $('emp_customer_feedback').value,
          proposed_product: $('emp_proposed_product').value,
          proposed_premium: parseFloat($('emp_proposed_premium').value) || 0,
          proposed_capital: parseFloat($('emp_proposed_capital').value) || 0
        },
        employee_info: {
          name: $('employee_name').value.trim(),
          id: $('employee_id').value.trim(),
          position: $('employee_position').value,
          rh: rh,
          zone: $('zone').value
        },
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
        created_by: createdBy
      };

      try {
        const savedCustomer = await dataService.saveCustomer(customer);
        
        // Save insurance policies only if user has policies
        const policies = getInsurancePolicies();
        if (policies.length > 0) {
          await dataService.saveInsurancePolicies(savedCustomer.id, policies);
        }
        
        $('customerIdDisplay').textContent = `Customer ID: ${customer.customer_id}`;
        $('customerIdDisplay').style.display = 'block';
        
        $('formStatus').textContent = `บันทึกข้อมูลลูกค้า ${customer.customer_id} เรียบร้อยแล้ว`;
        $('formStatus').style.display = 'block';
        $('formStatus').style.background = 'var(--green)';
        
        showCustomerIdPopup(currentCustomerId);
        
        $('btnAnalyze').disabled = false;
        $('btnAnalyze').style.opacity = '1';
        
        // Reload customer list
        await loadCustomerList();
        
      } catch(error) {
        console.error('Error saving customer:', error);
        $('formStatus').textContent = 'เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message;
        $('formStatus').style.display = 'block';
        $('formStatus').style.background = 'var(--red)';
      }
    }

    async function performAnalysis() {
      const customerData = collectCustomerData();
      const policies = getInsurancePolicies();
      
      if (!validateForm()) {
        return;
      }
      
      showAnalysisLoading();
      
      try {
        const results = await enhancedAdvisor.analyzeCustomer(customerData, policies);
        displayEnhancedAnalysis(results);
        autoFillRecommendations(results.productRecommendations);
      } catch (error) {
        showAnalysisError(error);
      }
    }

    function collectCustomerData() {
      return {
        age: parseInt($('cust_age').value) || 0,
        gender: $('cust_gender').value,
        monthly_income: parseFloat($('cust_monthly_income').value) || 0,
        occupation: $('cust_occupation').value,
        marital_status: $('cust_marital_status').value,
        spouse_occupation: $('cust_spouse_occupation').value,
        has_children: $('cust_has_children').value,
        children_count: parseInt($('cust_children_count').value) || 0,
        children_ages: $('cust_children_ages').value,
        has_dependents: $('cust_has_dependents').value,
        business_capital: parseFloat($('cust_business_capital').value) || 0,
        financial_products: {
          savings: parseFloat($('prod_savings').value) || 0,
          fixed: parseFloat($('prod_fixed').value) || 0,
          fund: parseFloat($('prod_fund').value) || 0,
          home_loan: parseFloat($('prod_home_loan').value) || 0,
          car_loan: parseFloat($('prod_car_loan').value) || 0,
          personal_loan: parseFloat($('prod_personal_loan').value) || 0
        }
      };
    }

    function showAnalysisLoading() {
      $('analysisResults').style.display = 'block';
      $('recommendationList').innerHTML = `
        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
          <div class="spinner-border" style="color: var(--primary); margin-bottom: 16px;"></div>
          <p>กำลังวิเคราะห์ข้อมูลด้วย AI...</p>
        </div>
      `;
    }

    function displayEnhancedAnalysis(results) {
      const container = $('recommendationList');
      container.innerHTML = '';

      if (results.urgentMatters.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px;"></i>
            <p>ไม่พบประเด็นความเสี่ยงที่ต้องจัดการเร่งด่วน</p>
          </div>
        `;
        return;
      }

      results.urgentMatters.forEach((matter, index) => {
        const card = document.createElement('div');
        card.className = `recommendation-card urgency-${matter.urgency}`;
        
        card.innerHTML = `
          <div class="recommendation-header">
            <div>
              <div class="recommendation-title">
                ${matter.icon} ${matter.name}
              </div>
              <div class="urgency-badge ${matter.urgency}">
                ${getUrgencyText(matter.urgency)}
              </div>
            </div>
          </div>
          <div class="analysis-details">
            <div class="detail-section">
              <div class="detail-label">เหตุผลประกอบ:</div>
              <div class="detail-value">${matter.analysis.why}</div>
            </div>
            <div class="detail-section">
              <div class="detail-label">ผลิตภัณฑ์ที่แนะนำ:</div>
              <div class="detail-value">
                ${matter.analysis.recommendedProducts.map(product => 
                  `<span class="product-tag">${product}</span>`
                ).join('')}
              </div>
            </div>
            <div class="detail-section">
              <div class="detail-label">ประโยชน์ที่ตอบโจทย์:</div>
              <div class="detail-value">
                <ul>
                  ${matter.analysis.benefits.map(benefit => 
                    `<li>${benefit}</li>`
                  ).join('')}
                </ul>
              </div>
            </div>
          </div>
        `;
        
        container.appendChild(card);
      });

      $('analysisResults').scrollIntoView({ behavior: 'smooth' });
    }

    function getUrgencyText(urgency) {
      const texts = {
        critical: 'ด่วนมาก',
        high: 'ด่วน',
        medium: 'ควรพิจารณา',
        low: 'ข้อมูลเพิ่มเติม'
      };
      return texts[urgency] || 'ควรพิจารณา';
    }

    function showAnalysisError(error) {
      $('recommendationList').innerHTML = `
        <div style="text-align: center; padding: 40px 20px; color: var(--red);">
          <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
          <p>เกิดข้อผิดพลาดในการวิเคราะห์</p>
          <small>${error.message}</small>
        </div>
      `;
    }

    function autoFillRecommendations(recommendations) {
      if (recommendations.length > 0) {
        const topProduct = recommendations[0];
        $('emp_proposed_product').value = recommendations.map(r => r.product).join(', ');
        $('emp_proposed_premium').value = topProduct.premium;
        $('emp_proposed_capital').value = topProduct.capital;
        
        const comment = `ระบบแนะนำ: ${recommendations.map(r => r.product).join(', ')} - ${topProduct.reason}`;
        $('emp_additional_comments').value = comment;
      }
    }

    // Search and Management Functions
    async function loadCustomerList() {
      try {
        const customers = await dataService.loadCustomers();
        customersData = customers;
        // ไม่แสดงข้อมูลทันที แต่จะแสดงเฉพาะเมื่อค้นหาแล้ว
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    function displayCustomerList(customers) {
      const container = $('customerList');
      if (!container) return;

      container.innerHTML = '';

      if (customers.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px;"></i>
            <p>ไม่พบข้อมูลลูกค้าตามเงื่อนไขที่ค้นหา</p>
          </div>
        `;
        $('portfolioDashboard').style.display = 'none';
        return;
      }

      customers.forEach(customer => {
        const item = document.createElement('div');
        item.className = 'customer-item';
        item.innerHTML = `
          <div class="customer-item-header">
            <div class="customer-name">${customer.name}</div>
            <div class="customer-id">${customer.customer_id}</div>
          </div>
          <div class="customer-details">
            <span>อายุ: ${customer.age} ปี</span>
            <span>อาชีพ: ${customer.occupation}</span>
            <span>RH: ${customer.employee_info?.rh || 'N/A'}</span>
          </div>
          <div class="customer-details">
            <span>พนักงาน: ${customer.employee_info?.name || 'N/A'}</span>
            <span>ตำแหน่ง: ${customer.employee_info?.position || 'N/A'}</span>
            <span>วันที่สร้าง: ${new Date(customer.created_at).toLocaleDateString('th-TH')}</span>
          </div>
          <div class="action-security">
            <div class="ios-input-group">
              <label class="ios-label">รหัสพนักงานสำหรับดำเนินการ</label>
              <input type="password" class="ios-input security-code-input" placeholder="กรอกรหัสพนักงาน" data-customer-id="${customer.customer_id}">
            </div>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
              <button class="ios-btn ios-btn-secondary btn-view-details" data-customer-id="${customer.customer_id}">
                <i class="fas fa-eye"></i>
                ดูรายละเอียด
              </button>
              <button class="ios-btn ios-btn-secondary btn-add-comment" data-customer-id="${customer.customer_id}">
                <i class="fas fa-comment"></i>
                เพิ่มความเห็น
              </button>
            </div>
          </div>
        `;
        
        // Add event listeners for action buttons
        const viewBtn = item.querySelector('.btn-view-details');
        const commentBtn = item.querySelector('.btn-add-comment');
        const securityInput = item.querySelector('.security-code-input');
        
        viewBtn.addEventListener('click', function() {
          const customerId = this.getAttribute('data-customer-id');
          const securityCode = securityInput.value;
          if (!securityCode) {
            alert('กรุณากรอกรหัสพนักงานก่อนดำเนินการ');
            return;
          }
          viewCustomerDetails(customerId, securityCode);
        });
        
        commentBtn.addEventListener('click', function() {
          const customerId = this.getAttribute('data-customer-id');
          const securityCode = securityInput.value;
          if (!securityCode) {
            alert('กรุณากรอกรหัสพนักงานก่อนดำเนินการ');
            return;
          }
          addCommentToCustomer(customerId, securityCode);
        });
        
        container.appendChild(item);
      });

      // Show portfolio dashboard if we have results
      $('portfolioDashboard').style.display = 'block';
      updatePortfolioDashboard(customers);
    }

    function updatePortfolioDashboard(customers) {
      if (!customers || customers.length === 0) return;

      // Aggregate all policies
      const allPolicies = customers.flatMap(customer => 
        customer.insurance_policies || []
      );

      // Use first customer for financial ratios (or aggregate if needed)
      const sampleCustomer = customers[0];

      // Render charts
      dashboard.renderInsuranceTypeChart(allPolicies);
      dashboard.renderFinancialRatioChart(sampleCustomer);

      // Analyze portfolio
      const analysis = dashboard.analyzePortfolio(allPolicies, sampleCustomer);
      dashboard.renderPortfolioAnalysis(analysis);
    }

    function performSearch() {
      const rh = $('search_rh').value;
      const zone = $('search_zone').value;
      const employeeName = $('search_employee_name').value.toLowerCase();
      const employeeId = $('search_employee_id').value.toLowerCase();
      const customerId = $('search_customer_id').value.toLowerCase();

      const filtered = customersData.filter(customer => {
        return (!rh || customer.employee_info?.rh === rh) &&
               (!zone || customer.employee_info?.zone === zone) &&
               (!employeeName || customer.employee_info?.name.toLowerCase().includes(employeeName)) &&
               (!employeeId || customer.employee_info?.id.toLowerCase().includes(employeeId)) &&
               (!customerId || customer.customer_id.toLowerCase().includes(customerId));
      });

      displayCustomerList(filtered);
    }

    function clearSearch() {
      $('search_rh').value = '';
      $('search_zone').value = '';
      $('search_employee_name').value = '';
      $('search_employee_id').value = '';
      $('search_customer_id').value = '';
      $('customerList').innerHTML = `
        <div class="search-placeholder">
          <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; color: var(--gray-4);"></i>
          <p>กรุณาใช้ฟิลเตอร์ด้านบนเพื่อค้นหาข้อมูลลูกค้า</p>
          <small style="color: var(--text-secondary);">ระบบจะแสดงข้อมูลเฉพาะเมื่อค้นหาแล้วเท่านั้น</small>
        </div>
      `;
      $('portfolioDashboard').style.display = 'none';
    }

    function viewCustomerDetails(customerId, securityCode) {
      // ตรวจสอบรหัสพนักงานหรือ special pass code
      if (securityCode !== SPECIAL_PASSCODE) {
        const customer = customersData.find(c => c.customer_id === customerId);
        if (!customer || customer.employee_info?.id !== securityCode) {
          alert('รหัสพนักงานไม่ถูกต้อง');
          return;
        }
      }
      
      const customer = customersData.find(c => c.customer_id === customerId);
      if (customer) {
        alert(`ดูรายละเอียดลูกค้า: ${customer.name} (${customer.customer_id})\n\n` +
              `อายุ: ${customer.age} ปี\n` +
              `อาชีพ: ${customer.occupation}\n` +
              `รายได้: ${customer.monthly_income?.toLocaleString()} บาท/เดือน\n` +
              `พนักงาน: ${customer.employee_info?.name} (${customer.employee_info?.position})`);
      }
    }

    function addCommentToCustomer(customerId, securityCode) {
      // ตรวจสอบรหัสพนักงานหรือ special pass code
      if (securityCode !== SPECIAL_PASSCODE) {
        const customer = customersData.find(c => c.customer_id === customerId);
        if (!customer || customer.employee_info?.id !== securityCode) {
          alert('รหัสพนักงานไม่ถูกต้อง');
          return;
        }
      }
      
      const comment = prompt('กรอกความเห็นเพิ่มเติม:');
      if (comment) {
        alert(`เพิ่มความเห็นให้ลูกค้า ${customerId} เรียบร้อยแล้ว\nความเห็น: ${comment}`);
        // ในระบบจริงควรบันทึกความเห็นลงฐานข้อมูล
      }
    }

    // Report and Dashboard Functions
    function updateDashboardStats() {
      // Simple stats for demo
      $('totalCustomers').textContent = customersData.length;
      $('totalAnalysis').textContent = Math.floor(customersData.length * 0.7);
      $('successRate').textContent = '72%';
    }

    function showSecurityModal(context) {
      $('securityModal').style.display = 'flex';
      $('securityModal').dataset.context = context;
      $('securityPassword').value = '';
    }

    function hideSecurityModal() {
      $('securityModal').style.display = 'none';
      $('securityPassword').value = '';
    }

    function handleSecurityConfirm() {
      const password = $('securityPassword').value;
      const context = $('securityModal').dataset.context;

      // ตรวจสอบ special pass code สำหรับปลดล็อคทุกอย่าง
      if (password === SPECIAL_PASSCODE) {
        // Special pass code ปลดล็อคทุกอย่าง
        if (context === 'report') {
          $('reportContent').style.display = 'block';
          $('btnAccessReport').style.display = 'none';
          updateReportStats();
        } else if (context === 'export_excel' || context === 'export_pdf') {
          alert(`ส่งออกข้อมูลในรูปแบบ ${context === 'export_excel' ? 'Excel' : 'PDF'} เรียบร้อยแล้ว (ใช้ special pass code)`);
        }
        hideSecurityModal();
        return;
      }

      // ตรวจสอบรหัสผ่านปกติ
      if (context === 'report' && (password === REPORT_PASSCODE || password === SPECIAL_PASSCODE)) {
        $('reportContent').style.display = 'block';
        $('btnAccessReport').style.display = 'none';
        updateReportStats();
      } else if ((context === 'export_excel' || context === 'export_pdf') && (password === EXPORT_PASSCODE || password === SPECIAL_PASSCODE)) {
        alert(`ส่งออกข้อมูลในรูปแบบ ${context === 'export_excel' ? 'Excel' : 'PDF'} เรียบร้อยแล้ว`);
      } else {
        alert('รหัสผ่านไม่ถูกต้อง');
        return;
      }

      hideSecurityModal();
    }

    function updateReportStats() {
      $('reportTotalCustomers').textContent = customersData.length;
      $('reportMTD').textContent = Math.floor(customersData.length * 0.15);
      $('reportByRH').textContent = Math.floor(customersData.length * 0.25);
      $('reportByPosition').textContent = Math.floor(customersData.length * 0.35);
    }

    function confirmDelete(type) {
      const warning = $('deleteWarning');
      warning.style.display = 'block';
      
      warning.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        คุณกำลังจะลบข้อมูล${getDeleteTypeText(type)} การกระทำนี้ไม่สามารถกู้คืนได้
        <div style="margin-top: 8px;">
          <button class="ios-btn ios-btn-primary" onclick="executeDelete('${type}')" style="margin-right: 8px;">
            ยืนยันการลบ
          </button>
          <button class="ios-btn ios-btn-secondary" onclick="$('deleteWarning').style.display = 'none'">
            ยกเลิก
          </button>
        </div>
      `;
    }

    function getDeleteTypeText(type) {
      const texts = {
        selected: 'ที่เลือก',
        last_month: 'เดือนล่าสุด',
        oldest: 'เก่าที่สุด',
        all: 'ทั้งหมด'
      };
      return texts[type] || '';
    }

    function executeDelete(type) {
      alert(`ลบข้อมูล${getDeleteTypeText(type)} เรียบร้อยแล้ว`);
      $('deleteWarning').style.display = 'none';
      
      if (type === 'all') {
        console.log('ส่งอีเมลแจ้งเตือนไปที่ Yannapat.rbac@gmail.com: ข้อมูลทั้งหมดถูกลบแล้ว');
      }
    }

    async function loadInitialData() {
      try {
        await loadCustomerList();
        updateDashboardStats();
        console.log('✅ ASI System initialized successfully');
      } catch (error) {
        console.error('Error initializing app:', error);
      }
    }

    // Make functions available globally for HTML onclick handlers
    window.executeDelete = executeDelete;
  </script>
</body>
</html>
