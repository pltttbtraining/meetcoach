<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>PLT-ttb Training</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #007AFF;
      --primary-dark: #0056CC;
      --secondary: #5856D6;
      --green: #34C759;
      --orange: #FF9500;
      --red: #FF3B30;
      --gray-1: #8E8E93;
      --gray-2: #AEAEB2;
      --gray-3: #C7C7CC;
      --gray-4: #D1D1D6;
      --gray-5: #E5E5EA;
      --gray-6: #F2F2F7;
      --background: #FFFFFF;
      --card-background: #FFFFFF;
      --text-primary: #000000;
      --text-secondary: #8E8E93;
      --system-blur: rgba(255, 255, 255, 0.8);
      --system-border: rgba(0, 0, 0, 0.1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background: #000000;
        --card-background: #1C1C1E;
        --text-primary: #FFFFFF;
        --text-secondary: #8E8E93;
        --system-blur: rgba(30, 30, 32, 0.8);
        --system-border: rgba(255, 255, 255, 0.1);
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.47;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* iOS Style Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--background);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .loading-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      animation: logoPulse 2s ease-in-out infinite;
    }

    .loading-logo i {
      font-size: 32px;
      color: white;
    }

    .loading-text {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .loading-subtext {
      font-size: 17px;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .ios-progress {
      width: 200px;
      height: 4px;
      background: var(--gray-5);
      border-radius: 2px;
      overflow: hidden;
    }

    .ios-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      width: 0%;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 2px;
    }

    /* Main App Container */
    .app-container {
      min-height: 100vh;
      display: none;
      flex-direction: column;
      background: var(--background);
    }

    /* iOS Style Navigation Bar */
    .ios-navbar {
      background: var(--system-blur);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--system-border);
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .nav-brand {
      font-size: 21px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-brand-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-brand-icon i {
      font-size: 16px;
      color: white;
    }

    .nav-actions {
      display: flex;
      gap: 8px;
    }

    /* iOS Style Buttons */
    .ios-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
    }

    .ios-btn-primary {
      background: var(--primary);
      color: white;
    }

    .ios-btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .ios-btn-secondary {
      background: var(--gray-6);
      color: var(--text-primary);
    }

    .ios-btn-secondary:hover {
      background: var(--gray-5);
    }

    /* Content Area */
    .content-area {
      flex: 1;
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    /* iOS Style Cards */
    .ios-card {
      background: var(--card-background);
      border-radius: 12px;
      padding: 0;
      margin-bottom: 16px;
      border: 1px solid var(--system-border);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .ios-card-header {
      padding: 16px;
      border-bottom: 1px solid var(--system-border);
      background: var(--card-background);
    }

    .ios-card-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ios-card-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
    }

    .ios-card-body {
      padding: 16px;
    }

    /* iOS Style Form Elements */
    .form-section {
      margin-bottom: 24px;
    }

    .section-header {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 12px;
      padding-left: 16px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ios-input-group {
      margin-bottom: 16px;
    }

    .ios-label {
      display: block;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-primary);
      padding: 0 16px;
    }

    .ios-label.required::after {
      content: " *";
      color: var(--red);
    }

    .ios-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--card-background);
      border: 1px solid var(--system-border);
      border-radius: 10px;
      font-size: 16px;
      color: var(--text-primary);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ios-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
    }

    .ios-select {
      width: 100%;
      padding: 12px 16px;
      background: var(--card-background);
      border: 1px solid var(--system-border);
      border-radius: 10px;
      font-size: 16px;
      color: var(--text-primary);
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%238E8E93' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 10px;
    }

    /* Checkbox Styles */
    .unknown-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding: 0 16px;
    }

    .unknown-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 2px solid var(--gray-3);
      background: var(--card-background);
    }

    .unknown-checkbox label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Customer ID Display */
    .customer-id-display {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      font-weight: 600;
      font-size: 16px;
      display: none;
    }

    /* iOS Style Analysis Results */
    .analysis-section {
      margin-top: 24px;
    }

    .recommendation-grid {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    .recommendation-card {
      background: var(--card-background);
      border: 1px solid var(--system-border);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .recommendation-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .recommendation-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .recommendation-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .recommendation-badge {
      background: var(--primary);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }

    .recommendation-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .detail-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .detail-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .recommendation-reason {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* iOS Style Tabs */
    .ios-tabs {
      display: flex;
      background: var(--card-background);
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 20px;
      border: 1px solid var(--system-border);
    }

    .ios-tab {
      flex: 1;
      padding: 8px 12px;
      text-align: center;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ios-tab.active {
      background: var(--primary);
      color: white;
    }

    /* Form Status */
    .form-status {
      padding: 12px 16px;
      background: var(--green);
      color: white;
      border-radius: 10px;
      margin-top: 16px;
      font-size: 14px;
      display: none;
    }

    /* Content Panels */
    .content-panel {
      display: none;
    }

    .content-panel.active {
      display: block;
    }

    /* Animations */
    @keyframes logoPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .content-area {
        padding: 12px;
      }
      
      .nav-content {
        flex-direction: column;
        gap: 12px;
      }
      
      .recommendation-details {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Form Grid */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: var(--gray-6);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-3);
      border-radius: 2px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-2);
    }
  </style>
</head>
<body>
  <!-- iOS Style Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">
      <i class="fas fa-chart-line"></i>
    </div>
    <h1 class="loading-text">PLT-ttb Training</h1>
    <p class="loading-subtext">Account Planning System</p>
    <div class="ios-progress">
      <div class="ios-progress-bar" id="loadingProgress"></div>
    </div>
  </div>

  <!-- Main Application -->
  <div class="app-container" id="appContainer">
    <!-- iOS Style Navigation Bar -->
    <nav class="ios-navbar">
      <div class="nav-content">
        <div class="nav-brand">
          <div class="nav-brand-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <span>PLT-ttb</span>
        </div>
        <div class="nav-actions">
          <button class="ios-btn ios-btn-secondary" id="btnLogout">
            <i class="fas fa-door-open"></i>
            Sign Out
          </button>
        </div>
      </div>
    </nav>

    <!-- Content Area -->
    <div class="content-area">
      <!-- iOS Style Tabs -->
      <div class="ios-tabs">
        <div class="ios-tab active" data-panel="start">
          <i class="fas fa-house"></i>
          หน้าแรก
        </div>
        <div class="ios-tab" data-panel="form">
          <i class="fas fa-user-plus"></i>
          สร้างลูกค้า
        </div>
        <div class="ios-tab" data-panel="list">
          <i class="fas fa-list"></i>
          รายการ
        </div>
        <div class="ios-tab" data-panel="report">
          <i class="fas fa-chart-bar"></i>
          รายงาน
        </div>
      </div>

      <!-- Start Panel -->
      <div id="panel-start" class="content-panel active fade-in">
        <div class="ios-card">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-rocket" style="color: var(--primary);"></i>
              ยินดีต้อนรับ
            </h2>
            <p class="ios-card-subtitle">ระบบวางแผนการขายและบริหารลูกค้าแบบบูรณาการ</p>
          </div>
          <div class="ios-card-body">
            <div style="text-align: center; padding: 40px 20px;">
              <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 24px;">
                <i class="fas fa-brain" style="font-size: 32px; color: white;"></i>
              </div>
              <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">เริ่มต้นใช้งาน</h3>
              <p style="color: var(--text-secondary); margin-bottom: 32px;">ระบบ AI จะช่วยวิเคราะห์และแนะนำผลิตภัณฑ์ประกันภัยที่เหมาะสมที่สุด</p>
              <button class="ios-btn ios-btn-primary" id="btnStart" style="padding: 12px 32px; font-size: 17px;">
                <i class="fas fa-play"></i>
                เริ่มต้นใช้งาน
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Panel -->
      <div id="panel-form" class="content-panel">
        <div class="ios-card">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-user-plus" style="color: var(--primary);"></i>
              สร้างโปรไฟล์ลูกค้า
            </h2>
            <p class="ios-card-subtitle">กรอกข้อมูลลูกค้าเพื่อรับการวิเคราะห์จาก AI</p>
          </div>
          <div class="ios-card-body">
            <!-- Customer ID Display -->
            <div class="customer-id-display" id="customerIdDisplay">
              <i class="fas fa-id-card"></i>
              Customer ID: กำลังสร้าง...
            </div>

            <!-- Employee Information -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-user-tie"></i>
                ข้อมูลพนักงาน
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">ชื่อพนักงาน</label>
                  <input type="text" class="ios-input" id="employee_name" placeholder="กรอกชื่อพนักงาน">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label required">รหัสพนักงาน</label>
                  <input type="text" class="ios-input" id="employee_id" placeholder="กรอกรหัสพนักงาน">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">RH</label>
                  <select class="ios-select" id="rh">
                    <option value="">เลือก RH</option>
                    <option value="RH1">RH1</option>
                    <option value="RH2">RH2</option>
                    <option value="RH3">RH3</option>
                    <option value="RH4">RH4</option>
                    <option value="RH5">RH5</option>
                  </select>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label required">Zone</label>
                  <select class="ios-select" id="zone" disabled>
                    <option value="">เลือก RH ก่อน</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Customer Personal Information -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-user"></i>
                ข้อมูลส่วนตัวลูกค้า
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">ชื่อนามสมมุติ</label>
                  <input type="text" class="ios-input" id="cust_name" placeholder="กรอกชื่อลูกค้า">
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_name_unknown">
                    <label for="cust_name_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label required">อายุ</label>
                  <input type="number" class="ios-input" id="cust_age" placeholder="กรอกอายุ">
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_age_unknown">
                    <label for="cust_age_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">เพศ</label>
                  <select class="ios-select" id="cust_gender">
                    <option value="">เลือกเพศ</option>
                    <option>ชาย</option>
                    <option>หญิง</option>
                    <option>อื่นๆ</option>
                  </select>
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_gender_unknown">
                    <label for="cust_gender_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label required">อาชีพ</label>
                  <select class="ios-select" id="cust_occupation">
                    <option value="">เลือกอาชีพ</option>
                    <option>พนักงานบริษัท</option>
                    <option>ข้าราชการ</option>
                    <option>เจ้าของกิจการ/ธุรกิจส่วนตัว</option>
                    <option>แพทย์</option>
                    <option>วิศวกร</option>
                    <option>ครู</option>
                    <option>นักกฎหมาย</option>
                    <option>อื่นๆ</option>
                  </select>
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_occupation_unknown">
                    <label for="cust_occupation_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">รายได้ต่อเดือน (บาท)</label>
                  <input type="number" class="ios-input" id="cust_monthly_income" placeholder="กรอกรายได้ต่อเดือน">
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_monthly_income_unknown">
                    <label for="cust_monthly_income_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">รายได้ต่อปี (บาท)</label>
                  <input type="text" class="ios-input" id="cust_yearly_income" readonly placeholder="คำนวณอัตโนมัติ">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">มีสวัสดิการหรือไม่</label>
                  <select class="ios-select" id="cust_welfare">
                    <option value="">เลือก</option>
                    <option>ไม่มี</option>
                    <option>มี - วงเงินสูง</option>
                    <option>มี - วงเงินกลาง</option>
                    <option>มี - วงเงินต่ำ</option>
                    <option>มี - ทุนประกันต่อปี</option>
                  </select>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">ทุนประกันต่อปี (บาท)</label>
                  <input type="number" class="ios-input" id="cust_insurance_capital" placeholder="กรอกทุนประกัน">
                </div>
              </div>
            </div>

            <!-- Family Information -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-users"></i>
                ข้อมูลครอบครัว
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">สถานภาพ</label>
                  <select class="ios-select" id="cust_marital_status">
                    <option value="">เลือกสถานภาพ</option>
                    <option>โสด</option>
                    <option>สมรส</option>
                    <option>หม้าย</option>
                    <option>หย่า</option>
                  </select>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">อายุคู่สมรส</label>
                  <input type="number" class="ios-input" id="cust_spouse_age" placeholder="กรอกอายุคู่สมรส">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">อาชีพคู่สมรส</label>
                  <select class="ios-select" id="cust_spouse_occupation">
                    <option value="">เลือกอาชีพ</option>
                    <option>ไม่มี</option>
                    <option>พนักงานบริษัท</option>
                    <option>ข้าราชการ</option>
                    <option>เจ้าของกิจการ/ธุรกิจส่วนตัว</option>
                    <option>แพทย์</option>
                    <option>วิศวกร</option>
                    <option>ครู</option>
                    <option>แม่บ้าน</option>
                    <option>อื่นๆ</option>
                  </select>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">มีบุตรหรือไม่</label>
                  <select class="ios-select" id="cust_has_children">
                    <option value="">เลือก</option>
                    <option>ไม่มี</option>
                    <option>มี</option>
                  </select>
                </div>
              </div>
              <div id="children-section" style="display: none;">
                <div class="form-grid">
                  <div class="ios-input-group">
                    <label class="ios-label">จำนวนบุตร</label>
                    <input type="number" class="ios-input" id="cust_children_count" placeholder="กรอกจำนวนบุตร">
                  </div>
                  <div class="ios-input-group">
                    <label class="ios-label">อายุบุตร</label>
                    <input type="text" class="ios-input" id="cust_children_ages" placeholder="เช่น 8,5,2">
                  </div>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">อาชีพบุตร</label>
                  <select class="ios-select" id="cust_children_occupation">
                    <option value="">เลือกอาชีพ</option>
                    <option>นักเรียน</option>
                    <option>นักศึกษา</option>
                    <option>พนักงานบริษัท</option>
                    <option>อื่นๆ</option>
                  </select>
                </div>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">มีบุคคลอื่นที่ต้องดูแลหรือไม่</label>
                <select class="ios-select" id="cust_has_dependents">
                  <option value="">เลือก</option>
                    <option>ไม่มี</option>
                    <option>มี</option>
                </select>
              </div>
              <div id="dependents-section" style="display: none;">
                <div class="ios-input-group">
                  <label class="ios-label">รายละเอียดบุคคลที่ต้องดูแล</label>
                  <textarea class="ios-input" id="cust_dependents_details" rows="3" placeholder="กรอกรายละเอียด"></textarea>
                </div>
              </div>
            </div>

            <!-- Business Information -->
            <div class="form-section" id="business-section" style="display: none;">
              <h3 class="section-header">
                <i class="fas fa-briefcase"></i>
                ข้อมูลธุรกิจ
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">ประเภทธุรกิจ/กิจการ</label>
                  <input type="text" class="ios-input" id="cust_business_type" placeholder="กรอกประเภทธุรกิจ">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">ทุนจดทะเบียน (บาท)</label>
                  <input type="number" class="ios-input" id="cust_business_capital" placeholder="กรอกทุนจดทะเบียน">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">รายได้ต่อปี (บาท)</label>
                  <input type="number" class="ios-input" id="cust_business_income" placeholder="กรอกรายได้ต่อปี">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">กำไร (บาท)</label>
                  <input type="number" class="ios-input" id="cust_business_profit" placeholder="กรอกกำไร">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">ภาษีที่เสียปีล่าสุด (บาท)</label>
                  <input type="number" class="ios-input" id="cust_business_tax" placeholder="กรอกภาษี">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">สัดส่วนหุ้นที่ถือครอง (%)</label>
                  <input type="number" class="ios-input" id="cust_business_share" placeholder="กรอกสัดส่วนหุ้น" min="0" max="100">
                </div>
              </div>
            </div>

            <!-- Financial Products -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-piggy-bank"></i>
                ผลิตภัณฑ์ทางการเงินที่ถือครอง
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">เงินฝากออมทรัพย์ (บาท)</label>
                  <input type="number" class="ios-input" id="prod_savings" placeholder="กรอกจำนวนเงิน">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">เงินฝากประจำ (บาท)</label>
                  <input type="number" class="ios-input" id="prod_fixed" placeholder="กรอกจำนวนเงิน">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">กองทุน (บาท)</label>
                  <input type="number" class="ios-input" id="prod_fund" placeholder="กรอกจำนวนเงิน">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">บัตรเครดิต (บาท)</label>
                  <input type="number" class="ios-input" id="prod_credit_card" placeholder="กรอกจำนวนเงิน">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">เงินกู้บ้าน (บาท)</label>
                  <input type="number" class="ios-input" id="prod_home_loan" placeholder="กรอกจำนวนเงิน">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">เงินกู้รถ (บาท)</label>
                  <input type="number" class="ios-input" id="prod_car_loan" placeholder="กรอกจำนวนเงิน">
                </div>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">เงินกู้ส่วนบุคคล (บาท)</label>
                <input type="number" class="ios-input" id="prod_personal_loan" placeholder="กรอกจำนวนเงิน">
              </div>
            </div>

            <!-- AI Analysis Section -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-robot"></i>
                AI Insurance Advisor
              </h3>
              <div style="text-align: center; padding: 20px;">
                <button class="ios-btn ios-btn-primary" id="btnAnalyze" style="padding: 16px 32px; font-size: 17px;">
                  <i class="fas fa-magic"></i>
                  วิเคราะห์ด้วย AI
                </button>
                <p style="color: var(--text-secondary); margin-top: 12px; font-size: 15px;">
                  ระบบจะวิเคราะห์ข้อมูลและแนะนำผลิตภัณฑ์ที่เหมาะสมที่สุด
                </p>
              </div>
            </div>

            <!-- Employee Comments -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-comments"></i>
                ความเห็นพนักงาน
              </h3>
              <div class="ios-input-group">
                <label class="ios-label">ความเห็นเพิ่มเติม</label>
                <textarea class="ios-input" id="emp_additional_comments" rows="3" placeholder="กรอกความเห็นเพิ่มเติม"></textarea>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">เคยนำเสนอผลิตภัณฑ์แล้วหรือไม่</label>
                <select class="ios-select" id="emp_presented_before">
                  <option value="">เลือก</option>
                  <option>ยังไม่เคยนำเสนอ</option>
                  <option>เคยนำเสนอแล้ว</option>
                  <option>เคยนำเสนอมากกว่า 3 ครั้ง</option>
                </select>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">ลูกค้าเคยโต้แย้งหรือมีความคิดเห็นอย่างไร</label>
                <textarea class="ios-input" id="emp_customer_feedback" rows="2" placeholder="กรอกความคิดเห็นลูกค้า"></textarea>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">ผลิตภัณฑ์ที่จะนำเสนอ</label>
                  <input type="text" class="ios-input" id="emp_proposed_product" placeholder="กรอกผลิตภัณฑ์">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">เบี้ยประกันที่คาดหวัง (บาท)</label>
                  <input type="number" class="ios-input" id="emp_proposed_premium" placeholder="กรอกเบี้ยประกัน">
                </div>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">ทุนประกันที่คาดหวัง (บาท)</label>
                <input type="number" class="ios-input" id="emp_proposed_capital" placeholder="กรอกทุนประกัน">
              </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button class="ios-btn ios-btn-secondary" id="btnClear" style="flex: 1;">
                <i class="fas fa-broom"></i>
                ล้างข้อมูล
              </button>
              <button class="ios-btn ios-btn-primary" id="btnSave" style="flex: 1;">
                <i class="fas fa-save"></i>
                บันทึกข้อมูล
              </button>
            </div>

            <!-- Form Status -->
            <div class="form-status" id="formStatus"></div>
          </div>
        </div>

        <!-- Analysis Results -->
        <div class="ios-card" id="analysisResults" style="display: none;">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-chart-line" style="color: var(--green);"></i>
              ผลการวิเคราะห์
            </h2>
            <p class="ios-card-subtitle">คำแนะนำจากระบบ AI Advisor</p>
          </div>
          <div class="ios-card-body">
            <div class="recommendation-grid" id="recommendationList">
              <!-- Recommendations will be inserted here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Other Panels -->
      <div id="panel-list" class="content-panel">
        <div class="ios-card">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-list" style="color: var(--primary);"></i>
              รายการลูกค้า
            </h2>
          </div>
          <div class="ios-card-body">
            <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
              <i class="fas fa-list-alt" style="font-size: 48px; margin-bottom: 16px;"></i>
              <p>ระบบกำลังพัฒนา</p>
            </div>
          </div>
        </div>
      </div>

      <div id="panel-report" class="content-panel">
        <div class="ios-card">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-chart-bar" style="color: var(--primary);"></i>
              รายงานและสถิติ
            </h2>
          </div>
          <div class="ios-card-body">
            <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
              <i class="fas fa-chart-pie" style="font-size: 48px; margin-bottom: 16px;"></i>
              <p>ระบบกำลังพัฒนา</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============================================
    // System Configuration
    // =============================================
    const STORAGE_KEY = 'aps_customers';
    const AUDIT_KEY = 'aps_audit';
    const COUNTER_KEY = 'aps_counters';

    // DOM Helper
    const $ = (id) => document.getElementById(id);

    // System State
    let currentPanel = 'start';
    let currentCustomerId = '';
    let insurancePolicyCount = 0;

    // =============================================
    // Integrated Insurance Advisor Classes
    // =============================================

    class AdvancedInsuranceAdvisor {
      constructor() {
        this.products = this.initializeProducts();
        this.riskFactors = this.initializeRiskFactors();
      }

      initializeProducts() {
        return {
          'ประกันสุขภาพ IPD': { category: 'health', minAge: 0, maxAge: 70, priority: 1 },
          'ประกันสุขภาพ OPD': { category: 'health', minAge: 0, maxAge: 65, priority: 2 },
          'ประกันโรคร้ายแรง': { category: 'health', minAge: 25, maxAge: 60, priority: 3 },
          'ประกันโรคมะเร็ง': { category: 'health', minAge: 20, maxAge: 65, priority: 4 },
          'ประกันชีวิตแบบสะสมทรัพย์': { category: 'life', minAge: 20, maxAge: 55, priority: 5 },
          'ประกันชีวิตแบบตลอดชีพ': { category: 'life', minAge: 25, maxAge: 50, priority: 6 },
          'ประกันชีวิตแบบชั่วระยะเวลา': { category: 'life', minAge: 20, maxAge: 60, priority: 7 },
          'ประกันอุบัติเหตุส่วนบุคคล': { category: 'accident', minAge: 18, maxAge: 65, priority: 8 },
          'ประกันทุพพลภาพ': { category: 'accident', minAge: 20, maxAge: 55, priority: 9 },
          'ประกันบำนาญ': { category: 'retirement', minAge: 30, maxAge: 50, priority: 10 },
          'ประกันการศึกษา': { category: 'savings', minAge: 25, maxAge: 45, priority: 11 }
        };
      }

      initializeRiskFactors() {
        return {
          occupation: {
            'แพทย์': { health: 8, accident: 6, life: 5 },
            'วิศวกร': { health: 5, accident: 7, life: 4 },
            'ครู': { health: 4, accident: 3, life: 4 },
            'นักกฎหมาย': { health: 6, accident: 4, life: 5 },
            'เจ้าของกิจการ/ธุรกิจส่วนตัว': { health: 7, accident: 5, life: 8 },
            'พนักงานบริษัท': { health: 4, accident: 3, life: 4 },
            'ข้าราชการ': { health: 3, accident: 2, life: 3 }
          }
        };
      }

      analyzeCustomer(customer) {
        const profile = this.createDetailedProfile(customer);
        const analysis = this.performMultiDimensionalAnalysis(profile);
        return this.generateRecommendations(analysis, profile);
      }

      createDetailedProfile(customer) {
        return {
          age: customer.age || 0,
          gender: customer.gender || '',
          occupation: customer.occupation || '',
          income: {
            monthly: customer.monthly_income || 0,
            yearly: (customer.monthly_income || 0) * 12,
            tier: this.getIncomeTier(customer.monthly_income || 0)
          },
          family: {
            maritalStatus: customer.marital_status || '',
            hasChildren: customer.has_children === 'มี',
            childrenCount: customer.children_count || 0,
            childrenAges: this.parseChildrenAges(customer.children_ages)
          },
          lifeStage: this.determineLifeStage(customer),
          risk: {
            occupationRisk: this.calculateOccupationRisk(customer.occupation),
            level: this.calculateOverallRisk(customer)
          }
        };
      }

      performMultiDimensionalAnalysis(profile) {
        return {
          needs: {
            health: this.analyzeHealthNeeds(profile),
            life: this.analyzeLifeInsuranceNeeds(profile),
            retirement: this.analyzeRetirementNeeds(profile),
            education: profile.family.hasChildren ? this.analyzeEducationNeeds(profile) : []
          }
        };
      }

      analyzeHealthNeeds(profile) {
        const needs = [];
        const age = profile.age;

        needs.push({
          type: 'basic_health',
          priority: 'high',
          reason: 'ความคุ้มครองพื้นฐานสำหรับค่ารักษาพยาบาล'
        });

        if (age >= 30) {
          needs.push({
            type: 'critical_illness',
            priority: age >= 40 ? 'high' : 'medium',
            reason: `อายุ ${age} ปี เป็นกลุ่มเสี่ยงโรคเรื้อรัง`
          });
        }

        if (age >= 35) {
          needs.push({
            type: 'cancer',
            priority: age >= 45 ? 'high' : 'medium',
            reason: 'ความเสี่ยงโรคมะเร็งเพิ่มขึ้นตามอายุ'
          });
        }

        return needs;
      }

      analyzeLifeInsuranceNeeds(profile) {
        const needs = [];
        const { family, income } = profile;

        if (income.monthly > 0) {
          needs.push({
            type: 'income_replacement',
            priority: 'high',
            reason: `แทนที่รายได้ ${income.monthly.toLocaleString()} บาท/เดือน`,
            suggestedCoverage: income.yearly * 5
          });
        }

        if (family.hasChildren || family.maritalStatus === 'สมรส') {
          needs.push({
            type: 'family_protection',
            priority: 'high',
            reason: `มี${family.hasChildren ? 'บุตร' : 'คู่สมรส'}ที่ต้องดูแล`,
            suggestedCoverage: this.calculateFamilyProtectionNeeds(profile)
          });
        }

        return needs;
      }

      analyzeRetirementNeeds(profile) {
        const needs = [];
        const { age, income } = profile;

        if (age >= 30) {
          const yearsToRetirement = 60 - age;
          needs.push({
            type: 'retirement_savings',
            priority: yearsToRetirement <= 15 ? 'high' : 'medium',
            reason: `เหลือเวลาอีก ${yearsToRetirement} ปีก่อนเกษียณ`,
            suggestedSavings: this.calculateRetirementNeeds(profile)
          });
        }

        return needs;
      }

      analyzeEducationNeeds(profile) {
        const needs = [];
        const childrenAges = profile.family.childrenAges;

        childrenAges.forEach((age, index) => {
          const yearsToUniversity = 18 - age;
          if (yearsToUniversity > 0 && yearsToUniversity <= 15) {
            needs.push({
              type: 'education_fund',
              priority: yearsToUniversity <= 5 ? 'high' : 'medium',
              reason: `บุตรคนที่ ${index + 1} วัย ${age} ปี จะเข้าเรียนมหาวิทยาลัยในอีก ${yearsToUniversity} ปี`,
              suggestedSavings: this.calculateEducationNeeds(age)
            });
          }
        });

        return needs;
      }

      generateRecommendations(analysis, profile) {
        const recommendations = [];
        
        if (analysis.needs.health.length > 0) {
          analysis.needs.health.forEach(need => {
            const product = this.mapNeedToProduct(need.type);
            if (product) {
              recommendations.push(this.createProductRecommendation(product, need, profile));
            }
          });
        }

        if (analysis.needs.life.length > 0) {
          analysis.needs.life.forEach(need => {
            const product = this.mapNeedToProduct(need.type);
            if (product) {
              recommendations.push(this.createProductRecommendation(product, need, profile));
            }
          });
        }

        if (analysis.needs.retirement.length > 0) {
          analysis.needs.retirement.forEach(need => {
            const product = this.mapNeedToProduct(need.type);
            if (product) {
              recommendations.push(this.createProductRecommendation(product, need, profile));
            }
          });
        }

        if (analysis.needs.education && analysis.needs.education.length > 0) {
          analysis.needs.education.forEach(need => {
            const product = this.mapNeedToProduct(need.type);
            if (product) {
              recommendations.push(this.createProductRecommendation(product, need, profile));
            }
          });
        }

        return recommendations
          .sort((a, b) => b.score - a.score)
          .slice(0, 5);
      }

      createProductRecommendation(productName, need, profile) {
        const product = this.products[productName];
        const score = this.calculateProductScore(productName, profile, need);
        const capital = this.calculateCapital(productName, profile, need);
        const premium = this.calculatePremium(productName, capital);
        const reason = this.generateReason(productName, need, profile);

        return {
          product: productName,
          score: score,
          capital: capital,
          premium: premium,
          reason: reason,
          source: 'rule_based',
          category: product.category,
          urgency: need.priority === 'high' ? 3 : need.priority === 'medium' ? 2 : 1
        };
      }

      calculateProductScore(productName, profile, need) {
        let score = 50;
        const product = this.products[productName];
        
        if (profile.age >= product.minAge && profile.age <= product.maxAge) {
          score += 20;
        }

        if (profile.income.tier === 'high' || profile.income.tier === 'premium') {
          score += 15;
        }

        if (need.priority === 'high') score += 15;
        else if (need.priority === 'medium') score += 10;

        return Math.min(score, 95);
      }

      calculateCapital(productName, profile, need) {
        const product = this.products[productName];
        let capital = 500000;

        if (profile.income.tier === 'medium') capital = 1000000;
        else if (profile.income.tier === 'high') capital = 2000000;
        else if (profile.income.tier === 'premium') capital = 3000000;

        if (need.suggestedCoverage) {
          capital = Math.max(capital, need.suggestedCoverage);
        }

        return Math.min(capital, 5000000);
      }

      calculatePremium(productName, capital) {
        const premiumRates = {
          'ประกันสุขภาพ IPD': 0.02,
          'ประกันสุขภาพ OPD': 0.015,
          'ประกันโรคร้ายแรง': 0.025,
          'ประกันโรคมะเร็ง': 0.02,
          'ประกันชีวิตแบบสะสมทรัพย์': 0.015,
          'ประกันชีวิตแบบตลอดชีพ': 0.02,
          'ประกันชีวิตแบบชั่วระยะเวลา': 0.01,
          'ประกันอุบัติเหตุส่วนบุคคล': 0.005,
          'ประกันทุพพลภาพ': 0.008,
          'ประกันบำนาญ': 0.012,
          'ประกันการศึกษา': 0.01
        };
        
        return Math.round(capital * (premiumRates[productName] || 0.02));
      }

      generateReason(productName, need, profile) {
        const reasons = {
          'ประกันสุขภาพ IPD': `อายุ ${profile.age} ปี ควรมีความคุ้มครองค่ารักษาพยาบาล`,
          'ประกันสุขภาพ OPD': `เหมาะสำหรับการรักษาพยาบาลทั่วไป`,
          'ประกันโรคร้ายแรง': `กลุ่มอายุ ${profile.age} ปี มีความเสี่ยงโรคเรื้อรัง`,
          'ประกันชีวิตแบบสะสมทรัพย์': `สร้างความมั่นคงทางการเงินพร้อมออมทรัพย์`,
          'ประกันบำนาญ': `วางแผนการเงินหลังเกษียณ อีก ${60 - profile.age} ปี`
        };

        return reasons[productName] || need.reason;
      }

      // Helper methods
      mapNeedToProduct(needType) {
        const mapping = {
          'basic_health': 'ประกันสุขภาพ IPD',
          'critical_illness': 'ประกันโรคร้ายแรง',
          'cancer': 'ประกันโรคมะเร็ง',
          'income_replacement': 'ประกันชีวิตแบบสะสมทรัพย์',
          'family_protection': 'ประกันชีวิตแบบตลอดชีพ',
          'retirement_savings': 'ประกันบำนาญ',
          'education_fund': 'ประกันการศึกษา'
        };
        return mapping[needType];
      }

      getIncomeTier(monthlyIncome) {
        if (monthlyIncome <= 25000) return 'low';
        if (monthlyIncome <= 50000) return 'medium';
        if (monthlyIncome <= 100000) return 'high';
        return 'premium';
      }

      determineLifeStage(customer) {
        const age = customer.age || 0;
        if (age <= 24) return 'student';
        if (age <= 34) return 'early_career';
        if (age <= 44) return 'family_builder';
        if (age <= 54) return 'peak_earner';
        return 'pre_retirement';
      }

      calculateOccupationRisk(occupation) {
        return this.riskFactors.occupation[occupation] || { health: 4, accident: 3, life: 4 };
      }

      calculateOverallRisk(customer) {
        let risk = 0;
        if (customer.age >= 40) risk += 2;
        if (customer.occupation === 'แพทย์' || customer.occupation === 'วิศวกร') risk += 2;
        if (customer.has_children === 'มี') risk += 1;
        return Math.min(risk, 5);
      }

      parseChildrenAges(agesString) {
        if (!agesString) return [];
        return agesString.split(',').map(age => parseInt(age.trim())).filter(age => !isNaN(age));
      }

      calculateFamilyProtectionNeeds(profile) {
        const base = profile.income.yearly * 3;
        const childrenFactor = profile.family.childrenCount * 500000;
        return base + childrenFactor;
      }

      calculateRetirementNeeds(profile) {
        const currentAge = profile.age;
        const retirementAge = 60;
        const yearsInRetirement = 25;
        const monthlyNeed = profile.income.monthly * 0.7;
        return monthlyNeed * 12 * yearsInRetirement;
      }

      calculateEducationNeeds(childAge) {
        return 1000000;
      }
    }

    class IntegratedInsuranceAdvisor {
      constructor() {
        this.ruleBasedAdvisor = new AdvancedInsuranceAdvisor();
      }

      async analyzeCustomer(customerData) {
        const customerProfile = this.ruleBasedAdvisor.createDetailedProfile(customerData);
        const recommendations = this.ruleBasedAdvisor.analyzeCustomer(customerData);
        
        return {
          analysisId: this.generateAnalysisId(),
          timestamp: new Date().toISOString(),
          sources: { ruleBased: true, ai: false, primary: 'rule_based_primary' },
          recommendations: recommendations,
          confidence: { overall: 0.8, ruleBased: 0.8, ai: 0 },
          profileSummary: {
            lifeStage: customerProfile.lifeStage,
            riskLevel: customerProfile.risk.level,
            incomeTier: customerProfile.income.tier,
            familyStatus: this.getFamilyStatus(customerProfile.family)
          }
        };
      }

      generateAnalysisId() {
        return `analysis_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      }

      getFamilyStatus(family) {
        if (family.hasChildren && family.maritalStatus === 'สมรส') return 'ครอบครัวสมบูรณ์';
        if (family.hasChildren) return 'มีบุตร';
        if (family.maritalStatus === 'สมรส') return 'สมรส';
        return 'โสด';
      }
    }

    // =============================================
    // Main Application Logic
    // =============================================

    let integratedAdvisor = new IntegratedInsuranceAdvisor();

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    function initializeApp() {
      // Simulate loading
      simulateLoading();
      
      // Tab navigation
      document.querySelectorAll('.ios-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const panel = this.getAttribute('data-panel');
          showPanel(panel);
        });
      });

      // Start button
      $('btnStart').addEventListener('click', () => showPanel('form'));

      // Form event listeners
      $('cust_monthly_income').addEventListener('input', calculateYearlyIncome);
      $('cust_has_children').addEventListener('change', toggleChildrenSection);
      $('cust_has_dependents').addEventListener('change', toggleDependentsSection);
      $('cust_occupation').addEventListener('change', toggleBusinessSection);
      $('btnClear').addEventListener('click', clearForm);
      $('btnSave').addEventListener('click', saveCustomer);
      $('btnAnalyze').addEventListener('click', performAnalysis);

      // RH and Zone management
      $('rh').addEventListener('change', updateZones);

      // Unknown checkbox handlers
      setupUnknownCheckboxes();
    }

    function simulateLoading() {
      let progress = 0;
      const progressBar = $('loadingProgress');
      
      const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          setTimeout(() => {
            $('loadingScreen').style.opacity = '0';
            setTimeout(() => {
              $('loadingScreen').style.display = 'none';
              $('appContainer').style.display = 'flex';
            }, 600);
          }, 500);
        }
        progressBar.style.width = `${progress}%`;
      }, 200);
    }

    function showPanel(panelName) {
      // Update tabs
      document.querySelectorAll('.ios-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`.ios-tab[data-panel="${panelName}"]`).classList.add('active');

      // Update panels - hide all first
      document.querySelectorAll('.content-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      
      // Show the selected panel
      $(`panel-${panelName}`).classList.add('active');
      
      currentPanel = panelName;
    }

    function calculateYearlyIncome() {
      const monthlyIncome = parseFloat($('cust_monthly_income').value) || 0;
      const yearlyIncome = monthlyIncome * 12;
      $('cust_yearly_income').value = yearlyIncome.toLocaleString();
    }

    function toggleChildrenSection() {
      const hasChildren = $('cust_has_children').value === 'มี';
      $('children-section').style.display = hasChildren ? 'block' : 'none';
    }

    function toggleDependentsSection() {
      const hasDependents = $('cust_has_dependents').value === 'มี';
      $('dependents-section').style.display = hasDependents ? 'block' : 'none';
    }

    function toggleBusinessSection() {
      const isBusinessOwner = $('cust_occupation').value === 'เจ้าของกิจการ/ธุรกิจส่วนตัว';
      $('business-section').style.display = isBusinessOwner ? 'block' : 'none';
    }

    function updateZones() {
      const rh = $('rh').value;
      const zoneSelect = $('zone');
      
      zoneSelect.innerHTML = '<option value="">เลือก Zone</option>';
      
      if (rh) {
        const zones = {
          'RH1': ['จตุจักร', 'ธนบุรี', 'บางกะปิ', 'สาทร', 'สุขุมวิท'],
          'RH2': ['ชลบุรี', 'บางนา', 'พัทยา', 'ระยอง'],
          'RH3': ['เชียงใหม่', 'นครสวรรค์', 'นนทบุรี', 'พิษณุโลก', 'อยุธยา'],
          'RH4': ['ดอนเมือง', 'นครราชสีมา', 'สระบุรี', 'อุดรธานี', 'อุบลราชธานี'],
          'RH5': ['ภูเก็ต', 'ราชบุรี', 'สมุทรสาคร', 'สุราษฎร์ธานี', 'หาดใหญ่']
        };
        
        zones[rh].forEach(zone => {
          zoneSelect.innerHTML += `<option value="${zone}">Zone ${zone}</option>`;
        });
        zoneSelect.disabled = false;
      } else {
        zoneSelect.disabled = true;
      }
    }

    function setupUnknownCheckboxes() {
      // Setup unknown checkbox functionality
      const unknownCheckboxes = document.querySelectorAll('.unknown-checkbox input[type="checkbox"]');
      unknownCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const targetId = this.id.replace('_unknown', '');
          const targetElement = $(targetId);
          if (targetElement) {
            targetElement.disabled = this.checked;
            if (this.checked) {
              targetElement.value = '';
            }
          }
        });
      });
    }

    function clearForm() {
      document.querySelectorAll('.ios-input, .ios-select').forEach(input => {
        input.value = '';
        input.disabled = false;
      });
      
      // Reset checkboxes
      document.querySelectorAll('.unknown-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Hide sections
      $('children-section').style.display = 'none';
      $('dependents-section').style.display = 'none';
      $('business-section').style.display = 'none';
      $('analysisResults').style.display = 'none';
      $('customerIdDisplay').style.display = 'none';
      $('formStatus').style.display = 'none';
      
      // Reset zones
      $('zone').innerHTML = '<option value="">เลือก RH ก่อน</option>';
      $('zone').disabled = true;
      
      calculateYearlyIncome();
      currentCustomerId = '';
    }

    // Customer Code Generation
    function genCustomerCode(rh) {
      const now = new Date();
      const rhNumber = rh.replace('RH', '');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = String(now.getFullYear()).slice(-2);
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      
      return `R${rhNumber}-${month}${year}${hours}${minutes}`;
    }

    function validateForm() {
      const required = [
        ['employee_name', 'กรอกชื่อผู้กรอก'],
        ['employee_id', 'กรอก Employee ID'],
        ['rh', 'เลือก RH'],
        ['zone', 'เลือก Zone'],
        ['cust_name', 'กรอกชื่อนามสมมุติ'],
        ['cust_age', 'กรอกอายุ'],
        ['cust_gender', 'เลือกเพศ'],
        ['cust_occupation', 'เลือกอาชีพ'],
        ['cust_monthly_income', 'กรอกรายได้ต่อเดือน']
      ];

      for (let [id, msg] of required) {
        const el = $(id);
        if (!el) continue;
        
        // Check if "unknown" checkbox is checked
        const unknownCheckbox = $(`${id}_unknown`);
        if (unknownCheckbox && unknownCheckbox.checked) {
          continue;
        }
        
        if (!el.value || el.value.trim() === '') {
          alert(msg);
          el.focus();
          return false;
        }
      }
      return true;
    }

    async function saveCustomer() {
      if (!validateForm()) return;

      const createdBy = $('employee_id').value.trim();
      const rh = $('rh').value.trim();

      // Generate customer ID
      currentCustomerId = genCustomerCode(rh);
      
      const customer = {
        customer_id: currentCustomerId,
        name: $('cust_name').value.trim(),
        age: parseInt($('cust_age').value) || 0,
        gender: $('cust_gender').value,
        occupation: $('cust_occupation').value,
        monthly_income: parseFloat($('cust_monthly_income').value) || 0,
        yearly_income: parseFloat($('cust_monthly_income').value) * 12 || 0,
        welfare: $('cust_welfare').value,
        insurance_capital: parseFloat($('cust_insurance_capital').value) || 0,
        marital_status: $('cust_marital_status').value,
        spouse_age: parseInt($('cust_spouse_age').value) || 0,
        spouse_occupation: $('cust_spouse_occupation').value,
        has_children: $('cust_has_children').value,
        children_count: parseInt($('cust_children_count').value) || 0,
        children_ages: $('cust_children_ages').value,
        children_occupation: $('cust_children_occupation').value,
        has_dependents: $('cust_has_dependents').value,
        dependents_details: $('cust_dependents_details').value,
        business_type: $('cust_business_type').value,
        business_capital: parseFloat($('cust_business_capital').value) || 0,
        business_income: parseFloat($('cust_business_income').value) || 0,
        business_profit: parseFloat($('cust_business_profit').value) || 0,
        business_tax: parseFloat($('cust_business_tax').value) || 0,
        business_share: parseFloat($('cust_business_share').value) || 0,
        financial_products: {
          savings: parseFloat($('prod_savings').value) || 0,
          fixed: parseFloat($('prod_fixed').value) || 0,
          fund: parseFloat($('prod_fund').value) || 0,
          credit_card: parseFloat($('prod_credit_card').value) || 0,
          home_loan: parseFloat($('prod_home_loan').value) || 0,
          car_loan: parseFloat($('prod_car_loan').value) || 0,
          personal_loan: parseFloat($('prod_personal_loan').value) || 0
        },
        employee_comments: {
          additional_comments: $('emp_additional_comments').value,
          presented_before: $('emp_presented_before').value,
          customer_feedback: $('emp_customer_feedback').value,
          proposed_product: $('emp_proposed_product').value,
          proposed_premium: parseFloat($('emp_proposed_premium').value) || 0,
          proposed_capital: parseFloat($('emp_proposed_capital').value) || 0
        },
        branch: $('zone').value,
        zone: $('zone').value,
        rh: rh,
        created_by: createdBy,
        created_by_name: $('employee_name').value.trim(),
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };

      try {
        // Save to localStorage
        const all = await loadData();
        all.unshift(customer);
        await saveData(all);
        
        // Show customer ID
        $('customerIdDisplay').textContent = `Customer ID: ${customer.customer_id}`;
        $('customerIdDisplay').style.display = 'block';
        
        // Show success message
        $('formStatus').textContent = `บันทึกข้อมูลลูกค้า ${customer.customer_id} เรียบร้อยแล้ว`;
        $('formStatus').style.display = 'block';
        $('formStatus').style.background = 'var(--green)';
        
      } catch(error) {
        console.error('Error saving customer:', error);
        $('formStatus').textContent = 'เกิดข้อผิดพลาดในการบันทึกข้อมูล';
        $('formStatus').style.display = 'block';
        $('formStatus').style.background = 'var(--red)';
      }
    }

    // Data management functions
    async function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch(e) { 
        return [];
      }
    }

    async function saveData(arr) { 
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    // AI Analysis Functions
    async function performAnalysis() {
      const customerData = collectCustomerData();
      
      // Basic validation
      if (!validateForm()) {
        return;
      }
      
      showAnalysisLoading();
      
      try {
        const results = await integratedAdvisor.analyzeCustomer(customerData);
        displayAnalysisResults(results);
        autoFillRecommendations(results.recommendations);
      } catch (error) {
        showAnalysisError(error);
      }
    }

    function collectCustomerData() {
      return {
        age: parseInt($('cust_age').value) || 0,
        gender: $('cust_gender').value,
        monthly_income: parseFloat($('cust_monthly_income').value) || 0,
        occupation: $('cust_occupation').value,
        marital_status: $('cust_marital_status').value,
        has_children: $('cust_has_children').value,
        children_count: parseInt($('cust_children_count').value) || 0,
        children_ages: $('cust_children_ages').value
      };
    }

    function showAnalysisLoading() {
      $('analysisResults').style.display = 'block';
      $('recommendationList').innerHTML = `
        <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
          <div class="spinner-border" style="color: var(--primary); margin-bottom: 16px;"></div>
          <p>กำลังวิเคราะห์ข้อมูลด้วย AI...</p>
        </div>
      `;
    }

    function displayAnalysisResults(results) {
      const container = $('recommendationList');
      container.innerHTML = '';

      if (results.recommendations.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px;"></i>
            <p>ไม่พบผลิตภัณฑ์ที่เหมาะสมในขณะนี้</p>
          </div>
        `;
        return;
      }

      results.recommendations.forEach(rec => {
        const card = document.createElement('div');
        card.className = 'recommendation-card';
        card.innerHTML = `
          <div class="recommendation-header">
            <div>
              <div class="recommendation-title">${rec.product}</div>
            </div>
            <div class="recommendation-badge">${rec.score}%</div>
          </div>
          <div class="recommendation-details">
            <div class="detail-item">
              <div class="detail-label">ทุนแนะนำ</div>
              <div class="detail-value">${rec.capital.toLocaleString()} บาท</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">เบี้ยประกัน</div>
              <div class="detail-value">${rec.premium.toLocaleString()} บาท/ปี</div>
            </div>
          </div>
          <div class="recommendation-reason">${rec.reason}</div>
        `;
        container.appendChild(card);
      });

      // Scroll to results
      $('analysisResults').scrollIntoView({ behavior: 'smooth' });
    }

    function showAnalysisError(error) {
      $('recommendationList').innerHTML = `
        <div style="text-align: center; padding: 40px 20px; color: var(--red);">
          <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
          <p>เกิดข้อผิดพลาดในการวิเคราะห์</p>
          <small>${error.message}</small>
        </div>
      `;
    }

    function autoFillRecommendations(recommendations) {
      if (recommendations.length > 0) {
        const topProduct = recommendations[0];
        $('emp_proposed_product').value = recommendations.map(r => r.product).join(', ');
        $('emp_proposed_premium').value = topProduct.premium;
        $('emp_proposed_capital').value = topProduct.capital;
        
        // Auto-fill comments
        const comment = `ระบบแนะนำ: ${recommendations.map(r => r.product).join(', ')} - ${topProduct.reason}`;
        $('emp_additional_comments').value = comment;
      }
    }
  </script>
</body>
</html>
